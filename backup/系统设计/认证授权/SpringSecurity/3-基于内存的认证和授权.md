# âŒ¨ åŸºäºå†…å­˜çš„è®¤è¯å’Œæˆæƒ

---

## 1. åŸºäºå†…å­˜çš„è®¤è¯ä¿¡æ¯

ä¸ŠèŠ‚æˆ‘ä»¬ç®€å•ä½“éªŒäº†ä¸‹Spring Securityï¼Œä½†æ˜¯ç°åœ¨åªèƒ½æœ‰ä¸€ä¸ªç”¨æˆ·ä¿¡æ¯ï¼Œæˆ‘ä»¬è¿™é‡Œå¸Œæœ›å¯ä»¥é…ç½®å¤šä¸ªè´¦å·ä¿¡æ¯ï¼Œæœ¬èŠ‚ä¸»è¦è®²è§£ä¸‹å¦‚ä½•åœ¨å†…å­˜ä¸­é…ç½®è®¤è¯ä¿¡æ¯ã€‚

### â‘  åˆ›å»ºé…ç½®ç±»

å®šä¹‰ä¸€ä¸ªé…ç½®ç±» `WebSecurityConfig`ï¼Œç»§æ‰¿ `WebSecurityConfigurerAdapter`ï¼Œå¦‚ä¸‹ä»£ç ï¼š

```java
@Configuration
@EnableWebSecurity // å¼€å¯Spring Securityçš„åŠŸèƒ½
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    // è®¤è¯
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        /*
         * é…ç½®ä¸ºä»å†…å­˜ä¸­è¿›è¡ŒåŠ è½½è®¤è¯ä¿¡æ¯.
         * è¿™é‡Œé…ç½®äº†ä¸¤ä¸ªç”¨æˆ· adminå’Œuser
         */
        auth.inMemoryAuthentication().withUser("admin").password("123456").roles();
        auth.inMemoryAuthentication().withUser("user").password("123456").roles();
    }
}
```

ğŸš¨ å¦‚æœæ˜¯ 5.x ä¹‹å‰çš„ç‰ˆæœ¬çš„è¯ï¼Œé‚£ä¹ˆåˆ°è¿™é‡Œå¯åŠ¨çš„è¯ï¼Œå°±å¯ä»¥æ­£å¸¸è®¿é—®äº†ï¼Œä½†æ˜¯å¦‚æœæ˜¯ 5.x çš„ç‰ˆæœ¬çš„è¯ï¼Œå¯ä»¥æ­£å¸¸å¯åŠ¨ï¼Œä½†æ˜¯åœ¨ç™»å½•é¡µé¢è¾“å…¥è´¦å·è¿›è¡Œè®¿é—®çš„è¯ï¼Œä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š

`java.lang.IllegalArgumentException:There is no PasswordEncoder mapped for the id "null"`

<img src="https://gitee.com/veal98/images/raw/master/img/20200805173959.png" style="zoom:80%;" />

è¿™æ˜¯å› ä¸º Spring Security 5.0ä¸­æ–°å¢äº†å¤šç§åŠ å¯†æ–¹å¼ï¼Œä¹Ÿæ”¹å˜äº†å¯†ç çš„æ ¼å¼ã€‚æˆ‘ä»¬éœ€è¦æŒ‡å®šåŠ å¯†æ–¹å¼ ğŸ‘‡

### â‘¡ å¯†ç åŠ å¯†

#### â…  æ–¹å¼ 1ï¼šé€šè¿‡AuthenticationManagerBuilderæŒ‡å®š

 åœ¨ `AuthenticationManagerBuilder `çš„æ–¹æ³•ä¸­å°±å¯ä»¥æŒ‡å®šåŠ å¯†æ–¹å¼äº†ï¼Œå¦‚ä¸‹ä»£ç ï¼š

```java
auth.inMemoryAuthentication()
    .passwordEncoder(new BCryptPasswordEncoder())
    .withUser("admin")
    .password(new BCryptPasswordEncoder().encode("123456"))
    .roles();

auth.inMemoryAuthentication()
    .passwordEncoder(new BCryptPasswordEncoder())
    .withUser("user")
    .password(new BCryptPasswordEncoder().encode("123456"))
    .roles();
```

> **Bcrypt**ï¼š bcryptæ˜¯ä¸€ç§è·¨å¹³å°çš„æ–‡ä»¶åŠ å¯†å·¥å…·ã€‚bcrypt ä½¿ç”¨çš„æ˜¯å¸ƒé²æ–¯Â·æ–½å†…å°”åœ¨1993å¹´å‘å¸ƒçš„ Blowfish åŠ å¯†ç®—æ³•ã€‚ç”±å®ƒåŠ å¯†çš„æ–‡ä»¶å¯åœ¨æ‰€æœ‰æ”¯æŒçš„æ“ä½œç³»ç»Ÿå’Œå¤„ç†å™¨ä¸Šè¿›è¡Œè½¬ç§»ã€‚å®ƒçš„å£ä»¤å¿…é¡»æ˜¯8è‡³56ä¸ªå­—ç¬¦ï¼Œå¹¶å°†åœ¨å†…éƒ¨è¢«è½¬åŒ–ä¸º448ä½çš„å¯†é’¥ã€‚

#### â…¡ æ–¹å¼ 2ï¼šé€šè¿‡@Beanæ³¨å…¥æŒ‡å®šPasswordEncoder

 åœ¨ `WebSecurityConfig` é…ç½®ç±»ä¸­ï¼Œé€šè¿‡ `@Bean` æ³¨å…¥ `PasswordEncoder `å…·ä½“çš„å®ç°ç±»ï¼Œå¦‚ä¸‹ä»£ç ï¼š

```java
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}
```

åŠ å…¥è¿™ä¸ªä¹‹åï¼Œéœ€è¦ä¿®æ”¹å¯†ç åŠ å¯†ï¼š

```java
@Override
protected void configure(AuthenticationManagerBuilder auth) throws Exception {

        /*
         * é…ç½®ä¸ºä»å†…å­˜ä¸­è¿›è¡ŒåŠ è½½è®¤è¯ä¿¡æ¯.
         * è¿™é‡Œé…ç½®äº†ä¸¤ä¸ªç”¨æˆ· adminå’Œuser
         */
        auth.inMemoryAuthentication()
            .withUser("admin")
            .password(passwordEncoder().encode("123456"))
            .roles();

        auth.inMemoryAuthentication()
            .withUser("user")
            .password(passwordEncoder().encode("123456"))
            .roles();
}

@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}
```

å¯¹äºä¸Šé¢çš„ä¸¤ç§æ–¹å¼ï¼Œæ¨èä½¿ç”¨ç¬¬äºŒç§æ–¹å¼ï¼Œè¿™ç§æ–¹å¼ä¸€æ–¹é¢æ›´å®¹æ˜“ç†è§£ï¼Œå¦å¤–ä»£ç æ‰©å±•æ€§æ›´å¼ºã€‚

## 2. åŸºäºå†…å­˜çš„ç”¨æˆ·æˆæƒ

ä¸Šé¢æˆ‘ä»¬åŸºäºå†…å­˜çš„æ–¹å¼ï¼Œæ„å»ºäº†ä¸¤ä¸ªè´¦å· admin å’Œ userï¼Œå¯¹äºè¿™ä¸¤ä¸ªè´¦å·åœ¨å®é™…é¡¹ç›®ä¸­ä¼šæœ‰ä¸åŒçš„è§’è‰²ï¼Œæ¯”å¦‚ç®¡ç†å‘˜è§’è‰²å’Œæ™®é€šç”¨æˆ·è§’è‰²ï¼Œå¯¹äºä¸åŒçš„è§’è‰²ï¼Œé‚£ä¹ˆå…è®¸è®¿é—®çš„æ–¹æ³•ä¼šä¸ä¸€æ ·ã€‚

### â‘  ä¸ºç”¨æˆ·é…ç½®è§’è‰²

é€šè¿‡ `AuthenticationManagerBuilder` çš„ `roles()` æ–¹æ³•åˆ†é…è§’è‰²ï¼š

```java
@Override
protected void configure(AuthenticationManagerBuilder auth) throws Exception {

    /*
     * é…ç½®ä¸ºä»å†…å­˜ä¸­è¿›è¡ŒåŠ è½½è®¤è¯ä¿¡æ¯.
     * è¿™é‡Œé…ç½®äº†ä¸¤ä¸ªç”¨æˆ· adminå’Œuser
     */
    auth.inMemoryAuthentication()
        .withUser("admin")
        .password(passwordEncoder().encode("123456"))
        .roles("admin");

    auth.inMemoryAuthentication()
        .withUser("user")
        .password(passwordEncoder().encode("123456"))
        .roles("normal");
}
```

### â‘¡ å¼€å¯ Spring æ–¹æ³•çº§å®‰å…¨

æƒ³è¦å¼€å¯ Spring æ–¹æ³•çº§å®‰å…¨ï¼Œä½ éœ€è¦åœ¨å·²ç»æ·»åŠ äº† `@Configuration` æ³¨è§£çš„ç±»ä¸Šå†æ·»åŠ  `@EnableGlobalMethodSecurity` æ³¨è§£ï¼š

```java
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled=true)
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
}
```

- `prePostEnabled` :å†³å®š Spring Security çš„å‰æ³¨è§£æ˜¯å¦å¯ç”¨ [`@PreAuthorize`,`@PostAuthorize`,..]

  å³åªæœ‰æ·»åŠ äº†`@EnableGlobalMethodSecurity(prePostEnabled=true)` ä¹‹åï¼Œ`@PreAuthorize("hasAnyRole('admin')")` æ‰èƒ½ç”Ÿæ•ˆã€‚

- `secureEnabled `: å†³å®šæ˜¯å¦ Spring Security çš„ä¿éšœæ³¨è§£ [`@Secured`] æ˜¯å¦å¯ç”¨ã€‚

- `jsr250Enabled `ï¼šå†³å®š JSR-250 annotations æ³¨è§£[`@RolesAllowed`..] æ˜¯å¦å¯ç”¨ã€‚

### â‘¢ é…ç½®æ–¹æ³•çº§æ‹¥æœ‰çš„è§’è‰²

æˆ‘ä»¬åœ¨ `HelloController `æ·»åŠ ä¸¤ä¸ªæ–¹æ³•ï¼Œä½¿ç”¨æ³¨è§£ `@PreAuthorize` æŒ‡å®šè®¿é—®è¯¥æ–¹æ³•éœ€è¦çš„è§’è‰²ï¼š

```java
@RestController
public class HelloController {

    @RequestMapping("/hello")
    public String hello() {
        return "Hello,Spring Security";
    }

    @RequestMapping("/helloAdmin")
    @PreAuthorize("hasAnyRole('admin')") // åªå…è®¸è§’è‰² admin è®¿é—®
    public String helloAdmin() {
        return "Hello,admin";
    }

    @RequestMapping("/helloUser")
    @PreAuthorize("hasAnyRole('admin','normal')") // å…è®¸è§’è‰² admin å’Œ normal è®¿é—®
    public String helloUser() {
        return "Hello,user";
    }
}
```

### â‘£ æµ‹è¯•

è®¿é—®å¦‚ä¸‹åœ°å€ï¼š[http://127.0.0.1:8080/helloUser](http://127.0.0.1:8080/helloUser)ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œè¾“å…¥è´¦å· user/123456ï¼ŒæˆåŠŸç™»å½•ä¹‹åï¼Œä¼šçœ‹åˆ°è¿”å›ä¿¡æ¯ï¼šHello,user

ç„¶ååœ¨è¾“å…¥å¦å¤–ä¸€ä¸ªåœ°å€ï¼š[http://127.0.0.1:8080/helloAdmin](http://127.0.0.1:8080/helloAdmin)ï¼Œè¿™æ—¶å€™ä¼šçœ‹åˆ°403çš„æŠ¥é”™ï¼Œå› ä¸ºè¯¥ç”¨æˆ·æ²¡æœ‰æƒé™è®¿é—®è¯¥æ–¹æ³•

é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œè¾“å…¥ admin/123456 è´¦å·è¿›è¡Œæµ‹è¯•ï¼Œéƒ½èƒ½æ­£å¸¸è®¿é—®ã€‚

## ğŸ“š References

- [æ—ç¥¥çº¤ - Spring Boot+Spring Security ç³»åˆ—](https://www.iteye.com/blog/412887952-qq-com-2441544)