# ğŸ“¤ è‡ªå®šä¹‰ç™»å½•é¡µé¢å’Œæ„å»ºä¸»é¡µ

---

## 1. æ·»åŠ æ¨¡æ¿å¼•æ“ä¾èµ–

è¿™é‡Œä½¿ç”¨äº† thymeleaf æ¨¡æ¿å¼•æ“ï¼Œåœ¨ `pom.xml` è¿›è¡Œæ·»åŠ ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-thymeleaf</artifactId>
</dependency>
```

## 2. è‡ªå®šä¹‰ç™»å½•ç•Œé¢

### â‘  é…ç½® Spring Security çš„ç™»å½•é¡µé¢è·¯å¾„

åœ¨ `WebSecurityConfig `å¤å†™ `configure(HttpSecurityhttp)` æ–¹æ³•ï¼Œè®¾å®šç™»å½•é¡µé¢çš„è·¯å¾„ï¼Œå¦‚ä¸‹ç¤ºä¾‹ä»£ç ï¼š

```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    http.authorizeRequests() // å®šä¹‰å“ªäº›URLéœ€è¦è¢«ä¿æŠ¤ã€å“ªäº›ä¸éœ€è¦è¢«ä¿æŠ¤
            .antMatchers("/login").permitAll()// è®¾ç½®æ‰€æœ‰äººéƒ½å¯ä»¥è®¿é—®è·¯å¾„/login
            .anyRequest().authenticated()  // ä»»ä½•è¯·æ±‚,ç™»å½•åå¯ä»¥è®¿é—®
            .and()
            .formLogin().loginPage("/login") // è®¾ç½®è‡ªå®šä¹‰ç™»å½•ç•Œé¢è·¯å¾„ /loginï¼ˆä¸Controllerä¸­ä¸€è‡´ï¼‰
            ;
}
```

è®¾ç½® `loginPage` åï¼Œé¡¹ç›®å¯åŠ¨å°±ä¼šè‡ªåŠ¨è¿›å…¥è¯¥è·¯å¾„ï¼Œæ¯”å¦‚å¦‚æœè®¾ç½®çš„æ˜¯ `loginPage("/test")`ï¼Œé¡¹ç›®å¯åŠ¨åä¼šè‡ªåŠ¨è¿›å…¥ `http://localhost:8080/test` è·¯å¾„ï¼Œè°ƒç”¨è·¯å¾„`/test` å¯¹åº”çš„ Controller è¿›è¡Œå¤„ç†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šåœ¨ Controller ä¸­å°†å…¶è·³è½¬è‡³ç™»å½•çš„å‰ç«¯ç•Œé¢ï¼Œè§ä¸‹æ–‡

### â‘¡  ç¼–å†™ç™»å½•é¡µé¢çš„ html æ–‡ä»¶

 åœ¨ `resources/templates `æ–‡ä»¶å¤¹ä¸‹ç¼–å†™ `login.html` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```html
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
    <head>
        <title>Spring Security Login </title>
    </head>
    <body>
        // ä¸ controller ä¸­ä¸€è‡´
        <form th:action="@{/login}" method="post">
            <div><label> ç”¨æˆ·å : <input type="text" name="username"/> </label></div>
            <div><label> å¯†ç : <input type="password" name="password"/> </label></div>
            <div><input type="submit" value="ç™»å½•"/></div>
        </form>
    </body>
</html>
```

### â‘¢ ç¼–å†™ç™»å½•é¡µé¢è¯·æ±‚æ˜ å°„

åˆ›å»ºä¸€ä¸ª `HomeController `ç±»ï¼Œè¯·æ±‚æ˜ å°„ `/login` è·¯å¾„ï¼ˆä¸ `WebSecurityConfig ` ä¸­çš„ `loginPage `å¯¹åº”ï¼‰ï¼Œå¦‚ä¸‹ç¤ºä¾‹ä»£ç ï¼š

```java
@Controller
public class HomeController {

    @GetMapping("/login")
    public String login() {
        return "login"; // è·³è½¬ login.html
    }
}
```

### â‘£ æµ‹è¯•

 å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œè‡ªåŠ¨è·³è½¬åˆ° `http://localhost:8080/login`,å·²ç»æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ç™»å½•ç•Œé¢äº†ï¼š

![](https://gitee.com/veal98/images/raw/master/img/20200809213704.png)

ä¸è¿‡ç™»å½•æˆåŠŸåä»ç„¶åœ¨è¯¥ç™»å½•ç•Œé¢ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å®šä¹‰ç™»å½•æˆåŠŸåè·³è½¬çš„ä¸»é¡µã€‚ğŸ‘‡

## 3. æ„å»ºä¸»é¡µ

### â‘   ç¼–å†™ä¸»é¡µçš„ html æ–‡ä»¶

 ç¼–å†™ç™»å½•é¡µé¢ `index.html`ï¼Œå¦‚ä¸‹ç¤ºä¾‹ä»£ç ï¼š

```html
<!DOCTYPE html>  
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">  
    <head>
        <title>Spring Securityå…¥é—¨</title>
    </head>
    <body>
        <h1>æ¬¢è¿ä½¿ç”¨Spring Security!</h1>
        <p>ç‚¹å‡» <a th:href="@{/hello}">è¿™é‡Œ</a> æ‰“ä¸ªæ‹›å‘¼å§</p>

        <p> <a th:href="@{/helloAdmin}">admin page</a></p>
        <p><a th:href="@{/helloUser}">user page</a></p>

    </body>
</html>
```

### â‘¡  ç¼–å†™ä¸»é¡µé¡µé¢è¯·æ±‚æ˜ å°„

åœ¨ `HomeController `ä¸­æ·»åŠ  `index `æ˜ å°„æ–¹æ³•ï¼š

```java
@GetMapping({"","/","/index"})
public String index() {
    return "index";
}
```

### â‘¢ æµ‹è¯•

**ç™»å½•æˆåŠŸåé»˜è®¤è·³è½¬åˆ° `http://localhost:8080/` è·¯å¾„**ï¼Œå¦‚ä¸‹ï¼š

![](https://gitee.com/veal98/images/raw/master/img/20200809213414.png)

## 4. é¡µé¢ç™½åå•

åœ¨æœ‰äº›åœºæ™¯ä¸‹æˆ‘ä»¬è¦å¯¹ä¸€äº›è·¯å¾„æˆ–è€…æ–‡ä»¶è®¾ç½®ç™½åå•ï¼Œå³å…è®¸æ‰€æœ‰äººè®¿é—®ï¼Œæ¯”å¦‚æ³¨å†Œé¡µé¢ï¼Œå¿˜è®°å¯†ç ç­‰ï¼Œå…¶å®ä¸Šé¢æˆ‘ä»¬å·²ç»ä½¿ç”¨è¿‡äº†ï¼Œä¸‹é¢å¯¹è®¾ç½®çš„ç™½åå•ç±»å‹åšä¸€ä¸ªæ€»ç»“ ğŸ‘‡

### â‘  url

```java
http.authorizeRequests() // å®šä¹‰å“ªäº›URLéœ€è¦è¢«ä¿æŠ¤ã€å“ªäº›ä¸éœ€è¦è¢«ä¿æŠ¤
    .antMatchers("/login").permitAll() // å…è®¸æ‰€æœ‰äººè®¿é—® /login è·¯å¾„
	.antMatchers("/","/index").permitAll() //  å…è®¸æ‰€æœ‰äººè®¿é—® /, /index è·¯å¾„
```

### â‘¡ ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶

æ¯”å¦‚è®¾ç½®æ‰€æœ‰` /test/` ä¸‹çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¸ºç™½åå•ï¼š

```Java
http.authorizeRequests() 
            .antMatchers("/test/**","/test1/**").permitAll()
```

### â‘¢ ç›®å½•ä¸‹æŒ‡å®šç±»å‹æ–‡ä»¶

æ¯”å¦‚è¦æŠŠ` /res/ `çš„æ‰€æœ‰ `.js`,`html` è®¾ç½®ä¸ºç™½åå•ï¼š

```java
http.authorizeRequests() 
            .antMatchers("/res/**/*.{js,html}").permitAll()
```

## 5. å›æ˜¾ç™»å½•ä¿¡æ¯

### â‘  è·å–å½“å‰çš„è´¦å·ä¿¡æ¯

ä¸»è¦æ˜¯é€šè¿‡ `SecurityContextHolder `è·å–åˆ°ä¸Šä¸‹æ–‡ `SecurityContext`ï¼Œé€šè¿‡ `SecurityContext` è·å–åˆ°æƒé™ä¿¡æ¯ `Authentication`ï¼Œæœ€åé€šè¿‡ `Authentication` è·å–åˆ°å½“å‰çš„ç™»å½•ä¿¡æ¯ï¼š

```java
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.User; // æ³¨æ„åˆ«å¯¼é”™åŒ…

......

@GetMapping({"","/","/index"})
public String index(Model model) {
    Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
    if("anonymousUser".equals(principal)){
        model.addAttribute("name","anonymous");
    }else{
        User user = (User) principal;
        model.addAttribute("name",user.getUsername());
    }
    return "index";
}
```

### â‘¡ åœ¨é¦–é¡µæ˜¾ç¤ºå½“å‰è´¦å·ä¿¡æ¯

ä¿®æ”¹ `index.html`ï¼Œæ˜¾ç¤º `name`ï¼š

```html
<h1>æ¬¢è¿ä½¿ç”¨Spring Security! 
    <label th:text = "${name}"></label> 
</h1>
```

ğŸƒâ€ è®¿é—®æ•ˆæœå¦‚ä¸‹ï¼š

<img src="https://gitee.com/veal98/images/raw/master/img/20200812120051.png" style="zoom:90%;" />

## ğŸ“š References

- [æ—ç¥¥çº¤ - Spring Boot+Spring Security ç³»åˆ—](https://www.iteye.com/blog/412887952-qq-com-2441544)