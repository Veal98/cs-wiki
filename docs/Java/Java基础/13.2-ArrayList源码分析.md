# â­ ArrayList æºç åˆ†æ

---

`ArrayList `çš„åº•å±‚æ˜¯**æ•°ç»„é˜Ÿåˆ—**ï¼Œç›¸å½“äºåŠ¨æ€æ•°ç»„ã€‚ä¸ Java ä¸­çš„æ•°ç»„ç›¸æ¯”ï¼Œå®ƒçš„å®¹é‡èƒ½åŠ¨æ€å¢é•¿ã€‚

- `ArrayList `ç»§æ‰¿äº† `AbstractList`ï¼Œå®ç°äº†Listã€‚å®ƒæ˜¯ä¸€ä¸ªæ•°ç»„é˜Ÿåˆ—ï¼Œæä¾›äº†ç›¸å…³çš„æ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹ã€éå†ç­‰åŠŸèƒ½ã€‚

- `ArrayList `å®ç°äº† `RandomAccess `æ¥å£ï¼Œ `RandomAccess `æ˜¯ä¸€ä¸ªæ ‡å¿—æ¥å£ï¼Œè¡¨æ˜å®ç°è¿™ä¸ªè¿™ä¸ªæ¥å£çš„ `List `é›†åˆæ˜¯æ”¯æŒå¿«é€Ÿéšæœºè®¿é—®çš„ã€‚åœ¨ `ArrayList `ä¸­ï¼Œæˆ‘ä»¬å³å¯ä»¥é€šè¿‡å…ƒç´ çš„åºå·å¿«é€Ÿè·å–å…ƒç´ å¯¹è±¡ï¼Œè¿™å°±æ˜¯å¿«é€Ÿéšæœºè®¿é—®ã€‚

- `ArrayList `å®ç°äº†`Cloneable `æ¥å£ï¼Œå³è¦†ç›–äº†å‡½æ•° `clone()`ï¼Œèƒ½è¢«å…‹éš†ã€‚

- `ArrayList` å®ç°` java.io.Serializable` æ¥å£ï¼Œè¿™æ„å‘³ç€ `ArrayList` æ”¯æŒåºåˆ—åŒ–ï¼Œèƒ½é€šè¿‡åºåˆ—åŒ–å»ä¼ è¾“ã€‚

å’Œ `Vector `ä¸åŒï¼Œ**`ArrayList `ä¸­çš„æ“ä½œä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„**ï¼æ‰€ä»¥ï¼Œå»ºè®®åœ¨å•çº¿ç¨‹ä¸­æ‰ä½¿ç”¨ `ArrayList`ï¼Œè€Œåœ¨å¤šçº¿ç¨‹ä¸­å¯ä»¥é€‰æ‹© `Vector `æˆ–è€… `CopyOnWriteArrayList`ã€‚

âœ ä¸‹é¢æ˜¯`ArrayList` æ ¸å¿ƒæºç çš„è¯¦ç»†è§£è¯»ï¼š

```java
package java.util;

import java.util.function.Consumer;
import java.util.function.Predicate;
import java.util.function.UnaryOperator;


public class ArrayList<E> extends AbstractList<E>
        implements List<E>, RandomAccess, Cloneable, java.io.Serializable
{
    private static final long serialVersionUID = 8683452581122892189L;

    /**
     * é»˜è®¤åˆå§‹å®¹é‡å¤§å°
     */
    private static final int DEFAULT_CAPACITY = 10;

    /**
     * ç©ºæ•°ç»„ï¼ˆç”¨äºç©ºå®ä¾‹ï¼‰ã€‚
     */
    private static final Object[] EMPTY_ELEMENTDATA = {};

     //ç”¨äºé»˜è®¤å¤§å°ç©ºå®ä¾‹çš„å…±äº«ç©ºæ•°ç»„å®ä¾‹ã€‚
      //æˆ‘ä»¬æŠŠå®ƒä»EMPTY_ELEMENTDATAæ•°ç»„ä¸­åŒºåˆ†å‡ºæ¥ï¼Œä»¥çŸ¥é“åœ¨æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶å®¹é‡éœ€è¦å¢åŠ å¤šå°‘ã€‚
    private static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = {};

    /**
     * ä¿å­˜ArrayListæ•°æ®çš„æ•°ç»„
     */
    transient Object[] elementData; // non-private to simplify nested class access

    /**
     * ArrayList æ‰€åŒ…å«çš„å…ƒç´ ä¸ªæ•°
     */
    private int size;

```

## 1. æ„é€ å‡½æ•°

```java
 	/**
     * å¸¦åˆå§‹å®¹é‡å‚æ•°çš„æ„é€ å‡½æ•°ï¼ˆç”¨æˆ·å¯ä»¥åœ¨åˆ›å»ºArrayListå¯¹è±¡æ—¶è‡ªå·±æŒ‡å®šé›†åˆçš„åˆå§‹å¤§å°ï¼‰
     */
    public ArrayList(int initialCapacity) {
        if (initialCapacity > 0) {
            //å¦‚æœä¼ å…¥çš„å‚æ•°å¤§äº0ï¼Œåˆ›å»ºinitialCapacityå¤§å°çš„æ•°ç»„
            this.elementData = new Object[initialCapacity];
        } else if (initialCapacity == 0) {
            //å¦‚æœä¼ å…¥çš„å‚æ•°ç­‰äº0ï¼Œåˆ›å»ºç©ºæ•°ç»„
            this.elementData = EMPTY_ELEMENTDATA;
        } else {
            //å…¶ä»–æƒ…å†µï¼ŒæŠ›å‡ºå¼‚å¸¸
            throw new IllegalArgumentException("Illegal Capacity: "+ initialCapacity);
        }
    }

    /**
     *é»˜è®¤æ— å‚æ„é€ å‡½æ•°
     *DEFAULTCAPACITY_EMPTY_ELEMENTDATA ä¸º0.åˆå§‹åŒ–ä¸º10ï¼Œä¹Ÿå°±æ˜¯è¯´åˆå§‹å…¶å®æ˜¯ç©ºæ•°ç»„ å½“æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™æ•°ç»„å®¹é‡æ‰å˜æˆ10
     */
    public ArrayList() {
        this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;
    }

    /**
     * æ„é€ ä¸€ä¸ªåŒ…å«æŒ‡å®šé›†åˆçš„å…ƒç´ çš„åˆ—è¡¨ï¼ŒæŒ‰ç…§å®ƒä»¬ç”±é›†åˆçš„è¿­ä»£å™¨è¿”å›çš„é¡ºåºã€‚
     */
    public ArrayList(Collection<? extends E> c) {
        //å°†æŒ‡å®šé›†åˆè½¬æ¢ä¸ºæ•°ç»„
        elementData = c.toArray();
        //å¦‚æœelementDataæ•°ç»„çš„é•¿åº¦ä¸ä¸º0
        if ((size = elementData.length) != 0) {
            // å¦‚æœelementDataä¸æ˜¯Objectç±»å‹æ•°æ®ï¼ˆc.toArrayå¯èƒ½è¿”å›çš„ä¸æ˜¯Objectç±»å‹çš„æ•°ç»„æ‰€ä»¥åŠ ä¸Šä¸‹é¢çš„è¯­å¥ç”¨äºåˆ¤æ–­ï¼‰      
            if (elementData.getClass() != Object[].class)
                //å°†åŸæ¥ä¸æ˜¯Objectç±»å‹çš„elementDataæ•°ç»„çš„å†…å®¹ï¼Œèµ‹å€¼ç»™æ–°çš„Objectç±»å‹çš„elementDataæ•°ç»„
                elementData = Arrays.copyOf(elementData, size, Object[].class);
        } else {
            // å…¶ä»–æƒ…å†µï¼Œç”¨ç©ºæ•°ç»„ä»£æ›¿
            this.elementData = EMPTY_ELEMENTDATA;
        }
    }
```

## 2. æ‰©å®¹æœºåˆ¶

### â…  è‡ªåŠ¨æ‰©å®¹

 `ArrayList ` è‡ªåŠ¨æ‰©å®¹å‘ç”Ÿåœ¨ `add()` æ–¹æ³•è°ƒç”¨çš„æ—¶å€™ï¼š

```java
	/**
     * å°†æŒ‡å®šçš„å…ƒç´ è¿½åŠ åˆ°æ­¤åˆ—è¡¨çš„æœ«å°¾ã€‚ 
     */
    public boolean add(E e) {
        // æ‰©å®¹
        ensureCapacityInternal(size + 1);  // Increments modCount!!
        //è¿™é‡Œçœ‹åˆ°ArrayListæ·»åŠ å…ƒç´ çš„å®è´¨å°±ç›¸å½“äºä¸ºæ•°ç»„èµ‹å€¼
        elementData[size++] = e;
        return true;
    }

    /**
     * åœ¨æ­¤åˆ—è¡¨ä¸­çš„æŒ‡å®šä½ç½®æ’å…¥æŒ‡å®šçš„å…ƒç´ ã€‚ 
     *å…ˆè°ƒç”¨ rangeCheckForAdd å¯¹indexè¿›è¡Œç•Œé™æ£€æŸ¥ï¼›ç„¶åè°ƒç”¨ ensureCapacityInternal æ–¹æ³•ä¿è¯capacityè¶³å¤Ÿå¤§ï¼›
     *å†å°†ä»indexå¼€å§‹ä¹‹åçš„æ‰€æœ‰æˆå‘˜åç§»ä¸€ä¸ªä½ç½®ï¼›å°†elementæ’å…¥indexä½ç½®ï¼›æœ€åsizeåŠ 1ã€‚
     */
    public void add(int index, E element) {
        rangeCheckForAdd(index);

        ensureCapacityInternal(size + 1);  // Increments modCount!!
        //arraycopy()å®ç°æ•°ç»„ä¹‹é—´å¤åˆ¶çš„æ–¹æ³•ï¼Œä¸‹é¢å°±ç”¨åˆ°äº†arraycopy()æ–¹æ³•å®ç°æ•°ç»„è‡ªå·±å¤åˆ¶è‡ªå·±
        System.arraycopy(elementData, index, elementData, index + 1,
                         size - index);
        elementData[index] = element;
        size++;
    }
```

`ensureCapacityInternal()` æ˜¯ç”¨æ¥**ä»¥æœ€å°å®¹é‡è¿›è¡Œæ‰©å®¹**çš„ï¼ˆå°†ç”¨æˆ·ä¼ å…¥çš„å‚æ•°å’Œé»˜è®¤çš„å®¹é‡è¿›è¡Œæ¯”è¾ƒï¼Œé€‰å–æœ€å¤§å€¼ï¼‰ï¼š

```java
	//ä»¥æœ€å°å®¹é‡è¿›è¡Œæ‰©å®¹
    private void ensureCapacityInternal(int minCapacity) {
        ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));
    }
```

`calculateCapacity` ç”¨æ¥è·å–æœ€å°å®¹é‡ `minCapacity`ï¼š

```java
	// è·å–æœ€å°å®¹é‡
	private static int calculateCapacity(Object[] elementData, int minCapacity) {
        if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {
            return Math.max(DEFAULT_CAPACITY, minCapacity);
        }
        return minCapacity;
    }
```

`ensureExplicitCapacity` åˆ¤æ–­è¯¥ `ArrayList `æ˜¯å¦éœ€è¦æ‰©å®¹ï¼ˆå¦‚æœæœ€å°æ‰©å®¹é‡å¤§äºç°å·²å­˜åœ¨çš„æ•°ç»„å®¹é‡ï¼Œåˆ™éœ€è¦è¿›è¡Œæ‰©å®¹ï¼‰ï¼š

```java
	//åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹
    private void ensureExplicitCapacity(int minCapacity) {
        modCount++;

        // å¦‚æœæœ€å°æ‰©å®¹é‡å¤§äºç°å·²å­˜åœ¨çš„æ•°ç»„å®¹é‡ï¼Œåˆ™éœ€è¦è¿›è¡Œæ‰©å®¹
        if (minCapacity - elementData.length > 0)
            //è°ƒç”¨growæ–¹æ³•è¿›è¡Œæ‰©å®¹ï¼Œè°ƒç”¨æ­¤æ–¹æ³•ä»£è¡¨å·²ç»å¼€å§‹æ‰©å®¹äº†
            grow(minCapacity);
    }
```

`ArrayList `æ‰©å®¹çš„æ ¸å¿ƒæ–¹æ³• `grow`ï¼š

```java
	/**
     * è¦åˆ†é…çš„æœ€å¤§æ•°ç»„å¤§å°
     */
    private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;

    /**
     * ArrayListæ‰©å®¹çš„æ ¸å¿ƒæ–¹æ³•ã€‚
     */
    private void grow(int minCapacity) {
        // oldCapacityä¸ºæ—§å®¹é‡ï¼ŒnewCapacityä¸ºæ–°å®¹é‡
        int oldCapacity = elementData.length;
        //å°†oldCapacity å³ç§»ä¸€ä½ï¼Œå…¶æ•ˆæœç›¸å½“äºoldCapacity /2ï¼Œ
        //æˆ‘ä»¬çŸ¥é“ä½è¿ç®—çš„é€Ÿåº¦è¿œè¿œå¿«äºæ•´é™¤è¿ç®—ï¼Œæ•´å¥è¿ç®—å¼çš„ç»“æœå°±æ˜¯å°†æ–°å®¹é‡æ›´æ–°ä¸ºæ—§å®¹é‡çš„1.5å€ï¼Œ
        int newCapacity = oldCapacity + (oldCapacity >> 1);
        //å†åˆ¤æ–­ä¸€ä¸‹æ–°æ•°ç»„çš„å®¹é‡å¤Ÿä¸å¤Ÿï¼Œå¤Ÿäº†å°±ç›´æ¥ä½¿ç”¨è¿™ä¸ªé•¿åº¦åˆ›å»ºæ–°æ•°ç»„. è‹¥è¿˜æ˜¯å°äºæœ€å°éœ€è¦å®¹é‡ï¼Œé‚£ä¹ˆå°±æŠŠæœ€å°éœ€è¦å®¹é‡å½“ä½œæ•°ç»„çš„æ–°å®¹é‡ï¼Œ
        if (newCapacity - minCapacity < 0)
            newCapacity = minCapacity;
        //å†æ£€æŸ¥æ–°å®¹é‡æ˜¯å¦è¶…å‡ºäº†ArrayListæ‰€å®šä¹‰çš„æœ€å¤§å®¹é‡ï¼Œ
        //è‹¥è¶…å‡ºäº†ï¼Œåˆ™è°ƒç”¨hugeCapacity()æ¥æ¯”è¾ƒminCapacityå’Œ MAX_ARRAY_SIZEï¼Œ
        //å¦‚æœminCapacityå¤§äºMAX_ARRAY_SIZEï¼Œåˆ™æ–°å®¹é‡åˆ™ä¸ºInterger.MAX_VALUEï¼Œå¦åˆ™ï¼Œæ–°å®¹é‡å¤§å°åˆ™ä¸º MAX_ARRAY_SIZEã€‚
        if (newCapacity - MAX_ARRAY_SIZE > 0)
            newCapacity = hugeCapacity(minCapacity);
        
        // è°ƒç”¨Arrays.copyOfæ–¹æ³•å°†elementDataæ•°ç»„æŒ‡å‘æ–°çš„å†…å­˜ç©ºé—´ï¼ˆnewCapacityçš„è¿ç»­ç©ºé—´ï¼‰
        // å¹¶å°†elementDataçš„æ•°æ®å¤åˆ¶åˆ°æ–°çš„å†…å­˜ç©ºé—´
        elementData = Arrays.copyOf(elementData, newCapacity);
    }
    
    //æ¯”è¾ƒ minCapacity å’Œ MAX_ARRAY_SIZE
    private static int hugeCapacity(int minCapacity) {
        if (minCapacity < 0) // overflow
            throw new OutOfMemoryError();
        return (minCapacity > MAX_ARRAY_SIZE) ?
            Integer.MAX_VALUE :
            MAX_ARRAY_SIZE;
    }
```

ä» `grow` æ–¹æ³•ä¸­æˆ‘ä»¬å¯ä»¥æ¸…æ™°çš„çœ‹å‡ºå…¶å® **`ArrayList `æ‰©å®¹çš„æœ¬è´¨å°±æ˜¯è®¡ç®—å‡ºæ–°çš„æ‰©å®¹æ•°ç»„çš„ `size` åå®ä¾‹åŒ–ï¼Œå¹¶å°†åŸæœ‰æ•°ç»„å†…å®¹å¤åˆ¶åˆ°æ–°æ•°ç»„ä¸­å»ã€‚**

### â…¡ ä½¿ç”¨ ensureCapacity æé«˜æ·»åŠ é€Ÿåº¦

åœ¨æ·»åŠ  `add` å¤§é‡å…ƒç´ å‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `ensureCapacity `æ“ä½œæ¥å¢åŠ  `ArrayList `å®ä¾‹çš„å®¹é‡ã€‚è¿™æ ·å¯ä»¥å¤§å¤§æé«˜æ·»åŠ å…ƒç´ çš„é€Ÿåº¦ã€‚

```java
	/**
     * å¦‚æœ‰å¿…è¦ï¼Œå¢åŠ æ­¤ArrayListå®ä¾‹çš„å®¹é‡ï¼Œä»¥ç¡®ä¿å®ƒè‡³å°‘èƒ½å®¹çº³å…ƒç´ çš„æ•°é‡
     * @param   minCapacity   æ‰€éœ€çš„æœ€å°å®¹é‡
     */
    public void ensureCapacity(int minCapacity) {
        //å¦‚æœæ˜¯trueï¼ŒminExpandçš„å€¼ä¸º0ï¼Œå¦‚æœæ˜¯false,minExpandçš„å€¼ä¸º10
        int minExpand = (elementData != DEFAULTCAPACITY_EMPTY_ELEMENTDATA)
            // any size if not default element table
            ? 0
            // larger than default for default empty table. It's already
            // supposed to be at default size.
            : DEFAULT_CAPACITY;
        //å¦‚æœæœ€å°å®¹é‡å¤§äºå·²æœ‰çš„æœ€å¤§å®¹é‡
        if (minCapacity > minExpand) {
            ensureExplicitCapacity(minCapacity);
        }
    }
```

ç¤ºä¾‹ï¼š

```java
public class EnsureCapacityTest {  
    public static void main(String[] args){  
        
        final int N = 1000000;  
        Object obj = new Object();  
          
        // æ²¡ç”¨è°ƒç”¨ensureCapacity()æ–¹æ³•åˆå§‹åŒ–ArrayListå¯¹è±¡  
        ArrayList list = new ArrayList();  
        long startTime = System.currentTimeMillis();  
        for(int i=0;i<=N;i++){  
            list.add(obj);  
        }  
        long endTime = System.currentTimeMillis();  
        System.out.println("æ²¡æœ‰è°ƒç”¨ensureCapacity()æ–¹æ³•æ‰€ç”¨æ—¶é—´ï¼š" + (endTime - startTime) + "ms");  
          
        // è°ƒç”¨ensureCapacity()æ–¹æ³•åˆå§‹åŒ–ArrayListå¯¹è±¡  
        list = new ArrayList();  
        startTime = System.currentTimeMillis();  
        list.ensureCapacity(N); // é¢„å…ˆè®¾ç½® list çš„å¤§å°  
        for(int i=0;i<=N;i++){  
            list.add(obj);  
        }  
        endTime = System.currentTimeMillis();  
        System.out.println("è°ƒç”¨ensureCapacity()æ–¹æ³•æ‰€ç”¨æ—¶é—´ï¼š" + (endTime - startTime) + "ms");  
    }  
}  
```

è¾“å‡ºç»“æœï¼š

- æ²¡æœ‰è°ƒç”¨ `ensureCapacity()` æ–¹æ³•æ‰€ç”¨æ—¶é—´ï¼š110ms
- è°ƒç”¨` ensureCapacity()` æ–¹æ³•æ‰€ç”¨æ—¶é—´ï¼š31ms

ç»“æœæ˜¾è€Œæ˜“è§ï¼Œåœ¨ N çš„å€¼å¾ˆå¤§çš„æ—¶å€™ï¼Œä½¿ç”¨ `ensureCapacity()` æ–¹æ³•å¯å¤§å¤§æé«˜æ•ˆç‡ï¼›å½“ N çš„å€¼è¾ƒå°æ—¶ï¼Œåˆ™æ‰€ç”¨æ—¶é—´å·®è·ä¸æ˜æ˜¾ã€‚

## 3. å¢åˆ æ”¹æŸ¥

```java
 	/**
     * æ£€æŸ¥ç»™å®šçš„ç´¢å¼•æ˜¯å¦åœ¨èŒƒå›´å†…ã€‚
     */
    private void rangeCheck(int index) {
        if (index >= size)
       java     throw new IndexOutOfBoundsException(outOfBoundsMsg(index));
    }

    /**
     * addå’ŒaddAllä½¿ç”¨çš„rangeCheckçš„ä¸€ä¸ªç‰ˆæœ¬
     */
    private void rangeCheckForAdd(int index) {
        if (index > size || index < 0)
            throw new IndexOutOfBoundsException(outOfBoundsMsg(index));
    }
```

### å¢

```java
	// ------------------ å¢åŠ  -----------------------------

	/**
     * å°†æŒ‡å®šçš„å…ƒç´ è¿½åŠ åˆ°æ­¤åˆ—è¡¨çš„æœ«å°¾ã€‚ 
     */
    public boolean add(E e) {
        ensureCapacityInternal(size + 1);  // Increments modCount!!
        //è¿™é‡Œçœ‹åˆ°ArrayListæ·»åŠ å…ƒç´ çš„å®è´¨å°±ç›¸å½“äºä¸ºæ•°ç»„èµ‹å€¼
        elementData[size++] = e;
        return true;
    }

    /**
     * åœ¨æ­¤åˆ—è¡¨ä¸­çš„æŒ‡å®šä½ç½®æ’å…¥æŒ‡å®šçš„å…ƒç´ ã€‚ 
     *å…ˆè°ƒç”¨ rangeCheckForAdd å¯¹indexè¿›è¡Œç•Œé™æ£€æŸ¥ï¼›ç„¶åè°ƒç”¨ ensureCapacityInternal æ–¹æ³•ä¿è¯capacityè¶³å¤Ÿå¤§ï¼›
     *å†å°†ä»indexå¼€å§‹ä¹‹åçš„æ‰€æœ‰æˆå‘˜åç§»ä¸€ä¸ªä½ç½®ï¼›å°†elementæ’å…¥indexä½ç½®ï¼›æœ€åsizeåŠ 1ã€‚
     */
    public void add(int index, E element) {
        rangeCheckForAdd(index);

        ensureCapacityInternal(size + 1);  // Increments modCount!!
        //arraycopy()å®ç°æ•°ç»„ä¹‹é—´å¤åˆ¶çš„ï¼Œä¸‹é¢å°±ç”¨åˆ°äº†arraycopy()æ–¹æ³•å®ç°æ•°ç»„è‡ªå·±å¤åˆ¶è‡ªå·±
        System.arraycopy(elementData, index, elementData, index + 1,
                         size - index);
        elementData[index] = element;
        size++;
    }

	/**
     * æŒ‰æŒ‡å®šé›†åˆçš„Iteratorè¿”å›çš„é¡ºåºå°†æŒ‡å®šé›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ è¿½åŠ åˆ°æ­¤åˆ—è¡¨çš„æœ«å°¾ã€‚
     */
    public boolean addAll(Collection<? extends E> c) {
        Object[] a = c.toArray();
        int numNew = a.length;
        ensureCapacityInternal(size + numNew);  // Increments modCount
        System.arraycopy(a, 0, elementData, size, numNew);
        size += numNew;
        return numNew != 0;
    }

    /**
     * å°†æŒ‡å®šé›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ æ’å…¥åˆ°æ­¤åˆ—è¡¨ä¸­ï¼Œä»æŒ‡å®šçš„ä½ç½®å¼€å§‹ã€‚
     */
    public boolean addAll(int index, Collection<? extends E> c) {
        rangeCheckForAdd(index);

        Object[] a = c.toArray();
        int numNew = a.length;
        ensureCapacityInternal(size + numNew);  // Increments modCount

        int numMoved = size - index;
        if (numMoved > 0)
            System.arraycopy(elementData, index, elementData, index + numNew,
                             numMoved);

        System.arraycopy(a, 0, elementData, index, numNew);
        size += numNew;
        return numNew != 0;
    }
```

### åˆ 

```java
	// ------------------ åˆ é™¤ -----------------------------

    /**
     * åˆ é™¤è¯¥åˆ—è¡¨ä¸­æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚ å°†ä»»ä½•åç»­å…ƒç´ ç§»åŠ¨åˆ°å·¦ä¾§ï¼ˆä»å…¶ç´¢å¼•ä¸­å‡å»ä¸€ä¸ªå…ƒç´ ï¼‰ã€‚ 
     */
    public E remove(int index) {
        rangeCheck(index);

        modCount++;
        E oldValue = elementData(index);

        int numMoved = size - index - 1;
        if (numMoved > 0)
            System.arraycopy(elementData, index+1, elementData, index,
                             numMoved);
        elementData[--size] = null; // clear to let GC do its work
        //ä»åˆ—è¡¨ä¸­åˆ é™¤çš„å…ƒç´  
        return oldValue;
    }

    /**
     * ä»åˆ—è¡¨ä¸­åˆ é™¤æŒ‡å®šå…ƒç´ çš„ç¬¬ä¸€ä¸ªå‡ºç°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚ å¦‚æœåˆ—è¡¨ä¸åŒ…å«è¯¥å…ƒç´ ï¼Œåˆ™å®ƒä¸ä¼šæ›´æ”¹ã€‚
     *è¿”å›trueï¼Œå¦‚æœæ­¤åˆ—è¡¨åŒ…å«æŒ‡å®šçš„å…ƒç´ 
     */
    public boolean remove(Object o) {
        if (o == null) {
            for (int index = 0; index < size; index++)
                if (elementData[index] == null) {
                    fastRemove(index);
                    return true;
                }
        } else {
            for (int index = 0; index < size; index++)
                if (o.equals(elementData[index])) {
                    fastRemove(index);
                    return true;
                }
        }
        return false;
    }

    /*
     * Private remove method that skips bounds checking and does not
     * return the value removed.
     */
    private void fastRemove(int index) {
        modCount++;
        int numMoved = size - index - 1;
        if (numMoved > 0)
            System.arraycopy(elementData, index+1, elementData, index,
                             numMoved);
        elementData[--size] = null; // clear to let GC do its work
    }

    /**
     * ä»åˆ—è¡¨ä¸­åˆ é™¤æ‰€æœ‰å…ƒç´ ã€‚ 
     */
    public void clear() {
        modCount++;

        // æŠŠæ•°ç»„ä¸­æ‰€æœ‰çš„å…ƒç´ çš„å€¼è®¾ä¸ºnull
        for (int i = 0; i < size; i++)
            elementData[i] = null;

        size = 0;
    }

    /**
     * ä»æ­¤åˆ—è¡¨ä¸­åˆ é™¤æ‰€æœ‰ç´¢å¼•ä¸ºfromIndex ï¼ˆå«ï¼‰å’ŒtoIndexä¹‹é—´çš„å…ƒç´ ã€‚
     *å°†ä»»ä½•åç»­å…ƒç´ ç§»åŠ¨åˆ°å·¦ä¾§ï¼ˆå‡å°‘å…¶ç´¢å¼•ï¼‰ã€‚
     */
    protected void removeRange(int fromIndex, int toIndex) {
        modCount++;
        int numMoved = size - toIndex;
        System.arraycopy(elementData, toIndex, elementData, fromIndex,
                         numMoved);

        // clear to let GC do its work
        int newSize = size - (toIndex-fromIndex);
        for (int i = newSize; i < size; i++) {
            elementData[i] = null;
        }
        size = newSize;
    }


    /**
     * ä»æ­¤åˆ—è¡¨ä¸­åˆ é™¤æŒ‡å®šé›†åˆä¸­åŒ…å«çš„æ‰€æœ‰å…ƒç´ ã€‚ 
     */
    public boolean removeAll(Collection<?> c) {
        Objects.requireNonNull(c);
        //å¦‚æœæ­¤åˆ—è¡¨è¢«ä¿®æ”¹åˆ™è¿”å›true
        return batchRemove(c, false);
    }

    /**
     * ä»…ä¿ç•™æ­¤åˆ—è¡¨ä¸­åŒ…å«åœ¨æŒ‡å®šé›†åˆä¸­çš„å…ƒç´ ã€‚
     *æ¢å¥è¯è¯´ï¼Œä»æ­¤åˆ—è¡¨ä¸­åˆ é™¤å…¶ä¸­ä¸åŒ…å«åœ¨æŒ‡å®šé›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚ 
     */
    public boolean retainAll(Collection<?> c) {
        Objects.requireNonNull(c);
        return batchRemove(c, true);
    }
```

### æ”¹

```java
	// ------------------ ä¿®æ”¹ -----------------------------	

    /**
     * ç”¨æŒ‡å®šçš„å…ƒç´ æ›¿æ¢æ­¤åˆ—è¡¨ä¸­æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚ 
     */
    public E set(int index, E element) {
        //å¯¹indexè¿›è¡Œç•Œé™æ£€æŸ¥
        rangeCheck(index);

        E oldValue = elementData(index);
        elementData[index] = element;
        //è¿”å›åŸæ¥åœ¨è¿™ä¸ªä½ç½®çš„å…ƒç´ 
        return oldValue;
    }
```

### æŸ¥

```java
	// ------------------ æŸ¥æ‰¾ -----------------------------

  	@SuppressWarnings("unchecked")
    E elementData(int index) {
        return (E) elementData[index];
    }

	/**
     * è¿”å›æ­¤åˆ—è¡¨ä¸­æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚
     */
    public E get(int index) {
        rangeCheck(index);

        return elementData(index);
    }

	/**
     *è¿”å›æ­¤åˆ—è¡¨ä¸­çš„å…ƒç´ æ•°ã€‚ 
     */
    public int size() {
        return size;
    }

    /**
     * å¦‚æœæ­¤åˆ—è¡¨ä¸åŒ…å«å…ƒç´ ï¼Œåˆ™è¿”å› true ã€‚
     */
    public boolean isEmpty() {
        //æ³¨æ„=å’Œ==çš„åŒºåˆ«
        return size == 0;
    }

    /**
     * å¦‚æœæ­¤åˆ—è¡¨åŒ…å«æŒ‡å®šçš„å…ƒç´ ï¼Œåˆ™è¿”å›true ã€‚
     */
    public boolean contains(Object o) {
        //indexOf()æ–¹æ³•ï¼šè¿”å›æ­¤åˆ—è¡¨ä¸­æŒ‡å®šå…ƒç´ çš„é¦–æ¬¡å‡ºç°çš„ç´¢å¼•ï¼Œå¦‚æœæ­¤åˆ—è¡¨ä¸åŒ…å«æ­¤å…ƒç´ ï¼Œåˆ™ä¸º-1 
        return indexOf(o) >= 0;
    }

    /**
     *è¿”å›æ­¤åˆ—è¡¨ä¸­æŒ‡å®šå…ƒç´ çš„é¦–æ¬¡å‡ºç°çš„ç´¢å¼•ï¼Œå¦‚æœæ­¤åˆ—è¡¨ä¸åŒ…å«æ­¤å…ƒç´ ï¼Œåˆ™ä¸º-1 
     */
    public int indexOf(Object o) {
        if (o == null) {
            for (int i = 0; i < size; i++)
                if (elementData[i]==null)
                    return i;
        } else {
            for (int i = 0; i < size; i++)
                //equals()æ–¹æ³•æ¯”è¾ƒ
                if (o.equals(elementData[i]))
                    return i;
        }
        return -1;
    }

    /**
     * è¿”å›æ­¤åˆ—è¡¨ä¸­æŒ‡å®šå…ƒç´ çš„æœ€åä¸€æ¬¡å‡ºç°çš„ç´¢å¼•ï¼Œå¦‚æœæ­¤åˆ—è¡¨ä¸åŒ…å«å…ƒç´ ï¼Œåˆ™è¿”å›-1ã€‚
     * å’Œ indexOf æ¯”èµ·æ¥ï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹äº†å¾ªç¯çš„é¡ºåºï¼ˆä»å‰å¾€å â€”â€”> ä»åå¾€å‰ï¼‰ç½¢äº†
     */
    public int lastIndexOf(Object o) {
        if (o == null) {
            for (int i = size-1; i >= 0; i--)
                if (elementData[i]==null)
                    return i;
        } else {
            for (int i = size-1; i >= 0; i--)
                if (o.equals(elementData[i]))
                    return i;
        }
        return -1;
    }
```

## 4. toArray

```java
	/**
     *ä»¥æ­£ç¡®çš„é¡ºåºï¼ˆä»ç¬¬ä¸€ä¸ªåˆ°æœ€åä¸€ä¸ªå…ƒç´ ï¼‰è¿”å›ä¸€ä¸ªåŒ…å«æ­¤åˆ—è¡¨ä¸­æ‰€æœ‰å…ƒç´ çš„æ•°ç»„ã€‚ 
     *è¿”å›çš„æ•°ç»„å°†æ˜¯â€œå®‰å…¨çš„â€ï¼Œå› ä¸ºè¯¥åˆ—è¡¨ä¸ä¿ç•™å¯¹å®ƒçš„å¼•ç”¨ã€‚ ï¼ˆæ¢å¥è¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•å¿…é¡»åˆ†é…ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼‰ã€‚
     *å› æ­¤ï¼Œè°ƒç”¨è€…å¯ä»¥è‡ªç”±åœ°ä¿®æ”¹è¿”å›çš„æ•°ç»„ã€‚ æ­¤æ–¹æ³•å……å½“åŸºäºé˜µåˆ—å’ŒåŸºäºé›†åˆçš„APIä¹‹é—´çš„æ¡¥æ¢ã€‚
     */
    public Object[] toArray() {
        return Arrays.copyOf(elementData, size);
    }

    /**
     *ä»¥æ­£ç¡®çš„é¡ºåºè¿”å›ä¸€ä¸ªåŒ…å«æ­¤åˆ—è¡¨ä¸­æ‰€æœ‰å…ƒç´ çš„æ•°ç»„ï¼ˆä»ç¬¬ä¸€ä¸ªåˆ°æœ€åä¸€ä¸ªå…ƒç´ ï¼‰; 
     *è¿”å›çš„æ•°ç»„çš„è¿è¡Œæ—¶ç±»å‹æ˜¯æŒ‡å®šæ•°ç»„çš„è¿è¡Œæ—¶ç±»å‹ã€‚ å¦‚æœåˆ—è¡¨é€‚åˆæŒ‡å®šçš„æ•°ç»„ï¼Œåˆ™è¿”å›å…¶ä¸­ã€‚ 
     *å¦åˆ™ï¼Œå°†ä¸ºæŒ‡å®šæ•°ç»„çš„è¿è¡Œæ—¶ç±»å‹å’Œæ­¤åˆ—è¡¨çš„å¤§å°åˆ†é…ä¸€ä¸ªæ–°æ•°ç»„ã€‚ 
     *å¦‚æœåˆ—è¡¨é€‚ç”¨äºæŒ‡å®šçš„æ•°ç»„ï¼Œå…¶ä½™ç©ºé—´ï¼ˆå³æ•°ç»„çš„åˆ—è¡¨æ•°é‡å¤šäºæ­¤å…ƒç´ ï¼‰ï¼Œåˆ™ç´§è·Ÿåœ¨é›†åˆç»“æŸåçš„æ•°ç»„ä¸­çš„å…ƒç´ è®¾ç½®ä¸ºnull ã€‚
     *ï¼ˆè¿™ä»…åœ¨è°ƒç”¨è€…çŸ¥é“åˆ—è¡¨ä¸åŒ…å«ä»»ä½•ç©ºå…ƒç´ çš„æƒ…å†µä¸‹æ‰èƒ½ç¡®å®šåˆ—è¡¨çš„é•¿åº¦ã€‚ï¼‰ 
     */
    @SuppressWarnings("unchecked")
    public <T> T[] toArray(T[] a) {
        if (a.length < size)
            // æ–°å»ºä¸€ä¸ªè¿è¡Œæ—¶ç±»å‹çš„æ•°ç»„ï¼Œä½†æ˜¯ArrayListæ•°ç»„çš„å†…å®¹
            return (T[]) Arrays.copyOf(elementData, size, a.getClass());
            //è°ƒç”¨Systemæä¾›çš„arraycopy()æ–¹æ³•å®ç°æ•°ç»„ä¹‹é—´çš„å¤åˆ¶
        System.arraycopy(elementData, 0, a, 0, size);
        if (a.length > size)
            a[size] = null;
        return a;
    }
```

## 5. è¿­ä»£å™¨

```java
	/**
     * ä»åˆ—è¡¨ä¸­çš„æŒ‡å®šä½ç½®å¼€å§‹ï¼Œè¿”å›åˆ—è¡¨ä¸­çš„å…ƒç´ ï¼ˆæŒ‰æ­£ç¡®é¡ºåºï¼‰çš„åˆ—è¡¨è¿­ä»£å™¨ã€‚
     *æŒ‡å®šçš„ç´¢å¼•è¡¨ç¤ºåˆå§‹è°ƒç”¨å°†è¿”å›çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºnext ã€‚ åˆå§‹è°ƒç”¨previouså°†è¿”å›æŒ‡å®šç´¢å¼•å‡1çš„å…ƒç´ ã€‚ 
     *è¿”å›çš„åˆ—è¡¨è¿­ä»£å™¨æ˜¯fail-fast ã€‚ 
     */
    public ListIterator<E> listIterator(int index) {
        if (index < 0 || index > size)
            throw new IndexOutOfBoundsException("Index: "+index);
        return new ListItr(index);
    }

    /**
     *è¿”å›åˆ—è¡¨ä¸­çš„åˆ—è¡¨è¿­ä»£å™¨ï¼ˆæŒ‰é€‚å½“çš„é¡ºåºï¼‰ã€‚ 
     *è¿”å›çš„åˆ—è¡¨è¿­ä»£å™¨æ˜¯fail-fast ã€‚
     */
    public ListIterator<E> listIterator() {
        return new ListItr(0);
    }

    /**
     *ä»¥æ­£ç¡®çš„é¡ºåºè¿”å›è¯¥åˆ—è¡¨ä¸­çš„å…ƒç´ çš„è¿­ä»£å™¨ã€‚ 
     *è¿”å›çš„è¿­ä»£å™¨æ˜¯fail-fast ã€‚ 
     */
    public Iterator<E> iterator() {
        return new Itr();
    }
```

## 6. System.arraycopy() å’Œ Arrays.copyOf() æ–¹æ³•

é€šè¿‡ä¸Šé¢æºç æˆ‘ä»¬å‘ç°è¿™ä¸¤ä¸ªå®ç°æ•°ç»„å¤åˆ¶çš„æ–¹æ³•è¢«å¹¿æ³›ä½¿ç”¨è€Œä¸”å¾ˆå¤šåœ°æ–¹éƒ½ç‰¹åˆ«å·§å¦™ã€‚æ¯”å¦‚ä¸‹é¢ `add(int index, E element)` æ–¹æ³•å°±å¾ˆå·§å¦™çš„ç”¨åˆ°äº† `arraycopy()`æ–¹æ³•è®©æ•°ç»„è‡ªå·±å¤åˆ¶è‡ªå·±ï¼Œå®ç°è®© `index` å¼€å§‹ä¹‹åçš„æ‰€æœ‰æˆå‘˜åç§»ä¸€ä¸ªä½ç½®:

```java
public void add(int index, E element) {
    rangeCheckForAdd(index);

    ensureCapacityInternal(size + 1);  // Increments modCount!!
    //arraycopy()æ–¹æ³•å®ç°æ•°ç»„è‡ªå·±å¤åˆ¶è‡ªå·±
    //elementData:æºæ•°ç»„; index:æºæ•°ç»„ä¸­çš„èµ·å§‹ä½ç½®; elementDataï¼šç›®æ ‡æ•°ç»„ï¼›index + 1ï¼šç›®æ ‡æ•°ç»„ä¸­çš„èµ·å§‹ä½ç½®ï¼› size - indexï¼šè¦å¤åˆ¶çš„æ•°ç»„å…ƒç´ çš„æ•°é‡ï¼›
    System.arraycopy(elementData, index, elementData, index + 1, size - index);
    elementData[index] = element;
    size++;
}
```

âœ `arraycopy()` æºç ï¼š

```java
public static native void arraycopy(Object src,  int  srcPos,
                                    Object dest, int destPos,
                                    int length);
```

åˆå¦‚ `toArray()` æ–¹æ³•ä¸­ç”¨åˆ°äº†` copyOf()` æ–¹æ³•ï¼š

```java
public Object[] toArray() {
    //elementDataï¼šè¦å¤åˆ¶çš„æ•°ç»„ï¼›sizeï¼šè¦å¤åˆ¶çš„é•¿åº¦
    return Arrays.copyOf(elementData, size);
}
```

âœ ` copyOf()`  æºç ï¼š

```java
public static <T,U> T[] copyOf(U[] original, int newLength, Class<? extends T[]> newType) {
    @SuppressWarnings("unchecked")
    T[] copy = ((Object)newType == (Object)Object[].class)
        ? (T[]) new Object[newLength]
        : (T[]) Array.newInstance(newType.getComponentType(), newLength);
    System.arraycopy(original, 0, copy, 0,
                     Math.min(original.length, newLength));
    return copy;
}
```

å¯ä»¥å‘ç°`copyOf()`å†…éƒ¨è°ƒç”¨äº†`System.arraycopy()`æ–¹æ³•

**ä¸¤ä¸ªæ–¹æ³•çš„åŒºåˆ«ï¼š**

- `arraycopy()` éœ€è¦ç›®æ ‡æ•°ç»„ï¼Œå°†åŸæ•°ç»„æ‹·è´åˆ°ä½ è‡ªå·±å®šä¹‰çš„æ•°ç»„é‡Œï¼Œè€Œä¸”å¯ä»¥é€‰æ‹©æ‹·è´çš„èµ·ç‚¹å’Œé•¿åº¦ä»¥åŠæ”¾å…¥æ–°æ•°ç»„ä¸­çš„ä½ç½®
- `copyOf()` æ˜¯ç³»ç»Ÿè‡ªåŠ¨åœ¨å†…éƒ¨æ–°å»ºä¸€ä¸ªæ•°ç»„ï¼Œå¹¶è¿”å›è¯¥æ•°ç»„ã€‚

## ğŸ“š References

- ã€ŠJava æ ¸å¿ƒæŠ€æœ¯ - å· 1 åŸºç¡€çŸ¥è¯† - ç¬¬ 10 ç‰ˆã€‹

- [ArrayList çš„æ‰©å®¹æœºåˆ¶](https://www.cnblogs.com/dengrongzhang/p/9371551.html)

- [ensureCapacity() æ–¹æ³•æé«˜ ArrayList çš„åˆå§‹åŒ–é€Ÿåº¦](https://www.iteye.com/blog/guojianpeng9806-577602)

- [HashMap å®ç°åŸç†å’Œæºç åˆ†æ](https://blog.csdn.net/u010386612/article/details/80302777)

- [CS-Notes â€” Github](http://cyc2018.gitee.io/cs-notes/#/notes/Java%20%E5%AE%B9%E5%99%A8?id=_1-%e5%ad%98%e5%82%a8%e7%bb%93%e6%9e%84)

- [JavaGuide â€” Github](https://snailclimb.gitee.io/javaguide/#/docs/java/collection/HashMap)

  