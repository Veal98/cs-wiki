# ğŸ“¦ å¼•å…¥æ•°æ®åº“ MySQL

---

> ğŸ”Š æœ¬ç¯‡ä¸»è¦å®ç°å¼•å…¥æ•°æ®åº“ MySQLï¼Œé€šè¿‡ Spring Data JPA æ“ä½œæ•°æ®åº“ï¼Œå®ç°åç«¯è¿æ¥æ•°æ®åº“éªŒè¯ç”¨æˆ·åå’Œå¯†ç ï¼Œå®Œå–„ç™»å½•åŠŸèƒ½

## 1. åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·è¡¨

```sql
CREATE DATABASE cswiki;
USE cswiki;

-- ----------------------------
-- Table structure for user
-- ----------------------------
DROP TABLE IF EXISTS `userinfo`;
CREATE TABLE `userinfo` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `username` varchar(255) DEFAULT NULL,
  `password` varchar(255) DEFAULT NULL,
  `email` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of user
-- ----------------------------
INSERT INTO `userinfo` VALUES ('1', 'admin', '123456', 'admin@qq.com');
```

ç”¨æˆ·è¡¨ `userinfo `ç»“æ„ï¼š

<img src="https://gitee.com/veal98/images/raw/master/img/20200925112222.png" style="zoom:67%;" />

<img src="https://gitee.com/veal98/images/raw/master/img/20200925112105.png" style="zoom:67%;" />

ğŸš¨ å½“ç„¶ï¼ŒçœŸå®çš„é¡¹ç›®ä¸­ï¼Œç”¨æˆ·çš„å¯†ç æ˜¯ä¸ä¼šç›´æ¥ä»¥æ˜æ–‡å½¢å¼å­˜è¿›æ•°æ®åº“çš„ï¼Œä¸€èˆ¬çš„åšæ³•æ˜¯å­˜å‚¨å¯†ç ç­‰ä¿¡æ¯çš„ hash å€¼ã€‚**æˆ‘ä»¬æš‚æ—¶å…ˆå°±ç›´æ¥å­˜æ˜æ–‡ï¼Œæ•°æ®åº“è¿é€šä¹‹åå†åšä¿®æ”¹~**

## 2. å¯¼å…¥ä¾èµ–

é¦–å…ˆï¼Œéœ€è¦å¼•å…¥ **MySQL** å’Œ **Spring Data JPA** çš„ä¾èµ–ï¼ˆæˆ‘ä»¬ä½¿ç”¨ JPA æ¥å®ç°å®ä½“ç±»çš„æŒä¹…åŒ–ï¼‰ï¼š

```xml
	<dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>


    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <!-- æ³¨æ„æ­¤å¤„çš„å¤§ç‰ˆæœ¬è¦å’Œæœ¬åœ° MySQL çš„ç‰ˆæœ¬ä¸€è‡´-->
        <version>5.1.47</version>
    </dependency>
```

æŸ¥çœ‹ MySQL çš„ç‰ˆæœ¬ï¼š

<img src="https://gitee.com/veal98/images/raw/master/img/20200925112437.png" style="zoom: 60%;" />

## 3. é…ç½®æ•°æ®åº“ç›¸å…³ä¿¡æ¯

ç„¶åï¼Œéœ€è¦åœ¨å…¨å±€é…ç½®æ–‡ä»¶ `application.properties` ä¸­é…ç½®æ•°æ®åº“ç›¸å…³ä¿¡æ¯ï¼š

```properties
server.port = 8081

spring.datasource.url = jdbc:mysql://127.0.0.1:3306/cswiki?characterEncoding = UTF-8
spring.datasource.username = root
spring.datasource.password = root
spring.datasource.driver-class-name = com.mysql.jdbc.Driver

# æ‰“å° sql è¯­å¥
spring.jpa.show-sql = true 
```

ğŸš¨ æ³¨æ„ï¼š

- **MySQL 5.0+** ç‰ˆæœ¬å¯¹åº”çš„ `driver-class-name` æ˜¯ï¼š `com.mysql.jdbc.Driver`

- **MySQL 8.0+** ç‰ˆæœ¬å¯¹åº”çš„ `driver-class-name` æ˜¯ï¼š `com.mysql.cj.jdbc.Driver`

## 4. æµ‹è¯•æ•°æ®åº“è¿æ¥

```java
@SpringBootTest
class CswikiApplicationTests {

    @Autowired
    DataSource dataSource;

    @Test
    void contextLoads() {
        System.out.println("æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼š" + dataSource.getClass());
    }

}
```

<img src="https://gitee.com/veal98/images/raw/master/img/20200925115725.png" style="zoom:50%;" />

è¿æ¥æˆåŠŸ~

## 5. å»ºç«‹å®ä½“ç±»å’Œæ•°æ®åº“ä¹‹é—´çš„æ˜ å°„å…³ç³»

```java
/**
 * ç”¨æˆ·ç±»
 */
@Entity // è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå®ä½“ç±»
@Table(name = "userinfo") // è¡¨ç¤ºå¯¹åº”çš„è¡¨åæ˜¯ userinfo
@JsonIgnoreProperties({"handler","hibernateLazyInitializer"}) // å¿½ç•¥è¿™ä¸¤ä¸ªå±æ€§
public class UserInfo {

    // æ³¨æ„å‰ç«¯ä¼ å€¼çš„å­—æ®µè¦å’Œæ­¤å¤„ä¸€è‡´

    @Id // ä¸»é”®
    @GeneratedValue(strategy = GenerationType.IDENTITY) // è‡ªå¢é•¿
    private int id;
    private String username;
    private String password;
    private String email;
```

ğŸ’¡ è§£é‡Šä¸€ä¸‹ `@JsonIgnoreProperties({"handler","hibernateLazyInitializer"})`ï¼š

- å› ä¸ºæ˜¯åšå‰åç«¯åˆ†ç¦»ï¼Œè€Œå‰åç«¯æ•°æ®äº¤äº’ç”¨çš„æ˜¯ JSON æ ¼å¼ã€‚ é‚£ä¹ˆ `UserInfo` å¯¹è±¡å°±ä¼šè¢«è½¬æ¢ä¸º JSON æ•°æ®ã€‚
- è€Œæœ¬é¡¹ç›®ä½¿ç”¨ JPA æ¥åšå®ä½“ç±»çš„æŒä¹…åŒ–ï¼ŒJPA é»˜è®¤ä¼šä½¿ç”¨ Hibernateï¼ŒJPA ä¼šåˆ›é€ ä»£ç†ç±»æ¥ç»§æ‰¿ `UserInfo` ï¼Œå¹¶æ·»åŠ  `handler` å’Œ `hibernateLazyInitializer` è¿™ä¸¤ä¸ªæ— é¡» JSONåŒ–çš„å±æ€§ï¼Œ
* æ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨ `JsonIgnoreProperties` æŠŠè¿™ä¸¤ä¸ªå±æ€§å¿½ç•¥æ‰ã€‚

ğŸ”— å…³äº JPA å®ä½“ç±»åˆ°æ•°æ®åº“çš„æ˜ å°„å¯ä»¥å‚è§è¿™ç¯‡æ–‡ç« ï¼š

- [JPA å®ä½“ç±»æ˜ å°„åˆ°æ•°æ®åº“è¡¨çš„åŸºæœ¬æ³¨è§£](https://veal98.gitee.io/cs-wiki/#/Java/JPA/1-å®ä½“ç±»æ˜ å°„åˆ°æ•°æ®åº“è¡¨çš„åŸºæœ¬æ³¨è§£)

## 6. UserInfoDao æ¥å£ç»§æ‰¿ JpaRepository

`UserInfoDao ` æ¥å£ç»§æ‰¿ `JpaRepository<T,ID>` ç±»ï¼š

- `T`ï¼šè¡¨ç¤ºè¦æ“ä½œçš„å®ä½“ç±»
- `ID`ï¼šè¡¨ç¤ºä¸»é”®ç±»å‹

`JpaRepository` ä»¥åŠä»–çˆ¶ç±»çš„æ–¹æ³• `UserInfoDao `éƒ½å¯ä»¥ç›´æ¥æ‹¿æ¥ä½¿ç”¨ï¼Œæ­¤å¤„å°±åªåˆ—å‡º `JpaRepository` çš„æ–¹æ³•ï¼Œå¤§ä¼™å„¿å¯ä»¥ç‚¹å‡»ä»–çš„çˆ¶ç±»çœ‹çœ‹è¿˜æœ‰å“ªäº›å…¶ä»–çš„æ–¹æ³•ã€‚

![](https://gitee.com/veal98/images/raw/master/img/20200925122714.png)

```java
public interface UserInfoDao extends JpaRepository<UserInfo, Integer> {

    // é€šè¿‡ username æŸ¥è¯¢
    UserInfo findByUsername(String username);
    
    // é€šè¿‡ username å’Œ password æŸ¥è¯¢
    UserInfo findByUsernameAndPassword(String username, String password);
}
```

Spring Data JPA æ”¯æŒå¼€å‘è€…**è‡ªå®šä¹‰æŸ¥è¯¢æ–¹æ³•**ï¼Œå¯¹äºç¬¦åˆä»¥ä¸‹å‘½åè§„åˆ™çš„æ–¹æ³•ï¼ŒSpring Data JPA èƒ½å¤Ÿæ ¹æ®å…¶æ–¹æ³•åä¸ºå…¶è‡ªåŠ¨ç”Ÿæˆ SQLï¼Œæ”¯æŒçš„å…³é”®å­—æœ‰ï¼š`find`ã€`query`ã€`get`ã€`read`ã€`count`ã€`delete` ç­‰ã€‚ 

ä»¥ `find` ä¸ºä¾‹ï¼š

![](https://gitee.com/veal98/images/raw/master/img/20200925122225.png)

ğŸ”— å…³äº JPA çš„å¢åˆ æ”¹æŸ¥å¯ä»¥å‚è§è¿™ä¸¤ç¯‡æ–‡ç« ï¼š

- [Spring Data JPA çš„å››ç§æŸ¥è¯¢æ–¹å¼](https://veal98.gitee.io/cs-wiki/#/Java/JPA/3-SpringDataJPAçš„å››ç§æŸ¥è¯¢æ–¹å¼)
- [Spring Data JPA çš„æ›´æ–°æ–¹å¼è¯¦è§£](https://veal98.gitee.io/cs-wiki/#/Java/JPA/4-SpringDataJPAçš„æ›´æ–°æ–¹å¼è¯¦è§£)

## 7. æµ‹è¯• JPA æ“ä½œæ•°æ®åº“

```java
@SpringBootTest
class CswikiApplicationTests {

    @Autowired
    UserInfoDao userInfoDao;

    @Test
    void contextLoads() {
        System.out.println(userInfoDao.findByUsername("admin"));
    }

}
```

<img src="https://gitee.com/veal98/images/raw/master/img/20200925123524.png" style="zoom:50%;" />

## 8. UserInfoService

```java
@Service
public class UserInfoService {

    @Autowired
    UserInfoDao userInfoDao;

    // æ ¹æ® username æŸ¥è¯¢
    public UserInfo getByUsername(String username){
        return userInfoDao.findByUsername(username);
    }

    // æ ¹æ® username å’Œ password æŸ¥è¯¢
    public UserInfo getByUsernameAndPassword(String username, String pasword){
        return userInfoDao.findByUsernameAndPassword(username, pasword);
    }

}
```

## 9. LoginController

```java
@RestController
public class LoginController {

    @Autowired
    UserInfoService userInfoService;

    /**
     * ç”¨æˆ·æ³¨å†Œ
     * @param requestUser
     * @return
     */
    @CrossOrigin
    @PostMapping(value = "api/login")
    public Result login(@RequestBody UserInfo requestUser) {
        // è·å–å‰ç«¯ä¼ å€¼
        String username = requestUser.getUsername();
        String password = requestUser.getPassword();
        System.out.println("username: " + username);
        System.out.println("password: " + password);

        // ä»æ•°æ®åº“ä¸­æŸ¥è¯¢ç”¨æˆ·
        UserInfo userInfo = userInfoService.getByUsernameAndPassword(username, password);

        if (userInfo == null) {
            String message = "è´¦å·æˆ–å¯†ç é”™è¯¯";
            System.out.println(message);
            return ResultFactory.buildFailResult(message);
        } else {
            System.out.println("Successful");
            return ResultFactory.buildSuccessResult(requestUser); // ä¼ å›è¯¥ç”¨æˆ·å¯¹è±¡ç»™å‰ç«¯
        }
    }
}
```

ç®€å•æ€»ç»“ä¸€ä¸‹å„å±‚æ¬¡åˆ†å·¥ï¼š

- `DAO `ç”¨äºä¸æ•°æ®åº“çš„ç›´æ¥äº¤äº’ï¼Œå®šä¹‰å¢åˆ æ”¹æŸ¥ç­‰æ“ä½œ
- `Service `è´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼Œè·ŸåŠŸèƒ½ç›¸å…³çš„ä»£ç ä¸€èˆ¬å†™åœ¨è¿™é‡Œï¼Œç¼–å†™ã€è°ƒç”¨å„ç§æ–¹æ³•å¯¹ `DAO `å–å¾—çš„æ•°æ®è¿›è¡Œæ“ä½œ
- `Controller `è´Ÿè´£æ•°æ®äº¤äº’ï¼Œå³æ¥æ”¶å‰ç«¯å‘é€çš„æ•°æ®ï¼Œé€šè¿‡è°ƒç”¨ `Service `è·å¾—å¤„ç†åçš„æ•°æ®å¹¶è¿”å›

## 10. è¿è¡Œæµ‹è¯•

ç™»å½•æµ‹è¯•ï¼Œçœ‹èƒ½å¦æ­£å¸¸è·³è½¬ï¼š

<img src="https://gitee.com/veal98/images/raw/master/img/20200925124111.png" style="zoom:50%;" />