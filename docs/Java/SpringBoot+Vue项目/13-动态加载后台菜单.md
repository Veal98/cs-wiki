# ğŸ‰ åŠ¨æ€åŠ è½½åå°èœå•

---

## 1. è¿è¡Œæ•ˆæœ

å…ˆä¸Šæœ€ç»ˆæ•ˆæœï¼Œå„ä¸ªç»„ä»¶çš„å†…å®¹éƒ½è¿˜æ²¡å†™ï¼Œåªæ˜¯æ­äº†ä¸ªåŸºæœ¬æ¡†æ¶ï¼š

![](https://gitee.com/veal98/images/raw/master/img/20200824105459.png)

æ ¹æ®ç™»å½•ç”¨æˆ·çš„è§’è‰²æ¥åŠ¨æ€åˆ¤å®šéœ€è¦æ˜¾ç¤ºå“ªäº›èœå•æ ï¼Œæ¯”å¦‚ç®¡ç†å‘˜å°±æ˜¾ç¤ºæ‰€æœ‰èœå•æ ï¼Œæ™®é€šç”¨æˆ·å°±åªæ˜¾ç¤ºé¦–é¡µå’Œç³»ç»Ÿé…ç½®èœå•æ ç­‰ç­‰ã€‚

## 2. åŸºäº RBAC åŸåˆ™è®¾è®¡æ•°æ®åº“

### â‘  RBAC 

â­ RBAC æ˜¯**åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶**ï¼ˆRole-Based Access Control ï¼‰ã€‚åœ¨ RBAC ä¸­ï¼Œ**æƒé™ä¸è§’è‰²ç›¸å…³è”ï¼Œç”¨æˆ·é€šè¿‡æˆä¸ºé€‚å½“è§’è‰²çš„æˆå‘˜è€Œå¾—åˆ°è¿™äº›è§’è‰²çš„æƒé™**ã€‚è¿™å°±æå¤§åœ°ç®€åŒ–äº†æƒé™çš„ç®¡ç†ã€‚è¿™æ ·ç®¡ç†éƒ½æ˜¯å±‚çº§ç›¸äº’ä¾èµ–çš„ï¼Œæƒé™èµ‹äºˆç»™è§’è‰²ï¼Œè€ŒæŠŠè§’è‰²åˆèµ‹äºˆç”¨æˆ·ï¼Œè¿™æ ·çš„æƒé™è®¾è®¡å¾ˆæ¸…æ¥šï¼Œç®¡ç†èµ·æ¥å¾ˆæ–¹ä¾¿ã€‚

### â‘¡ å»ºè¡¨

åŸºäº RBAC åŸåˆ™ï¼Œæˆ‘ä»¬éœ€è¦ 5 å¼ è¡¨ï¼š

#### â…   ç”¨æˆ·è¡¨ user

ğŸ‘‰ ç”¨æˆ·è¡¨ `user`ï¼ˆä¹‹å‰å·²ç»å»ºç«‹å¥½ï¼‰

![](https://gitee.com/veal98/images/raw/master/img/20200824111347.png)

å»ºè¡¨ SQL è¯­å¥ï¼š

```sql
CREATE TABLE `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` char(255) NOT NULL,
  `password` varchar(255) DEFAULT NULL,
  `salt` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8;
```

![](https://gitee.com/veal98/images/raw/master/img/20200824114008.png)

æ³¨æ„è¿™é‡Œé¢çš„ç”¨æˆ·éƒ½æ˜¯é€šè¿‡æ³¨å†Œå¾—æ¥çš„ï¼Œæ‰€ä»¥å¯†ç æ˜¯é€šè¿‡åç«¯ä»£ç å·²ç»åŠ å¯†è¿‡çš„ï¼Œä¸æ˜¯æˆ‘ä»¬æ‰‹åŠ¨åœ¨æ•°æ®åº“ä¸­æ·»åŠ çš„

#### â…¡ è§’è‰²è¡¨ admin_role

ğŸ‘‰ è§’è‰²è¡¨ `admin_role`ï¼ˆä»¥ä¸‹è¿™äº›è¡¨éƒ½å±äºåœ¨ä¸ªäººä¸­å¿ƒè¿™ä¸ªæ¨¡å—æ‰èƒ½ç”¨ä¸Šçš„è¡¨ï¼ŒåŠ ä¸Šå‰ç¼€ admin æ˜“äºç†è§£ï¼‰

![](https://gitee.com/veal98/images/raw/master/img/20200824111603.png)

å»ºè¡¨ SQL è¯­å¥ï¼š

```sql
CREATE TABLE `admin_role` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(100) DEFAULT NULL,
  `name_zh` varchar(100) DEFAULT NULL,
  `enabled` tinyint(1) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;
```

![](https://gitee.com/veal98/images/raw/master/img/20200824113322.png)

#### â…¢ æƒé™è¡¨ admin_permission

ğŸ‘‰ æƒé™è¡¨ `admin_permission`

![](https://gitee.com/veal98/images/raw/master/img/20200824112308.png)

å»ºè¡¨ SQL è¯­å¥ï¼š

```sql
CREATE TABLE `admin_permission` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(100) DEFAULT NULL,
  `desc_` varchar(100) DEFAULT NULL,
  `url` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;
```

![](https://gitee.com/veal98/images/raw/master/img/20200824113359.png)

#### â…£ ç”¨æˆ·-è§’è‰²å…³ç³»è¡¨ admin_user_role

ğŸ‘‰ ç”¨æˆ·-è§’è‰²å…³ç³»è¡¨ `admin_user_role`

![](https://gitee.com/veal98/images/raw/master/img/20200824112413.png)

å»ºè¡¨ SQL è¯­å¥ï¼š

```sql
CREATE TABLE `admin_user_role` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `uid` int(11) DEFAULT NULL,
  `rid` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_operator_role_operator_1` (`uid`), # ç´¢å¼•
  KEY `fk_operator_role_role_1` (`rid`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;
```

ğŸš¨ ä¸»è¦æˆ‘è§‰å¾—ä½¿ç”¨å¤–é”®å¤ªåˆ«æ‰­ï¼Œ<u>æ­¤å¤„å°±**æ²¡æœ‰ä½¿ç”¨å¤–é”®**ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åœ¨ä»£ç ä¸­ä¿è¯æ•°æ®åº“çš„ä¸€è‡´æ€§ï¼ˆå…¶å®ä¹Ÿå°±æ˜¯ä¸ºæ¶‰åŠå¢åˆ æ”¹æ–¹æ³•çš„äº‹åŠ¡æ³¨è§£ `@Transactional`ï¼‰</u>

![](https://gitee.com/veal98/images/raw/master/img/20200824114347.png)

#### â…¤ è§’è‰²-æƒé™å…³ç³»è¡¨ admin_role_permission

ğŸ‘‰ è§’è‰²-æƒé™å…³ç³»è¡¨ `admin_role_permission`

![](https://gitee.com/veal98/images/raw/master/img/20200824112454.png)

å»ºè¡¨ SQL è¯­å¥ï¼š

```sql
CREATE TABLE `admin_role_permission` (
  `id` int(20) NOT NULL AUTO_INCREMENT,
  `rid` int(20) DEFAULT NULL,
  `pid` int(20) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_role_permission_role_1` (`rid`),
  KEY `fk_role_permission_permission_1` (`pid`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8;
```

![](https://gitee.com/veal98/images/raw/master/img/20200824114506.png)

#### â…¥ èœå•é¡¹è¡¨ admin_menu

ç”±äºéœ€è¦**æ ¹æ®ä¸åŒçš„è§’è‰²åŠ è½½ä¸åŒçš„èœå•é¡¹**ï¼Œæˆ‘ä»¬ä»éœ€è¦ 2 å¼ è¡¨ï¼šèœå•é¡¹è¡¨å’Œè§’è‰²-èœå•å…³ç³»è¡¨

ğŸ‘‰ èœå•é¡¹è¡¨ï¼š`admin_menu`

![](https://gitee.com/veal98/images/raw/master/img/20200824112928.png)

å»ºè¡¨ SQL è¯­å¥ï¼š

```sql
CREATE TABLE `admin_menu` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `path` varchar(64) DEFAULT NULL,
  `name` varchar(64) DEFAULT NULL,
  `name_zh` varchar(64) DEFAULT NULL,
  `icon_cls` varchar(64) DEFAULT NULL,
  `component` varchar(64) DEFAULT NULL,
  `parent_id` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=utf8;
```

![](https://gitee.com/veal98/images/raw/master/img/20200824114738.png)

#### â…¦ è§’è‰²-èœå•å…³ç³»è¡¨ admin_role_menu

ğŸ‘‰ è§’è‰²-èœå•å…³ç³»è¡¨ï¼š`admin_role_menu`

![](https://gitee.com/veal98/images/raw/master/img/20200824113107.png)

å»ºè¡¨ SQL è¯­å¥ï¼š

```sql
CREATE TABLE `admin_role_menu` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `rid` int(11) DEFAULT NULL,
  `mid` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=23 DEFAULT CHARSET=utf8;
```

![](https://gitee.com/veal98/images/raw/master/img/20200824114927.png)

### â‘¢ å®ä½“ç±» POJO

- `AdminRole`ï¼šå¯¹åº”æ•°æ®åº“è¡¨ `admin_role`

  ```java
  /**
   * è§’è‰²
   */
  @Entity
  @Table(name = "admin_role")
  @JsonIgnoreProperties({"handler", "hibernateLazyInitializer"})
  public class AdminRole {
  
      @Id
      @GeneratedValue(strategy = GenerationType.IDENTITY)
      @Column(name = "id")
      private Integer id;
      private String name;
      private String nameZh;
      private Integer enabled;
      @Transient // æ•°æ®åº“ä¸­ä¸å­˜åœ¨å¯¹åº”å­—æ®µçš„å±æ€§ï¼Œéœ€è¦ç”¨ @Transient æ³¨è®°æ ‡æ³¨å‡ºæ¥
      private List<AdminPermission> perms; // è¯¥è§’è‰²å¯¹åº”çš„æƒé™æè¿°
      @Transient
      private List<AdminMenu> menus; // è¯¥è§’è‰²å¯¹åº”çš„èœå•
  	
      public AdminRole() {
      }
  
      public AdminRole(String name, String nameZh, Integer enabled, List<AdminPermission> perms, List<AdminMenu> menus) {
          this.name = name;
          this.nameZh = nameZh;
          this.enabled = enabled;
          this.perms = perms;
          this.menus = menus;
      }
      
      // Getter And Setter
  }
  ```

- `AdminPermission`ï¼šå¯¹åº”æ•°æ®åº“è¡¨ `admin_permission`

  ```java
  @Entity
  @Table(name = "admin_permission")
  @JsonIgnoreProperties({"handler", "hibernateLazyInitializer"})
  public class AdminPermission {
      @Id
      @GeneratedValue(strategy = GenerationType.IDENTITY)
      @Column(name = "id")
      private Integer id;
      private String name;
      private String desc_;
      private String url;
      
  	public AdminPermission() {
      }
  
      public AdminPermission(String name, String desc_, String url) {
          this.name = name;
          this.desc_ = desc_;
          this.url = url;
      }
      
      // Getter And Setter
  }
  ```

- â­ `AdminMenu`ï¼šå¯¹åº”æ•°æ®åº“è¡¨ `admin_menu`

  ```java
  /**
   * åå°ç®¡ç†ç•Œé¢çš„èœå•é¡¹
   */
  @Entity
  @Table(name = "admin_menu")
  @JsonIgnoreProperties({"handler", "hibernateLazyInitializer"})
  public class AdminMenu {
  
      @Id
      @GeneratedValue(strategy = GenerationType.IDENTITY)
      @Column(name = "id")
      private Integer id;
      private String path;
      private String name;
      private String nameZh;
      private String iconCls;
      private String component;
      private Integer parentId; // çˆ¶èŠ‚ç‚¹ id
      @Transient // æ•°æ®åº“ä¸­ä¸å­˜åœ¨å¯¹åº”å­—æ®µçš„å±æ€§ï¼Œéœ€è¦ç”¨ @Transient æ³¨è®°æ ‡æ³¨å‡ºæ¥
      private  List<AdminMenu> children; // å­˜å‚¨å­èŠ‚ç‚¹
      
  	public AdminMenu() {
      }
  
      public AdminMenu(String path, String name, String nameZh, String iconCls, String component, Integer parentId, List<AdminMenu> children) {
          this.path = path;
          this.name = name;
          this.nameZh = nameZh;
          this.iconCls = iconCls;
          this.component = component;
          this.parentId = parentId;
          this.children = children;
      }
      
      // Getter And Setter
  }
  
  ```

- `AdminUserRole`ï¼šå¯¹åº”æ•°æ®åº“è¡¨ `admin_user_role`

  ```java
  /**
   * æ¯ä¸ªç”¨æˆ·å¯¹åº”çš„è§’è‰²
   */
  @Entity
  @Table(name = "admin_user_role")
  @JsonIgnoreProperties({"handler", "hibernateLazyInitializer"})
  public class AdminUserRole {
  
      @Id
      @GeneratedValue(strategy = GenerationType.IDENTITY)
      @Column(name = "id")
      private Integer id;
  
      private Integer uid; // ç”¨æˆ· id
      private Integer rid; // è§’è‰² id
  	
      public AdminUserRole() {
      }
  
      public AdminUserRole(Integer uid, Integer rid) {
          this.uid = uid;
          this.rid = rid;
      }
      
      // Getter And Setter
     
  }
  ```

- `AdminRolePermission`ï¼šå¯¹åº”æ•°æ®åº“è¡¨ `admin_role_permission`

  ```java
  @Entity
  @Table(name = "admin_role_permission")
  @JsonIgnoreProperties({"handler", "hibernateLazyInitializer"})
  public class AdminRolePermission {
      @Id
      @GeneratedValue(strategy = GenerationType.IDENTITY)
      @Column(name = "id")
      private Integer id;
  
      /**
       * Role id.
       */
      private int rid;
  
      /**
       * Permission id.
       */
      private int pid;
  
      public AdminRolePermission() {
      }
  
      public AdminRolePermission(int rid, int pid) {
          this.rid = rid;
          this.pid = pid;
      }
  
      // Getter And Setter
  }
  ```

- `AdminRoleMenu`ï¼šå¯¹åº”æ•°æ®åº“è¡¨ `admin_role_menu`

  ```java
  /**
   * æ¯ä¸ªè§’è‰²èƒ½å¤Ÿçœ‹åˆ°å“ªäº›èœå•
   */
  @Entity
  @Table(name = "admin_role_menu")
  @JsonIgnoreProperties({"handler", "hibernateLazyInitializer"})
  public class AdminRoleMenu {
  
      @Id
      @GeneratedValue(strategy = GenerationType.IDENTITY)
      @Column(name = "id")
      private Integer id;
      private Integer rid; // è§’è‰² id
      private Integer mid; // èœå• id
  
      public AdminRoleMenu() {
      }
  
      public AdminRoleMenu(Integer rid, Integer mid) {
          this.rid = rid;
          this.mid = mid;
      }
  
      // Getter And Setter
  }
  
  ```

## 3. æ•´ä½“æ€è·¯

è¡¨å·²ç»å…¨éƒ¨è®¾è®¡å®Œæ¯•äº† ï¼Œæ•´ä½“æ€è·¯æ˜¯è¿™æ ·çš„ï¼š

- é¦–å…ˆï¼Œç”¨æˆ·è¿›å…¥ä¸ªäººä¸­å¿ƒè¿™ä¸ªæ¨¡å—çš„æ—¶å€™ï¼Œè§¦å‘åç«¯æƒé™è®¤è¯ä»£ç ï¼Œæ ¹æ®è¯¥ç”¨æˆ·çš„ id ä» ç”¨æˆ·-è§’è‰²è¡¨ ä¸­è·å–è¯¥ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²

  > é¡¹ç›®è‡³æ­¤ï¼Œ**æˆ‘ä»¬å°†è¦å–æ¶ˆä¹‹å‰å†™çš„ç™»å½•æ‹¦æˆªï¼Œæ”¹ä¸ºå½“ç”¨æˆ·è¿›å…¥ä¸ªäººä¸­å¿ƒçš„æ—¶å€™ï¼Œæ‰è¿›è¡Œç™»å½•è®¤è¯**ï¼Œå¦‚æœç”¨æˆ·ç‚¹å‡»ä¸ªäººä¸­å¿ƒï¼Œä½†æ˜¯å¹¶æœªç™»å½•ï¼Œåˆ™è·³è½¬åˆ°ç™»å½•ç•Œé¢ã€‚
  >
  > ä¹‹å‰æˆ‘ä»¬åšç™»å½•æ‹¦æˆªçš„æ—¶å€™ï¼Œé‡‡ç”¨çš„æ˜¯<u>åç«¯æ‹¦æˆªå™¨+Vueå…¨å±€å‰ç½®å®ˆå«</u>çš„æ–¹æ³•ï¼Œä¹‹åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ **Shiro çš„è‡ªå®šä¹‰è¿‡æ»¤å™¨**å…¨é¢æ›¿ä»£åç«¯æ‹¦æˆªå™¨ï¼Œå®ç°**åŸºäº URL çš„åŠ¨æ€æƒé™æ§åˆ¶**ã€‚

  

- æ ¹æ® è§’è‰²-èœå•è¡¨ï¼ŒæŸ¥è¯¢è¯¥ç”¨æˆ·èƒ½å¤Ÿçœ‹è§å“ªäº›èœå•é¡¹ï¼š

  å½“ç„¶ï¼Œä»æ•°æ®åº“ä¸­æŸ¥å‡ºæ¥çš„èœå•é¡¹åªæ˜¯ä¸€äº›æ²¡æœ‰è§„å¾‹çš„æ•°æ®è€Œå·²ã€‚å‰ç«¯è·å–åç«¯æŸ¥è¯¢å‡ºæ¥çš„èœå•é¡¹æ•°æ®åï¼Œæ ¹æ®å±æ€§ `parent_id` ç†æ¸…å„èœå•é¡¹ä¹‹é—´çš„å±‚çº§å…³ç³»ï¼Œç„¶åæœ‰åºçš„æ¸²æŸ“åœ¨ç•Œé¢ä¸Š

  

- æ ¹æ® è§’è‰²-æƒé™è¡¨ï¼ŒæŸ¥è¯¢è¯¥ç”¨æˆ·å¯¹åº”çš„è§’è‰²æ‹¥æœ‰å“ªäº›åç«¯æ¥å£æƒé™ï¼Œå³è¯¥ç”¨æˆ·å®é™…ä¸Šèƒ½å¤Ÿè¿›è¡Œå“ªäº›æ“ä½œã€‚æ¯”å¦‚è¯´è§’è‰² 1 æ‹¥æœ‰æƒé™  `/api/user/user`ï¼Œå°±è¯´æ˜è¯¥è§’è‰²å¯ä»¥è®¿é—®åç«¯æ–¹æ³• `@RequestMapping(/api/admin/user)`

## 4. åˆ é™¤ç™»å½•æ‹¦æˆª

ğŸ‘ **ç°åœ¨å°±åˆ é™¤ç™»å½•æ‹¦æˆªçš„ç›®çš„éå¸¸ niceï¼Œå°±æ˜¯ä¸ºäº†é¿å…æ¥ä¸‹æ¥å‡ºç°å„ç§å„æ ·çš„å¤æ€ªé—®é¢˜**ã€‚

ä¹‹å‰æˆ‘ä»¬åœ¨åšç™»å½•æ‹¦æˆªçš„æ—¶å€™ä½¿ç”¨äº†Shiro åŸºäº `Interceptor` çš„ç™»å½•æ‹¦æˆªï¼Œä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†é€šè¿‡ Shiro çš„è‡ªå®šä¹‰è¿‡æ»¤å™¨ï¼Œå®ç°ç‚¹å‡»ä¸ªäººä¸­å¿ƒæ—¶å€™çš„ç™»å½•æ‹¦æˆªï¼ˆå°†å›¾ä¹¦é¦†ç­‰æ¨¡å—ä½œä¸ºæ— éœ€ç™»å½•çš„å‰å°ï¼Œå½“ç”¨æˆ·ç‚¹å‡»ä¸ªäººä¸­å¿ƒçš„æ—¶å€™ï¼Œæ‰ä¼šå»è¿›è¡Œç™»å½•æ‹¦æˆªã€‚è¿™æ ·æ›´ç¬¦åˆå®é™…æƒ…å†µï¼‰ï¼Œä»¥åŠåŸºäº URL çš„æƒé™æ§åˆ¶ã€‚

æ—©æ™šéƒ½è¦åˆ ï¼Œä¸å¦‚ç°åœ¨åˆ  ğŸ‰

é¦–å…ˆåœ¨ `MyWebConfig` ä¸­åˆ é™¤æ‹¦æˆªå™¨é…ç½®ä»£ç ï¼š

```java
//    åˆ äº†åˆ äº†
//    @Override
//    public void addInterceptors(InterceptorRegistry registry) {
//        registry.addInterceptor(getLoginInterceptor())
//                .addPathPatterns("/**")
//                .excludePathPatterns("/api/register")
//                .excludePathPatterns("/api/login")
//                .excludePathPatterns("/api/logout")
//    }
```

ç„¶ååˆ é™¤ `LoginInterceptor` ç±»ï¼ˆæˆ–è€…ç›´æ¥åˆ é™¤ packageï¼‰ã€‚åšå®Œè¿™ä»¶äº‹æˆ‘ç¥æ¸…æ°”çˆ½ ğŸ˜„ï¼Œå› ä¸ºè¯´å®è¯é‡åˆ°çš„è·¨åŸŸé—®é¢˜ç™¾åˆ†ä¹‹å…«åéƒ½æ˜¯è¿™ç©æ„å„¿æ²¡å†™å¥½é€ æˆçš„ã€‚ã€‚ã€‚

å‰ç«¯è·¯ç”±åŒæ ·éœ€è¦ç¨ä½œä¿®æ”¹ï¼š

```js
{
  path: "/index",
  name: "Index",
  component: Index,
  // meta: {
  //   requireAuth: true
  // }
},
{
  path: '/library',
  name: 'Library',
  component: LibraryIndex,
  // meta: {
    // requireAuth: true
  // }
},
```

## 5. DAO å±‚

å¯¹åº”ä¸Šé¢æ–°å»ºçš„å®ä½“ç±»æ·»åŠ  DAOï¼š

### â‘  AdminRoleDAO

`AdminRoleDAO`ï¼šæ“ä½œè¡¨ `admin_role`

```java
@Repository
public interface AdminRoleDAO extends JpaRepository<AdminRole,Integer> {
    Optional<AdminRole> findById(Integer id); // æ ¹æ® id æŸ¥æ‰¾è§’è‰² AdminRole
}
```

ğŸš¨ æ³¨æ„ï¼šJPA å°†è¿™ä¸ª æ–¹æ³•å¼ºè½¬æˆäº† `Optional` è¿”å›ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `Optional` çš„ `get` æ–¹æ³•è·å–å¯¹è±¡å®ä¾‹ï¼š

```java
Optional<AdminRole> adminRole = adminRoleDAO.findById(role.getId());
AdminRole roleInDB = adminRole.get(); // Optional çš„å¯¹è±¡è¿”å›å€¼ä¸ºå¸ƒå°”ç±»å‹ï¼Œä¸”è¯¥å¯¹è±¡æœ‰ä¸ªgetæ–¹æ³•ï¼Œå¯ä»¥è·å–è¯¥å¯¹è±¡çš„å®ä¾‹
```

### â‘¡ AdminPermissionDAO

`AdminPermissionDAO`ï¼šæ“ä½œè¡¨ `admin_permission`

```java
@Repository
public interface AdminPermissionDAO extends JpaRepository<AdminPermission, Integer> {
    AdminPermission findById(Integer id);
    List<AdminPermission> findAllByIdIn(List<Integer> ids);
}
```

ğŸš¨ **æ³¨æ„ä¸Šé¢çš„ `findAllByRidIn` æ–¹æ³•ï¼šç›¸å½“äº `select *from admin_permission where id in ids`**

### â‘¢ AdminMenuDAO

`AdminMenuDAO`ï¼šæ“ä½œè¡¨ `admin_menu`

```java
@Repository
public interface AdminMenuDAO extends JpaRepository<AdminMenu,Integer> {

    Optional<AdminMenu> findById(Integer id); // æ ¹æ® id æŸ¥æ‰¾ èœå• AdminMenu
    List<AdminMenu> findAllByParentId(Integer parentId); // æ ¹æ®çˆ¶èŠ‚ç‚¹ parentId æŸ¥æ‰¾ èœå• AdminMenu
}
```

### â‘£ AdminUserRoleDAO

`AdminUserRoleDAO`ï¼šæ“ä½œè¡¨ `admin_user_role`

```java
@Repository
public interface AdminUserRoleDAO extends JpaRepository<AdminUserRole,Integer> {

    List<AdminUserRole> findAllByUid(Integer uid); // æŸ¥æ‰¾è¯¥ç”¨æˆ· id å¯¹åº”çš„æ‰€æœ‰ç”¨æˆ·-è§’è‰²å…³ç³»
    void deleteAllByUid(Integer uid); // åˆ é™¤è¯¥ç”¨æˆ· id å¯¹åº”çš„æ‰€æœ‰ç”¨æˆ·-è§’è‰²å…³ç³»
}
```

### â‘¤ AdminRolePermissionDAO

`AdminRolePermissionDAO`ï¼šæ“ä½œè¡¨ `admin_role_permission`

```java
@Repository
public interface AdminRolePermissionDAO extends JpaRepository<AdminRolePermission, Integer> {
    List<AdminRolePermission> findAllByRid(Integer rid);
    List<AdminRolePermission> findAllByRidIn(List<Integer> rids);
    void deleteAllByRid(int rid);
}
```

### â‘¥ AdminRoleMenuDAO

`AdminRoleMenuDAO`ï¼šæ“ä½œè¡¨ `admin_role_menu`

```java
@Repository
public interface AdminRoleMenuDAO extends JpaRepository<AdminRoleMenu,Integer> {

    List<AdminRoleMenu> findAllByRid(Integer rid); // æŸ¥æ‰¾è¯¥è§’è‰² id å¯¹åº”çš„æ‰€æœ‰è§’è‰²-èœå•å…³ç³»
    List<AdminRoleMenu> findAllByRidIn(List<Integer> rids); // æŸ¥æ‰¾è¿™äº›è§’è‰² id é›†åˆå¯¹åº”çš„æ‰€æœ‰è§’è‰²-èœå•å…³ç³»
    void deleteAllByRid(Integer rid); // åˆ é™¤è¯¥è§’è‰² id å¯¹åº”çš„æ‰€æœ‰è§’è‰²-èœå•å…³ç³»

}
```

## 6. Service å±‚

> åŠ¨æ€åŠ è½½åå°èœå•å¹¶ä¸éœ€è¦æƒé™ä¿¡æ¯ï¼Œæ‰€ä»¥ `AdminPermissionService` å’Œ `AdminRolePermissionService` æš‚æ—¶ä¸å¿…å®ç°ï¼Œåœ¨ä¸‹ä¸€ç« å®ç°åŸºäº URL çš„åŠ¨æ€æƒé™æ§åˆ¶å†å®ç°ã€‚

### â‘  AdminUserRoleService

é¦–å…ˆï¼Œè®¾è®¡ `AdminUserRoleService`ï¼Œå®ç°æ ¹æ®ç”¨æˆ· id æŸ¥è¯¢è¯¥ç”¨æˆ·å¯¹åº”çš„æ‰€æœ‰ ç”¨æˆ·-è§’è‰²å…³ç³» `AdminUserRole`ï¼š

```java
@Service
public class AdminUserRoleService {

    @Autowired
    AdminUserRoleDAO adminUserRoleDAO;

    // æ ¹æ®ç”¨æˆ· id æŸ¥è¯¢è¯¥ç”¨æˆ·å¯¹åº”çš„æ‰€æœ‰ ç”¨æˆ·-è§’è‰²å…³ç³»
    public List<AdminUserRole> listAllByUid(Integer uid){
        return adminUserRoleDAO.findAllByUid(uid);
    }
}
```

### â‘¡ AdminRoleMenuService

æ¥ç€ï¼Œè®¾è®¡ `AdminRoleMenuService`ï¼Œå®ç°æ ¹æ®è§’è‰² id æŸ¥è¯¢è¯¥è§’è‰²å¯¹åº”çš„èœå•ï¼š

```java
@Service
public class AdminRoleMenuService {

    @Autowired
    AdminRoleMenuDAO adminRoleMenuDAO;

    // æ ¹æ®è§’è‰² id æŸ¥è¯¢è¯¥è§’è‰²å¯¹åº”çš„èœå•
    public List<AdminRoleMenu> findAllByRid(Integer rid){
        return  adminRoleMenuDAO.findAllByRid(rid);
    }
	
    // ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²
    public List<AdminRoleMenu> findAllByRids(List<Integer> rids){
        return  adminRoleMenuDAO.findAllByRidIn(rids);
    }
}
```

### â‘¢ AdminRoleService

`AdminRoleService` å®ç°æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢è¯¥ç”¨æˆ·æ‹¥æœ‰çš„è¯¦ç»†è§’è‰²ä¿¡æ¯ï¼š

```java
@Service
public class AdminRoleService {
    @Autowired
    AdminRoleDAO adminRoleDAO;
    @Autowired
    UserService userService;
    @Autowired
    AdminUserRoleService adminUserRoleService;

    // æŸ¥è¯¢è¯¥ç”¨æˆ·å¯¹åº”çš„è§’è‰²ä¿¡æ¯ AdminRole
    public List<AdminRole> listRolesByUser(String username) {
        int uid = userService.getByName(username).getId();
        List<Integer> rids = new ArrayList<>();
        List<AdminUserRole> adminUserRoles = adminUserRoleService.listAllByUid(uid); // æŸ¥è¯¢è¯¥ç”¨æˆ·å¯¹åº”çš„ç”¨æˆ·-è§’è‰²å…³ç³»
        for(AdminUserRole adminUserRole: adminUserRoles){
            rids.add(adminUserRole.getRid()); // è·å–è¯¥ç”¨æˆ·-æƒé™å…³ç³»ä¸­çš„è§’è‰² id
        }
        return adminRoleDAO.findAllById(rids); // æ ¹æ®è§’è‰²id æŸ¥è¯¢è¯¦ç»†è§’è‰²ä¿¡æ¯ AdminRole
    }
}
```

> â“ å¯èƒ½æœ‰äº›å°ä¼™ä¼´æœ‰äº›ç–‘æƒ‘ï¼Œä¸ºå•¥æ­¤å¤„ `adminRoleDAO.findAllById(rids)` ç”¨çš„ `findAllById(rids)` ä¸ç”¨æˆ‘ä»¬åœ¨ DAO å±‚ä¸­å†™ï¼Œè€Œä¸Šé¢çš„ ` adminRoleMenuDAO.findAllByRidIn(rids)` ä¸­ç”¨çš„ `findAllByRidIn(rids)`  å°±éœ€è¦æˆ‘ä»¬åœ¨ DAO å±‚ä¸­å†™å‡ºæ¥ï¼Œè¿˜è¦åŠ ä¸Šä¸€ä¸ª `In` åç¼€ã€‚
>
> é“ç†å¾ˆç®€å•ï¼Œä¸€ä¸ª `rid` ä»…å¯¹åº”ä¸€ä¸ª `AdminRole`ï¼Œè€Œä¸€ä¸ª `rid` å¯ä»¥å¯¹åº”å¤šä¸ª `AdminRoleMenu`ï¼Œæ‰€ä»¥åè€…çš„è§„åˆ™æ¯”è¾ƒç‰¹åˆ«ã€‚

### â‘£ AdminMenuService

æ¥ä¸‹æ¥é‡å¤´æˆ `AdminMenuService` ï¼Œä¸»è¦å®ç°æŸ¥è¯¢å½“å‰ç”¨æˆ·å¯¹åº”çš„èœå•é¡¹ï¼Œå¹¶ä¸”æŠŠæŸ¥è¯¢å‡ºæ¥çš„èœå•åˆ—è¡¨æ•´åˆæˆå…·æœ‰å±‚çº§å…³ç³»çš„èœå•æ ‘ã€‚æ•´åˆçš„æ€è·¯å¦‚ä¸‹ï¼š

- éå†èœå•é¡¹ï¼Œæ ¹æ®æ¯ä¸€é¡¹çš„ id æŸ¥è¯¢è¯¥é¡¹å‡ºæ‰€æœ‰çš„å­é¡¹ï¼Œå¹¶æ”¾è¿› children å±æ€§

- å‰”é™¤æ‰æ‰€æœ‰å­é¡¹ï¼Œåªä¿ç•™ç¬¬ä¸€å±‚çš„çˆ¶é¡¹ã€‚æ¯”å¦‚ c æ˜¯ b çš„å­é¡¹ï¼Œb æ˜¯ a çš„å­é¡¹ï¼Œæˆ‘ä»¬æœ€ååªè¦ä¿ç•™ a å°±è¡Œï¼Œå› ä¸º a åŒ…å«äº† b å’Œ cï¼ˆ**åœ¨ Java é‡Œå¯¹è±¡éƒ½æ˜¯å¼•ç”¨ç±»å‹ï¼Œå‡è®¾æˆ‘ä»¬æŠŠ b æ”¾è¿›äº† a çš„ children é‡Œï¼ŒåˆæŠŠ c æ”¾è¿›äº† b çš„ children é‡Œï¼Œé‚£ä¹ˆ c å°±è¢«æ”¾è¿›äº† a çš„ children çš„ children é‡Œã€‚å› æ­¤ï¼Œç»è¿‡ä¸€æ¬¡éå†ï¼Œå°±èƒ½å¾—åˆ°æ­£ç¡®çš„å±‚çº§å…³ç³»**ï¼‰

  <img src="https://gitee.com/veal98/images/raw/master/img/20200824202705.png" style="zoom: 80%;" />

âœ è¯¦ç»†ä»£ç å¦‚ä¸‹ï¼š

```java
@Service
public class AdminMenuService {

    @Autowired
    AdminMenuDAO adminMenuDAO;
    @Autowired
    AdminUserRoleService adminUserRoleService;
    @Autowired
    AdminRoleMenuService adminRoleMenuService;
    @Autowired
    UserService userService;

    // æ ¹æ®èœå•é¡¹çš„çˆ¶èŠ‚ç‚¹ id æŸ¥è¯¢å®ƒçš„æ‰€æœ‰å­èŠ‚ç‚¹èœå•
    public List<AdminMenu> getAllByParentId(Integer parentId){
        return adminMenuDAO.findAllByParentId(parentId);
    }

    // æ ¹æ®è§’è‰² id æŸ¥è¯¢å¯¹åº”çš„æœ‰åºèœå•é¡¹
    public List<AdminMenu> getMenusByRoleId(int rid) {
        List<Integer> menuIds = new ArrayList<>();
        // æ ¹æ®è§’è‰² id æŸ¥è¯¢è§’è‰²â€”èœå•å…³ç³»
        List<AdminRoleMenu> adminRoleMenus = adminRoleMenuService.findAllByRid(rid);
        for(AdminRoleMenu adminRoleMenu: adminRoleMenus){
            menuIds.add(adminRoleMenu.getMid()); // è·å–è§’è‰²å¯¹åº”çš„èœå• id
        }
        // æ ¹æ®èœå• id è·å–èœå•è¯¦ç»†ä¿¡æ¯
        List<AdminMenu> menus = adminMenuDAO.findAllById(menuIds);

        // å°†æŸ¥è¯¢å‡ºæ¥çš„èœå•é¡¹æ•´åˆæˆæœ‰åºçš„èœå•åˆ—è¡¨
        handleMenus(menus);

        return menus;
    }

    // è·å–å½“å‰ç”¨æˆ·å¯¹åº”çš„æœ‰åºèœå•é¡¹
    public List<AdminMenu> getMenusByCurrentUser(){
        // åˆ©ç”¨ Shiro ä»æ•°æ®åº“ä¸­è·å–å½“å‰ç”¨æˆ·
        String username = SecurityUtils.getSubject().getPrincipal().toString();
        User user = userService.getByName(username);

        // æ ¹æ®ç”¨æˆ· id è·å–ç”¨æˆ·-è§’è‰²å…³ç³»
        List<AdminUserRole> adminUserRoles = adminUserRoleService.listAllByUid(user.getId());
        List<Integer> rids = new ArrayList<>();
        for(AdminUserRole adminUserRole : adminUserRoles){
            rids.add(adminUserRole.getRid()); // è·å–å½“å‰ç”¨æˆ·å¯¹åº”çš„è§’è‰² id
        }
        System.out.println(username + " å¯¹åº”çš„è§’è‰²: " + rids);


        // æ ¹æ®è§’è‰² id è·å–è§’è‰²â€”èœå•å…³ç³»
        List<AdminRoleMenu> adminRoleMenus = adminRoleMenuService.findAllByRids(rids);
        List<Integer> mids = new ArrayList<>();
        for(AdminRoleMenu adminRoleMenu: adminRoleMenus){
            mids.add(adminRoleMenu.getMid()); // è·å–å½“å‰è§’è‰²å¯¹åº”çš„èœå• id
        }
        System.out.println(rids + " å¯¹åº”çš„èœå•: " + mids);

        // æ ¹æ®èœå• id æŸ¥è¯¢èœå•è¯¦ç»†ä¿¡æ¯
        // é€šè¿‡ distinct() å¯¹æŸ¥è¯¢å‡ºçš„èœå•é¡¹è¿›è¡Œäº†å»é‡æ“ä½œï¼Œé¿å…å¤šè§’è‰²æƒ…å†µä¸‹æœ‰å†—ä½™çš„èœå•ç­‰ã€‚
        List<AdminMenu> adminMenus = adminMenuDAO.findAllById(mids).stream().distinct().collect(Collectors.toList());

        // å¤„ç†èœå•é¡¹çš„ç»“æ„
        handleMenus(adminMenus);
        
        return adminMenus;
    }

    // æŠŠæŸ¥è¯¢å‡ºæ¥çš„èœå•åˆ—è¡¨æ•´åˆæˆå…·æœ‰å±‚çº§å…³ç³»çš„èœå•æ ‘
    private void handleMenus(List<AdminMenu> adminMenus) {
        // æ ¹æ®æ¯ä¸€é¡¹çš„ id æŸ¥è¯¢å‡ºè¯¥é¡¹çš„æ‰€æœ‰å­é¡¹ï¼Œå¹¶æ”¾è¿› children å±æ€§
        for(AdminMenu adminMenu: adminMenus){
            List<AdminMenu> children = getAllByParentId(adminMenu.getId());
            adminMenu.setChildren(children);
        }

        // å‰”é™¤æ‰æ‰€æœ‰å­é¡¹ï¼Œåªä¿ç•™ç¬¬ä¸€å±‚çš„çˆ¶é¡¹
        Iterator<AdminMenu> iterator = adminMenus.iterator();
        while(iterator.hasNext()){
            AdminMenu menu = iterator.next();
            if(menu.getParent_id() != 0){
                // remove æ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯æŠŠå¯¹è±¡åæŒ‡å‘äº† nullï¼Œè€Œå¯¹è±¡æœ¬èº«ä»ç„¶å­˜åœ¨ã€‚
                // æ¯”å¦‚ c æ˜¯ b çš„å­é¡¹ï¼Œb æ˜¯ a çš„å­é¡¹ï¼Œè™½ç„¶æˆ‘ä»¬æ— æ³•å†é€šè¿‡ bã€c è·å–åˆ°åŸæ¥çš„å¯¹è±¡ï¼Œä½† a é‡Œé¢çš„ä¿¡æ¯æ˜¯ä¸ä¼šå˜çš„ã€‚
                iterator.remove();
            }
        }
    }

}
```

â“ **ä¸ºä»€ä¹ˆåˆ é™¤å­é¡¹æ—¶ç”¨ `iterator.remove()` è€Œä¸ç”¨ `List` çš„ `remove` æ–¹æ³•å‘¢ï¼Ÿ**

å› ä¸ºä½¿ç”¨ `List` éå†æ—¶ï¼Œå¦‚æœåˆ é™¤äº†æŸä¸€ä¸ªå…ƒç´ ï¼Œåé¢çš„å…ƒç´ ä¼šè¡¥ä¸Šæ¥ï¼Œä¹Ÿå°±æ˜¯è¯´åé¢å…ƒç´ çš„ç´¢å¼•å’Œåˆ—è¡¨é•¿åº¦éƒ½ä¼šå‘ç”Ÿæ”¹å˜ã€‚ä½†å¾ªç¯æ¬¡æ•°ä¸å˜ï¼Œä»æ˜¯æœ€åˆçš„åˆ—è¡¨é•¿åº¦ï¼Œè¿™æ ·æ—¢ä¼šæ¼æ‰ä¸€äº›å…ƒç´ ï¼Œåˆä¼šå‡ºç°ä¸‹æ ‡æº¢å‡ºï¼Œè¿è¡Œæ—¶è¡¨ç°å°±æ˜¯ä¼šæŠ¥ `ConcurrentModificationException`ã€‚è€Œ `iterator.remove()` è¿›è¡Œäº†ä¸€äº›å°è£…ï¼Œä¼šæŠŠå½“å‰ç´¢å¼•å’Œå¾ªç¯æ¬¡æ•°å‡ 1ï¼Œä»è€Œé¿å…äº†è¿™ä¸ªé—®é¢˜ã€‚

## 7. Controller å±‚

`AdminController` ä¸­æ ¹æ®è¯·æ±‚è°ƒç”¨æŸ¥è¯¢èœå•é¡¹é€»è¾‘ï¼š

```java
@Controller
public class  {

    @Autowired
    AdminMenuService adminMenuService;

    @Autowired
    UserService userService;

    @GetMapping("/api/menu")
    @ResponseBody
    public List<AdminMenu> menu() {
        return adminMenuService.getMenusByCurrentUser();
    }

}
```

å®Œæˆåå¯ä»¥æµ‹è¯•ä¸‹ menu æ¥å£ã€‚åœ¨æ­¤ä¹‹å‰è¦å…ˆç™»å½•ï¼Œç„¶åè®¿é—® [localhost:8082/api/menu](localhost:8082/api/menu)

![](https://gitee.com/veal98/images/raw/master/img/20200824213704.png)

## 8. å‰ç«¯å®ç°

### â‘  å‰ç«¯ç•Œé¢

ğŸš¨ **æ³¨æ„**ï¼šå‰ç«¯ Vue ç•Œé¢çš„è·¯å¾„ã€åç§°ã€nameã€è·¯ç”±ç­‰ç›¸å…³é…ç½®æŒ‰ç…§æ•°æ®åº“ä¸­ä¿å­˜çš„æ¥å°±è¡Œäº†ï¼š

![](https://gitee.com/veal98/images/raw/master/img/20200824214640.png)

å…¶ä»–çš„ä¸æ˜¯é‡ç‚¹ï¼Œ`AdminIndex` æˆ‘å°†å®ƒä½œä¸ºä¸ªäººä¸­å¿ƒéƒ¨åˆ†æ‰€æœ‰ç•Œé¢çš„æ¨¡æ¿ï¼š

```vue
<template>
  <div>
    <el-container id="admin-body" style = "height: 95vh; border: 1px solid #eee">
      
      <el-aside style="height: 100%;width: 250px;">
        <AdminMenu></AdminMenu>
      </el-aside>
      <el-main>
        <router-view/>
      </el-main>
    </el-container>
  </div>
</template>

<script>

  import AdminMenu from './AdminMenu'
  // import NavBar from '../common/NavBar'

  export default {
    name: 'AdminIndex',
    components: {AdminMenu},
    data () {
      return {
        dialogVisible: false
      }
    },
  }
</script>

<style scoped>

</style>
```

é‡Œé¢åµŒå…¥äº†ä¸€ä¸ª `AdminMenu` èœå•æ ç»„ä»¶ï¼š

```vue
<template>
  <el-menu
    :default-active="currentPath"
    class="el-menu-admin"
    router
    mode="vertical"
    background-color="rgb(238, 241, 246)"
    text-color="black"
    active-text-color="rgb(65, 184, 131)"
    :collapse="isCollapse">
    <div style="height: 30px;"></div>
      <!--index æ²¡æœ‰ç”¨ä½†æ˜¯å¿…éœ€å­—æ®µ-->
      <el-submenu  v-for="(item,i) in adminMenus" :key="i" :index="(i).toString()" style="text-align: left">
        <span slot="title" style="font-size: 17px;">
          <i :class="item.iconCls"></i>
          {{item.nameZh}}
        </span>
        <el-menu-item v-for="child in item.children" :key="child.path" :index="child.path">
          <i :class="child.icon"></i>
          {{ child.nameZh }}
        </el-menu-item>
      </el-submenu>
  </el-menu>
</template>

<script>
    export default {
      name: 'AdminMenu',
      data () {
        return {
          isCollapse: false
        }
      },
      computed: {
        adminMenus () {
          return this.$store.state.adminMenus
        },
        currentPath () {
          return this.$route.path
        }
      }
    }
</script>

<style scoped>
  .el-menu-admin {
    border-radius: 5px;
    height: 100%;
  }
</style>
```

**è¯¥ç»„ä»¶ä» `store` çš„ `adminMenus` ä¸­å–å€¼ï¼Œ`adminMenus` ä»£è¡¨ç»è¿‡å‰ç«¯å¤„ç†åçš„èœå•åˆ—è¡¨**ï¼š(`store/index.js`)

```js
export default new Vuex.Store({
  state: {
    // è®°å½•ç”¨æˆ·ä¿¡æ¯
    user: {
      username:
        window.localStorage.getItem("user" || "[]") == null
          ? ""
          : JSON.parse(window.localStorage.getItem("user" || "[]")).username,
    },
    adminMenus: []
  },
  mutations: {
    // è§¦å‘è¿™ä¸ªæ–¹æ³•æ—¶å¯ä»¥ä¸ºæˆ‘ä»¬çš„ç”¨æˆ·å¯¹è±¡èµ‹å€¼
    login(state, user) {
      state.user = user
      window.localStorage.setItem("user", JSON.stringify(user))
    },
    // è§¦å‘è¿™ä¸ªæ–¹æ³•æ—¶å¯ä»¥ç§»é™¤è¯¥ç”¨æˆ·
    logout(state){
      // æ³¨æ„ä¸èƒ½ç”¨ null æ¸…é™¤ï¼Œå¦åˆ™å°†æ— æ³•åˆ¤æ–­ user é‡Œå…·ä½“çš„å†…å®¹
      state.user = []
      window.localStorage.removeItem("user")
      state.adminMenus = []
    },
    initAdminMenu(state,menus){
      state.adminMenus = menus
    }
  },
  actions: {},
  modules: {},
});
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œ**`store` ä¸­çš„ `adminMenus` é€šè¿‡ `initAdminMenu` æ–¹æ³•è¿›è¡Œèµ‹å€¼**ï¼Œè¯¦ç»†è§ä¸‹æ–‡ ğŸ‘‡

### â‘¡ æ•°æ®å¤„ç†

ä¹‹å‰æˆ‘ä»¬è®¾è®¡ `AdminMenu` è¡¨ï¼ŒåŒ…å«äº†å‰ç«¯è·¯ç”±ï¼ˆrouterï¼‰ä¸å¯¼èˆªèœå•éœ€è¦çš„ä¿¡æ¯ï¼Œä»åå°æ¥å£ `api/menu` ä¼ æ¥çš„èœå•åˆ—è¡¨æ•°æ®ï¼Œéœ€è¦è¢«æ•´ç†æˆè·¯ç”±èƒ½å¤Ÿè¯†åˆ«çš„æ ¼å¼ã€‚

![](https://gitee.com/veal98/images/raw/master/img/20200824114738.png)

è¿›è¡Œæ ¼å¼è½¬æ¢çš„æ–¹æ³•å¦‚ä¸‹ï¼ˆå†™åœ¨ `main.js` ä¸­ï¼‰ï¼š

```js
// å°†åå°ä¼ è¿‡æ¥çš„èœå•åˆ—è¡¨ routesï¼ˆapi/menuï¼‰è½¬æ¢æˆè·¯ç”±èƒ½å¤Ÿè¯†åˆ«çš„æ¨¡å¼
const formatRoutes = (routes) => {
  let fmtRoutes = []
  routes.forEach(route => {
    // é¦–å…ˆåˆ¤æ–­ä¸€æ¡èœå•é¡¹æ˜¯å¦å«å­é¡¹ï¼Œå¦‚æœå«åˆ™è¿›è¡Œé€’å½’å¤„ç†ã€‚
    if (route.children) {
      route.children = formatRoutes(route.children)
    }

    // æ¯ä¸ªèœå•é¡¹çš„è¯¦ç»†ä¿¡æ¯
    let fmtRoute = {
      path: route.path,
      component: resolve => {
        require(['./components/admin/' + route.component + '.vue'], resolve)
      },
      name: route.name,
      nameZh: route.nameZh,
      iconCls: route.iconCls,
      meta: {
        requireAuth: true
      },
      children: route.children
    }
    fmtRoutes.push(fmtRoute)
  })
  return fmtRoutes
}
```

### â‘¢ æ·»åŠ è·¯ç”±

OKï¼Œ**å°†åå°æ•°æ®å¤„ç†æˆè·¯ç”±èƒ½å¤Ÿè¯†åˆ«çš„æ ¼å¼ä¹‹åï¼Œæˆ‘ä»¬å°±å¼€å§‹å‘èœå•åˆ—è¡¨ `adminMenus`  å’Œè·¯ç”±è¡¨  `router` ä¸­æ·»åŠ ä¿¡æ¯**ï¼šï¼ˆåœ¨ `main.js` ä¸­ï¼‰

```js
// initAdminMenu ç”¨äºæ‰§è¡Œè¯·æ±‚ï¼Œè°ƒç”¨æ ¼å¼åŒ–æ–¹æ³• formatRoutes å¹¶å‘è·¯ç”±è¡¨ä¸­æ·»åŠ ä¿¡æ¯
const initAdminMenu = (router, store) => {
  // é˜²æ­¢é‡å¤è§¦å‘åŠ è½½èœå•æ“ä½œ
  if (store.state.adminMenus.length > 0) {
    return
  }
  axios.get('/menu').then(resp => {
    if (resp && resp.status === 200) {
      var fmtRoutes = formatRoutes(resp.data)
      router.addRoutes(fmtRoutes)
      store.commit('initAdminMenu', fmtRoutes) // å‘é€ç»™ store
    }
  })
}
```

### â‘£ å…¨å±€å‰ç½®å®ˆå«

æˆ‘ä»¬è¦æ€è€ƒä¸€ä¸‹ä»€ä¹ˆæ—¶å€™éœ€è¦å»è¯·æ±‚åç«¯æ¥å£å¹¶æ¸²æŸ“èœå•ã€‚å¦‚æœè®¿é—®æ¯ä¸ªé¡µé¢éƒ½åŠ è½½ä¸€æ¬¡ï¼Œæœ‰ç‚¹å¤ªæµªè´¹äº†ã€‚å¦‚æœåªåœ¨åå°ä¸»é¡µé¢æ¸²æŸ“æ—¶åŠ è½½ä¸€æ¬¡ï¼Œé‚£ä¹ˆå°±ä¸èƒ½åœ¨å­é¡µé¢ä¸­è¿›è¡Œåˆ·æ–°æ“ä½œã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥ç»§ç»­åˆ©ç”¨è·¯ç”±å…¨å±€å®ˆå«ï¼Œ**åœ¨ç”¨æˆ·å·²ç™»å½•ä¸”è®¿é—®ä»¥ `/admin` å¼€å¤´çš„è·¯å¾„æ—¶è¯·æ±‚èœå•ä¿¡æ¯**ï¼Œå®Œæ•´çš„ä»£ç å¦‚ä¸‹ï¼ˆ`main.js`)ï¼š

```js
// router.beforeEach åœ¨è®¿é—®æ¯ä¸€ä¸ªè·¯ç”±å‰è°ƒç”¨
router.beforeEach((to, from, next) => {
  // åœ¨ç”¨æˆ·å·²ç™»å½•ä¸”è®¿é—®ä»¥ /admin å¼€å¤´çš„è·¯å¾„æ—¶è¯·æ±‚èœå•ä¿¡æ¯
  if(store.state.user.username && to.path.startsWith('/admin')) {
    initAdminMenu(router, store)
  }
  
  // åˆ¤æ–­è¯¥è·¯å¾„æ˜¯å¦éœ€è¦è¿›è¡Œæ‹¦æˆª
  if (to.meta.requireAuth) {
    if (store.state.user) { // åˆ¤æ–­ store é‡Œæœ‰æ²¡æœ‰å­˜å‚¨ user çš„ä¿¡æ¯
      // æ¯è®¿é—®ä¸€ä¸ªé¡µé¢å°±å‘åç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œç›®çš„æ˜¯ç»ç”±åç«¯æ‹¦æˆªå™¨éªŒè¯æœåŠ¡å™¨ç«¯çš„ç™»å½•çŠ¶æ€ï¼Œé˜²æ­¢ä¼ªé€ å‚æ•°ç»•è¿‡å…¨å±€å‰ç½®å®ˆå«
      axios.get('/authentication').then(resp => {
        if(resp.data)
          next() // æ”¾è¡Œ
        else{
          // å¦åˆ™è·³è½¬åˆ°ç™»å½•ç•Œé¢, å¹¶å­˜å‚¨è®¿é—®çš„é¡µé¢è·¯å¾„ï¼ˆä»¥ä¾¿åœ¨ç™»å½•åè·³è½¬åˆ°è®¿é—®é¡µï¼‰
          next({
            path: "login",
            query:{
              redirect: to.fullPath
            }
          })
        }
      })
    } 
    else {
      // è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œå¹¶å­˜å‚¨è®¿é—®çš„é¡µé¢è·¯å¾„ï¼ˆä»¥ä¾¿åœ¨ç™»å½•åè·³è½¬åˆ°è®¿é—®é¡µï¼‰
      next({
        path: 'login',
        query: {redirect: to.fullPath}
      })
    }
  } else {
    next()
  }

})
```

OKï¼Œæ’’èŠ± ğŸ‰ï¼Œæµ‹è¯•ä¸€ä¸‹ä¸åŒçš„è§’è‰²çœ‹åˆ°çš„èœå•åˆ—è¡¨æ˜¯ä¸åŒçš„

## 9. âœ… Next

ç»ˆäºç»“æŸäº†ï¼Œè¿™ç« å®åœ¨æ˜¯çƒ§è„‘ï¼Œå‘å¤ªå¤šäº†ï¼Œç™¾åº¦éƒ½ç¿»çƒ‚äº†ã€‚æœ¬èŠ‚ä¸­æˆ‘ä»¬å»æ‰äº†Shiro åŸºäº `Interceptor` çš„ç™»å½•æ‹¦æˆªï¼Œä¸‹ä¸€èŠ‚å°†é€šè¿‡ Shiro çš„è‡ªå®šä¹‰è¿‡æ»¤å™¨ï¼Œå®ç°ç‚¹å‡»ä¸ªäººä¸­å¿ƒæ—¶å€™çš„ç™»å½•æ‹¦æˆªï¼Œä»¥åŠåŸºäº URL çš„æƒé™æ§åˆ¶ã€‚

## ğŸ“š References

- [Vue + Spring Boot é¡¹ç›®å®æˆ˜ â€” ç™½å·](https://blog.csdn.net/Neuf_Soleil/article/details/88925013)
