# ğŸ† åå°ç•Œé¢å®Œå–„

---

## 1. å†…å®¹ç®¡ç†

### â‘  å›¾ä¹¦ç®¡ç†

ğŸ¨ æ•ˆæœå¦‚ä¸‹ï¼š

![](https://gitee.com/veal98/images/raw/master/img/20200829114519.png)

é¦–å½“å…¶å†²è‡ªç„¶å›¾ä¹¦ç®¡ç†ï¼Œä¹‹å‰æˆ‘ä»¬å·²ç»åšå¥½äº†ï¼Œåªéœ€è¦ç¨ä½œä¿®æ”¹ï¼Œå°†å‰å°çš„å›¾ä¹¦å¢åˆ æ”¹æ“ä½œç§»åˆ°å›¾ä¹¦ç®¡ç†ç•Œé¢å³å¯ ã€‚åˆ é™¤å‰å°çš„å›¾ä¹¦å¢åˆ æ”¹æ“ä½œå°±ä¸è¯´äº†ï¼Œç›´æ¥åˆ å°±è¡Œã€‚é‡ç‚¹çœ‹åå°ç®¡ç†ç•Œé¢ï¼šğŸ‘‡

é¦–å…ˆï¼Œå°†åŸå…ˆå†™å¥½çš„ä¿®æ”¹ç»„ä»¶  `EditForm`å’Œä¸Šä¼ ç»„ä»¶ `ImgUpload` æ”¾åˆ° `admin/content/book` è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢æ¥ï¼š

![](https://gitee.com/veal98/images/raw/master/img/20200829105933.png)

ğŸš¨ **åˆ«å¿˜äº†ç§»åŠ¨åå¯¹åº”çš„ç»„ä»¶å¯¼å…¥åœ°å€ä¹Ÿè¦ä¿®æ”¹**

`BookManagement.vue` å°±æ˜¯æˆ‘ä»¬å›¾ä¹¦ç®¡ç†çš„ä¸»ç•Œé¢ï¼š

å¯¹åº”çš„æ–¹æ³•éƒ½å®Œå…¨ä¸€æ ·ï¼Œåªä¸è¿‡å°†æ ·å¼æ”¹æˆäº†æµå¼å¸ƒå±€ï¼Œæ›´ç¬¦åˆåå°ç®¡ç†ç•Œé¢çš„æ“ä½œä¹ æƒ¯

```vue
<template>
  <div>
   
    <el-card style="margin: 18px 2%;width: 95%">

      <!-- å½“el-tableå…ƒç´ ä¸­æ³¨å…¥ data å¯¹è±¡æ•°ç»„åï¼Œ
      åœ¨ el-table-column ä¸­ç”¨ prop å±æ€§æ¥å¯¹åº”å¯¹è±¡ä¸­çš„é”®åå³å¯å¡«å…¥æ•°æ® -->
      <el-table
        :data="books"
        stripe
        style="width: 100%"
        :max-height="tableHeight">

        <!-- é€‰æ‹©æ¡† -->
        <!-- <el-table-column
          type="selection"
          width="55">
        </el-table-column> -->
        
        <el-table-column
          prop="title"
          label="ä¹¦å"
          fit>
        </el-table-column>

        <el-table-column
          prop="category.name"
          label="åˆ†ç±»"
          width="100">
        </el-table-column>

        <el-table-column
          prop="author"
          label="ä½œè€…"
          fit>
        </el-table-column>

        <el-table-column
          prop="date"
          label="å‡ºç‰ˆæ—¥æœŸ"
          width="120">
        </el-table-column>

        <el-table-column
          prop="press"
          label="å‡ºç‰ˆç¤¾"
          fit>
        </el-table-column>

        <el-table-column
          prop="abs"
          label="æ‘˜è¦"
          show-overflow-tooltip
          fit>
        </el-table-column>

        <el-table-column
          fixed="right"
          label="æ“ä½œ"
          width="120">
          <template slot-scope="scope">
            
            <el-button
              @click.native.prevent="editBook(scope.row)"
              type="text"
              size="small">
              ç¼–è¾‘
            </el-button>
            <el-button
              @click.native.prevent="deleteBook(scope.row.id)"
              type="text"
              size="small">
              ç§»é™¤
            </el-button>
          </template>
        </el-table-column>
      </el-table>
      <div style="margin: 0 0 30px 0;float: left">
        <!-- <el-button>å–æ¶ˆé€‰æ‹©</el-button>
        <el-button>æ‰¹é‡åˆ é™¤</el-button> -->

        <!-- æ·»åŠ å›¾ä¹¦ -->
        <edit-form @onSubmit="loadBooks()" ref="edit"></edit-form>
      </div>
      
    </el-card>
    

    <!-- åˆ†é¡µæ  -->
    <el-row >
      <el-pagination
        @current-change="handleCurrentChange"
        :current-page="currentPage"
        :page-size="pagesize"
        :total="books.length">
      </el-pagination>
    </el-row>

  </div>
</template>

<script>
  import EditForm from './book/EditForm'
  export default {
    name: 'BookManagement',
    components: {EditForm},
    data () {
      return {
        books: [],
        currentPage: 1,
        pagesize: 16
      }
    },
    mounted: function () {
      this.loadBooks()
    },
    computed: {
      tableHeight () {
        return window.innerHeight - 250
      }
    },
    methods: {
      loadBooks () {
        var _this = this
        this.$axios.get('/books').then(resp => {
          if (resp && resp.status === 200) {
            _this.books = resp.data
          }
        })
      },
      handleCurrentChange: function (currentPage) {
        this.currentPage = currentPage
        console.log(this.currentPage)
      },
      searchResult () {
        var _this = this
        this.$axios
          .get('/search?keywords=' + this.$refs.searchBar.keywords, {
          }).then(resp => {
          if (resp && resp.status === 200) {
            _this.books = resp.data
          }
        })
      },
      deleteBook (id) {
        console.log("æ­£åœ¨åˆ é™¤çš„å›¾ä¹¦ id æ˜¯: ", id)
        this.$confirm('æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥ä¹¦ç±, æ˜¯å¦ç»§ç»­?', 'æç¤º', {
          confirmButtonText: 'ç¡®å®š',
          cancelButtonText: 'å–æ¶ˆ',
          type: 'warning'
        }).then(() => {
            this.$axios
              .post('/admin/content/books/delete', {id: id}).then(resp => {
                if (resp && resp.status === 200) {
                  this.loadBooks()
              }
            })
          }
        ).catch(() => {
          this.$message({
            type: 'info',
            message: 'å·²å–æ¶ˆåˆ é™¤'
          })
        })
        // alert(id)
      },
      editBook (item) {
        this.$refs.edit.dialogFormVisible = true
        this.$refs.edit.form = {
          id: item.id,
          cover: item.cover,
          title: item.title,
          author: item.author,
          date: item.date,
          press: item.press,
          abs: item.abs,
          category: {
            id: item.category.id.toString(),
            name: item.category.name
          }
        }
      }
    }
  }
</script>

<style scoped>

</style>
```

æ³¨æ„æˆ‘ä»¬çš„åå°æ¥å£ï¼š`/admin/content/books/delete`ï¼Œ**æ ¹æ® `admin_permission` è¡¨ï¼Œå¯¹å†…å®¹ç®¡ç†æ¨¡å—éœ€è¦æƒé™çš„åç«¯æ¥å£ï¼ˆå¢åˆ æ”¹æ–¹æ³•ï¼‰éƒ½åŠ ä¸Š `admin/content/` å‰ç¼€**ï¼š

![](https://gitee.com/veal98/images/raw/master/img/20200829110859.png)

å¯¹äºæŸ¥è¯¢æ“ä½œæ¥è¯´ï¼Œä¸éœ€è¦æƒé™å°±èƒ½è®¿é—®ï¼Œä¸åšä¿®æ”¹ï¼š

![](https://gitee.com/veal98/images/raw/master/img/20200829110943.png)

ğŸš© å¯¹äº**è·¨åŸŸé—®é¢˜**ï¼Œå¯ä»¥ä¿®æ”¹ä¸€ä¸‹è‡ªå®šä¹‰çš„ Shiro è¿‡æ»¤å™¨ï¼š

```java
@Override
protected boolean onPreHandle(ServletRequest request, ServletResponse response, Object mappedValue) throws Exception {
    
    HttpServletRequest httpServletRequest = (HttpServletRequest) request;
    HttpServletResponse httpServletResponse = (HttpServletResponse) response;

    // å…è®¸è·¨åŸŸ
    httpServletResponse.setHeader("Access-control-Allow-Origin", httpServletRequest.getHeader("Origin")); //æ ‡è¯†å…è®¸å“ªä¸ªåŸŸåˆ°è¯·æ±‚ï¼Œç›´æ¥ä¿®æ”¹æˆè¯·æ±‚å¤´çš„åŸŸ
    httpServletResponse.setHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS,PUT,DELETE");//æ ‡è¯†å…è®¸çš„è¯·æ±‚æ–¹æ³•
    // å“åº”é¦–éƒ¨ Access-Control-Allow-Headers ç”¨äº preflight request ï¼ˆé¢„æ£€è¯·æ±‚ï¼‰ä¸­ï¼Œåˆ—å‡ºäº†å°†ä¼šåœ¨æ­£å¼è¯·æ±‚çš„ Access-Control-Expose-Headers å­—æ®µä¸­å‡ºç°çš„é¦–éƒ¨ä¿¡æ¯ã€‚ä¿®æ”¹ä¸ºè¯·æ±‚é¦–éƒ¨
    httpServletResponse.setHeader("Access-Control-Allow-Headers", httpServletRequest.getHeader("Access-Control-Request-Headers"));
    httpServletResponse.setHeader("Access-Control-Allow-Credentials", "true");

    // æ”¾è¡Œ options è¯·æ±‚
    if (HttpMethod.OPTIONS.toString().equals((httpServletRequest).getMethod())) {
        httpServletResponse.setStatus(HttpStatus.NO_CONTENT.value());
        return true;
    }
    
    .......
```

ğŸš¨ æ³¨æ„ä¿®æ”¹ä¸€ä¸‹å›¾ç‰‡ä¸Šä¼ ç»„ä»¶ï¼Œéœ€è¦å•ç‹¬è®¾ç½®å±æ€§æ‰èƒ½å¸¦ä¸Š cookieï¼Œä¸å¸¦ cookie åç«¯å°±æ‹¿ä¸åˆ° sessionIdï¼Œå°±ä¼šè¢« shiro æ‹¦æˆªã€‚ä¿®æ”¹åçš„ç»„ä»¶æ¨¡æ¿éƒ¨åˆ†å¦‚ä¸‹ï¼š

<img src="https://gitee.com/veal98/images/raw/master/img/20200902154603.png" style="zoom: 50%;" />

### â‘¡ å¹¿å‘Šç®¡ç†

âœ… TODO

### â‘¢ æ–‡ç« ç®¡ç†

âœ… TODO

## 2. ç”¨æˆ·ç®¡ç†

### â‘  ç”¨æˆ·ä¿¡æ¯

#### â…  ç”¨æˆ·å¢/åˆ /æ”¹/æŸ¥

ğŸ¨ æ•ˆæœå¦‚ä¸‹ï¼š

![](https://gitee.com/veal98/images/raw/master/img/image-20200829163157935.png)

å…ˆæŠŠåç«¯çš„ç”¨æˆ·å¢åŠ /åˆ é™¤/ä¿®æ”¹/æŸ¥è¯¢æ–¹æ³•å†™å¥½ï¼š

```java
@RestController
public class UserController {


    @Autowired
    UserService userService;

    // æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·åŠå…¶å¯¹åº”çš„è§’è‰²ä¿¡æ¯
    @GetMapping("/api/admin/user")
    public List<User> listUsers() throws Exception {
        return userService.list();
    }

    // ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
    @PutMapping("/api/admin/user")
    public Result editUser(@RequestBody  User requestUser) {
        userService.editUser(requestUser);
        return new Result(200);
    }

    // åˆ é™¤ç”¨æˆ·ä¿¡æ¯
    @PostMapping("/api/admin/user/delete")
    public Result deleteUser(@RequestBody User requestUser){
        userService.deleteUser(requestUser);
        return new Result(200);
    }

}
```

**ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ä¸­æ¶‰åŠåˆ°ç”¨æˆ·çš„è§’è‰²åˆ†é…ï¼Œæˆ‘ä»¬ä¹‹åå†ç»†è¯´**

å¯¹åº” `Service` å±‚çš„å¢åˆ æ”¹æŸ¥æ–¹æ³•ï¼š

```java
@Service
public class UserService {

    @Autowired
    UserDao userDao;
    @Autowired
    AdminRoleService adminRoleService;
    @Autowired
    AdminUserRoleService adminUserRoleService;

	......
        
        
    // æ·»åŠ  User
    public void add(User user){
        userDao.save(user);
        System.out.println("æ·»åŠ æˆåŠŸ");
    }

    // æŸ¥è¯¢æ‰€æœ‰ User åŠå…¶å¯¹åº”çš„è§’è‰²ä¿¡æ¯
    public List<User> list() {
        List<User> users = userDao.findAll();
        List<AdminRole> roles;
        // æŸ¥è¯¢è¯¥ç”¨æˆ·å¯¹åº”çš„è§’è‰²ä¿¡æ¯
        for(User user: users){
            roles = adminRoleService.listRolesByUser(user.getUsername());
            user.setRoles(roles); // æ¶‰åŠåˆ°è§’è‰²é—®é¢˜ï¼Œè¯¦è§£è§ä¸‹ä¸€å°èŠ‚
        }
        return users;
    }

    // ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯(æš‚æ—¶æ²¡æœ‰é‚£ä¹ˆå¤šä¿¡æ¯ï¼Œåªèƒ½ä¿®æ”¹è§’è‰²)
    public void editUser(User user) {
        User userInDB = userDao.findByUsername(user.getUsername());
        // ç”¨æˆ·è§’è‰²åˆ†é… saveRoleChanges æ–¹æ³•ï¼ˆä¸‹ä¸€å°èŠ‚è¯¦ç»†è§£é‡Šï¼‰
        adminUserRoleService.saveRoleChanges(userInDB.getId(), user.getRoles());
    }

    // æ ¹æ® id åˆ é™¤ç”¨æˆ·
    public void deleteUser(User user){
        userDao.deleteById(user.getId());
    }

}
```

**å‰ç«¯å¯¹åº”çš„ç•Œé¢ `UserProfile.vue`**ï¼š

```vue
<template>
  <div>

    <el-dialog
      title="ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯"
      :visible.sync="dialogFormVisible">

      <el-form v-model="selectedUser" style="text-align: left" ref="dataForm">
        <el-form-item label="ç”¨æˆ·å" label-width="120px" prop="username">
          <label>{{selectedUser.username}}</label>
        </el-form-item>

        <el-form-item label="è§’è‰²åˆ†é…" label-width="120px" prop="roles">
          <el-checkbox-group v-model="selectedRolesIds">
              <el-checkbox v-for="(role,i) in roles" :key="i" :label="role.id">{{role.nameZh}}</el-checkbox>
          </el-checkbox-group>
        </el-form-item>
      </el-form>

      <div slot="footer" class="dialog-footer">
        <el-button @click="dialogFormVisible = false">å– æ¶ˆ</el-button>
        <el-button type="primary" @click="onSubmit(selectedUser)">ç¡® å®š</el-button>
      </div>

    </el-dialog>

    <!-- æ·»åŠ ç”¨æˆ·ï¼Œæ·»åŠ æˆåŠŸåè°ƒç”¨  listUsers æ–¹æ³•-->
    <UserRegistration @onSubmit="listUsers()" style="margin: 18px 1%"></UserRegistration>

    <el-card style="margin: 18px 2%;width: 95%">
      <el-table
        :data="users"
        stripe
        :default-sort = "{prop: 'id', order: 'ascending'}"
        style="width: 100%"
        :max-height="tableHeight">

        <el-table-column
          prop="id"
          label="id"
          sortable
          width="200">
        </el-table-column>

        <el-table-column
          prop="username"
          label="ç”¨æˆ·å"
          fit>
        </el-table-column>

        <el-table-column
          label="æ“ä½œ"
          width="200">
          <template slot-scope="scope">
            <el-button
              @click="editUser(scope.row)"
              type="text"
              size="small">
              ç¼–è¾‘
            </el-button>
            <el-button
              @click="deleteUser(scope.row.id)"
              type="text"
              size="small">
              ç§»é™¤
            </el-button>
          </template>
        </el-table-column>

      </el-table>
      
    </el-card>
  </div>
</template>

<script>
    import UserRegistration from './userProfile/UserRegistration'

    export default {
      name: 'UserProfile',
      components: {UserRegistration},
      data () {
          return {
            users: [],
            roles: [],
            dialogFormVisible: false,
            selectedUser: [],
            selectedRolesIds: []
          }
      },
      mounted () {
        this.listUsers()
        this.listRoles()
      },
      computed: {
        tableHeight () {
          return window.innerHeight - 250
        }
      },
      methods: {
        // æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
        listUsers () {
          var _this = this
          this.$axios.get('/admin/user').then(resp => {
            if (resp && resp.status === 200) {
              _this.users = resp.data
            }
          })
        },
        // æ˜¾ç¤ºæ‰€æœ‰è§’è‰²ä¿¡æ¯
        listRoles () {
          var _this = this
          this.$axios.get('/admin/role').then(resp => {
            if (resp && resp.status === 200) {
              _this.roles = resp.data
            }
          })
        },

        // ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
        onSubmit (user) {
          let _this = this
          // æ ¹æ®è§†å›¾ç»‘å®šçš„è§’è‰² id å‘åç«¯ä¼ é€è§’è‰²ä¿¡æ¯
          let roles = []
          for (let i = 0; i < _this.selectedRolesIds.length; i++) {
            for (let j = 0; j < _this.roles.length; j++) {
              if (_this.selectedRolesIds[i] === _this.roles[j].id) {
                roles.push(_this.roles[j])
              }
            }
          }
          this.$axios.put('/admin/user', {
            username: user.username,
            roles: roles
          }).then(resp => {
            if (resp && resp.data.code === 200) {
              this.$alert('ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹æˆåŠŸ')
              this.dialogFormVisible = false
              // ä¿®æ”¹è§’è‰²åé‡æ–°è¯·æ±‚ç”¨æˆ·ä¿¡æ¯ï¼Œå®ç°è§†å›¾æ›´æ–°
              this.listUsers()
            } else {
              this.$alert(resp.data.message)
            }
          })
        },
        // ç‚¹å‡»ç¼–è¾‘æŒ‰é’®åå›æ˜¾ç”¨æˆ·ä¿¡æ¯
        editUser (user) {
          this.dialogFormVisible = true
          this.selectedUser = user
          let roleIds = []
          for (let i = 0; i < user.roles.length; i++) {
            roleIds.push(user.roles[i].id)
          }
          // æ¸²æŸ“è§’è‰²æ¡†é€‰ä¸­
          this.selectedRolesIds = roleIds
        },

        deleteUser (id) {
          this.$confirm('æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥ä¹¦ç±, æ˜¯å¦ç»§ç»­?', 'æç¤º', {
            confirmButtonText: 'ç¡®å®š',
            cancelButtonText: 'å–æ¶ˆ',
            type: 'warning'
          }).then( () => {
            this.$axios.post('/admin/user/delete' ,{id: id}).then(resp => {
              if(resp && resp.data.code  === 200){
                this.listUsers();
              }
            })
          }).catch( () => {
            this.$message({
              type: 'info',
              message: 'å·²å–æ¶ˆåˆ é™¤'
            })
          }) 
        }
      }
    }
</script>

<style scoped>
</style>
```

å…¶ä¸­åµŒå…¥äº†å­ç»„ä»¶ `UserRegistration` ç”¨äºæ³¨å†Œï¼š

```vue
<template>
  <div style="text-align: left">
    <el-button class="add-button" type="success" @click="dialogFormVisible = true">æ·»åŠ ç”¨æˆ·</el-button>
    <el-dialog
      title="æ·»åŠ ç”¨æˆ·"
      :visible.sync="dialogFormVisible"
      @close="clear"
      width="25%">
      <el-form :model="loginForm" :rules="rules" label-position="left"
               label-width="0px">
        <el-form-item prop="username">
          <el-input type="text" v-model="loginForm.username"
                    auto-complete="off" placeholder="è´¦å·"></el-input>
        </el-form-item>
        <el-form-item prop="password">
          <el-input type="password" v-model="loginForm.password"
                    auto-complete="off" placeholder="å¯†ç "></el-input>
        </el-form-item>
        <el-form-item style="width: 100%">
          <el-button type="primary" style="width: 40%;background: #505458;border: none" v-on:click="register">æ·»åŠ </el-button>
        </el-form-item>
      </el-form>
    </el-dialog>
  </div>
</template>

<script>
    export default {
        name: 'UserRegistration',
      data () {
        return {
          dialogFormVisible: false,
          rules: {
            username: [{required: true, message: 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º', trigger: 'blur'}],
            password: [{required: true, message: 'å¯†ç ä¸èƒ½ä¸ºç©º', trigger: 'blur'}]
          },
          loginForm: {
            username: '',
            password: '',
          }
        }
      },
      methods: {
        clear () {
          this.loginForm = {
            username: '',
            password: '',
          }
        },
        register () {
          this.$axios
            .post('/register', {
              username: this.loginForm.username,
              password: this.loginForm.password,
            })
            .then(resp => {
              if (resp.data.code === 200) {
                this.$alert('æ³¨å†ŒæˆåŠŸ', 'æç¤º', {
                  confirmButtonText: 'ç¡®å®š'
                })
                this.dialogFormVisible = false
                this.clear()
                this.$emit('onSubmit') // æ¿€æ´»çˆ¶ç»„ä»¶ onSubmit äº‹ä»¶
              } else {
                this.$alert('æ³¨å†Œå¤±è´¥', 'æç¤º', {
                  confirmButtonText: 'ç¡®å®š'
                })
              }
            })
            .catch(failResponse => {})
        }
      }
    }
</script>

<style scoped>
  .add-button {
    margin: 18px 0 0 10px;
  }
</style>
```

#### â…¡ ç”¨æˆ·è§’è‰²åˆ†é…

ğŸ¨ æ•ˆæœå¦‚ä¸‹ï¼š

![](https://gitee.com/veal98/images/raw/master/img/20200829163350.png)

å‰ç«¯ä»£ç å…¨åœ¨ä¸Šé¢äº†ï¼Œä¸‹é¢åªé‡ç‚¹è®²è§£å…³äºç”¨æˆ·è§’è‰²åˆ†é…çš„åç«¯ä»£ç  ğŸ‘‡

âšª é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦**æŸ¥è¯¢å‡ºæ‰€æœ‰çš„è§’è‰²ï¼Œå¯¹åº”å‰ç«¯çš„ checkbox**ï¼š

```java
@RestController
public class RoleController {

    @Autowired
    AdminRoleService adminRoleService;

    // æŸ¥è¯¢æ‰€æœ‰è§’è‰²åŠå…¶ç›¸åº”çš„æƒé™ä¿¡æ¯
    @GetMapping("api/admin/role")
    public List<AdminRole> listRoles(){
        return adminRoleService.listWithPermsAndMenus();
    }

}

```

å…¶ä¸­ `listWithPermsAndMenus`ï¼š

```java
// æŸ¥è¯¢æ‰€æœ‰è§’è‰²åŠå…¶ç›¸åº”çš„æƒé™å’Œèœå•ä¿¡æ¯
public List<AdminRole> listWithPermsAndMenus() {
    List<AdminRole> roles = adminRoleDAO.findAll();
    List<AdminPermission> perms;
    List<AdminMenu> menus;
    for (AdminRole role : roles) {
        perms = adminPermissionService.listPermsByRoleId(role.getId());
        menus = adminMenuService.getMenusByRoleId(role.getId());
        role.setPerms(perms);
        role.setMenus(menus);
    }
    return roles;
}
```

âšª ç„¶åï¼Œæˆ‘ä»¬éœ€è¦**æŸ¥è¯¢å‡ºå½“å‰ç”¨æˆ·çš„è§’è‰²ï¼Œä½¿å¾—å‰ç«¯çš„ checkbox é«˜äº®**ã€‚è¿™æ—¶æœ‰ä¸¤ç§æ€è·¯ï¼š

- ç¬¬ä¸€ç§ï¼Œå¯ä»¥ä»¥ç”¨æˆ·åæˆ– id ä¸ºå‚æ•°å‘åç«¯å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢å‡ºå¯¹åº”çš„è§’è‰²å€¼å¹¶è¿”å›
- ç¬¬äºŒç§ï¼Œæ”¹é€ åç«¯æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯çš„æ¥å£ï¼Œç›´æ¥åœ¨æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯æ—¶å°±æŠŠè§’è‰²ä¿¡æ¯æŸ¥è¯¢å‡ºæ¥

ä¸ºäº†å‰åç«¯ä¼ é€’å‚æ•°æ›´æ–¹ä¾¿ä¸€äº›ï¼Œæˆ‘é€‰ç”¨äº†ç¬¬äºŒç§æ–¹æ³•ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•**éœ€è¦åœ¨ `User` å®ä½“ç±»ä¸­æ·»åŠ å±æ€§æ¥å­˜æ”¾è§’è‰²ä¿¡æ¯**ï¼Œä½†æ˜¯ç”±äºæ•°æ®åº“ä¸­å¹¶æ²¡æœ‰ç›¸åº”å®šä¹‰ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åŠ ä¸Š `@Transient` æ³¨é‡Šã€‚

```java
@Transient
List<AdminRole> roles;

// getter and setter
public List<AdminRole> getRoles() {
    return roles;
}

public void setRoles(List<AdminRole> roles) {
    this.roles = roles;
}

```

ç›¸åº”åœ°åœ¨ `UserService` ä¸­ä¿®æ”¹åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·çš„æ–¹æ³•ï¼š

```java
// æŸ¥è¯¢æ‰€æœ‰ User åŠå…¶å¯¹åº”çš„è§’è‰²ä¿¡æ¯
public List<User> list() {
    List<User> users = userDao.findAll();
    List<AdminRole> roles;
    // æŸ¥è¯¢è¯¥ç”¨æˆ·å¯¹åº”çš„è§’è‰²ä¿¡æ¯
    for(User user: users){
        roles = adminRoleService.listRolesByUser(user.getUsername());
        user.setRoles(roles);
    }
    return users;
}
```

å…¶ä¸­ï¼Œ`listRolesByUser` æ–¹æ³•ï¼š

```java
// æŸ¥è¯¢è¯¥ç”¨æˆ·å¯¹åº”çš„è§’è‰²ä¿¡æ¯ AdminRole
public List<AdminRole> listRolesByUser(String username) {
    int uid = userService.getByName(username).getId();
    //        List<Integer> rids = adminUserRoleService.listAllByUid(uid)
    //                              .stream().map(AdminUserRole::getRid).collect(Collectors.toList());
    List<Integer> rids = new ArrayList<>();
    List<AdminUserRole> adminUserRoles = adminUserRoleService.listAllByUid(uid); // æŸ¥è¯¢è¯¥ç”¨æˆ·å¯¹åº”çš„ç”¨æˆ·-è§’è‰²å…³ç³»
    for(AdminUserRole adminUserRole: adminUserRoles){
        rids.add(adminUserRole.getRid()); // è·å–è¯¥ç”¨æˆ·-æƒé™å…³ç³»ä¸­çš„è§’è‰² id
    }
    return adminRoleDAO.findAllById(rids); // æ ¹æ®è§’è‰²id æŸ¥è¯¢è¯¦ç»†è§’è‰²ä¿¡æ¯ AdminRole
}
```

è¿™æ ·æŸ¥è¯¢å‡ºçš„ç”¨æˆ·å°±ä¼šå¸¦ä¸Šè§’è‰²ä¿¡æ¯äº†ã€‚

ä¹‹åï¼Œæˆ‘ä»¬ä½¿ç”¨ `<el-checkbox-group>`ï¼Œä¹Ÿå°±æ˜¯å¤šé€‰æ¡†ç»„æ¥å®ç°è§’è‰²çš„æ˜¾ç¤ºä¸ç¼–è¾‘ã€‚è§‚å¯Ÿå¦‚ä¸‹ä»£ç ï¼š

```html
<el-form-item label="è§’è‰²åˆ†é…" label-width="120px" prop="roles">
  <el-checkbox-group v-model="selectedRolesIds">
      <el-checkbox v-for="(role,i) in roles" :key="i" :label="role.id">{{role.nameZh}}</el-checkbox>
  </el-checkbox-group>
</el-form-item>

```

**`roles` æ˜¯ä»åç«¯æŸ¥è¯¢åˆ°çš„æ‰€æœ‰è§’è‰²ä¿¡æ¯ï¼Œæˆ‘ä»¬é€šè¿‡éå†æ¸²æŸ“å‡ºè§’è‰²çš„ä¸­æ–‡åç§°ï¼Œå¹¶æŒ‡å®šå¤šé€‰æ¡†çš„ `label` å€¼ä¸º `role.id` ã€‚**<u>`selectedRolesIds` æ˜¯ä¸€ä¸ª Array ç±»å‹çš„å˜é‡ï¼Œä¹Ÿå°±æ˜¯å½“å‰ç”¨æˆ·å¯¹åº”çš„è§’è‰²çš„ idã€‚ç»„ä»¶ä¼šæ ¹æ®å…¶ä¸­çš„æ•°æ®åŒ¹é… label å€¼ï¼Œå¹¶é€‰ä¸­ç›¸åº”çš„å†…å®¹ã€‚</u>

å¯ä»¥**åœ¨ç‚¹å‡»ç¼–è¾‘æŒ‰é’®æ—¶è°ƒç”¨å¤„ç†æ–¹æ³•ï¼Œè·å–å½“å‰ç”¨æˆ·å¯¹åº”çš„è§’è‰²çš„ `id`**ï¼š

```js
 editUser (user) {
   this.dialogFormVisible = true
   this.selectedUser = user
   let roleIds = []
   for (let i = 0; i < user.roles.length; i++) {
     roleIds.push(user.roles[i].id)
   }
   this.selectedRolesIds = roleIds
 }
```

è¿™æ ·ï¼Œå¯¹è¯æ¡†ä¸­çš„è§’è‰²ä¿¡æ¯å°±èƒ½æ­£ç¡®æ¸²æŸ“äº†ã€‚ç”±äº `selectedRolesIds` æ˜¯ä¸å¤šé€‰æ¡†åŒå‘ç»‘å®šçš„ï¼Œæˆ‘ä»¬é€šè¿‡ç‚¹é€‰å°±å¯ä»¥æ”¹å˜è¿™ä¸ª Array çš„å€¼ã€‚è¿˜æ˜¯**ä¸ºäº†åç«¯æ¥æ”¶æ–¹ä¾¿ï¼Œæˆ‘ä»¬åœ¨æäº¤æ›´æ”¹æ—¶å¯ä»¥åšä¸€äº›å¤„ç†ï¼Œé€šè¿‡è¿™äº›è§’è‰² `id` è·å¾—è§’è‰²å¯¹è±¡æœ¬èº«å¹¶ä¼ é€’**ï¼š

```java
onSubmit (user) {
  let _this = this
  // æ ¹æ®è§†å›¾ç»‘å®šçš„è§’è‰² id å‘åç«¯ä¼ é€è§’è‰²ä¿¡æ¯
  let roles = []
  for (let i = 0; i < _this.selectedRolesIds.length; i++) {
    for (let j = 0; j < _this.roles.length; j++) {
      if (_this.selectedRolesIds[i] === _this.roles[j].id) {
        roles.push(_this.roles[j])
      }
    }
  }
  this.$axios.put('/admin/user', {
    username: user.username,
    roles: roles
  }).then(resp => {
    if (resp && resp.status === 200) {
      this.$alert('ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹æˆåŠŸ')
      this.dialogFormVisible = false
      // ä¿®æ”¹è§’è‰²åé‡æ–°è¯·æ±‚ç”¨æˆ·ä¿¡æ¯ï¼Œå®ç°è§†å›¾æ›´æ–°
      this.listUsers()
    }
  })
}
```

ä»¥ä¸Šç”¨æˆ·ä¿¡æ¯çš„ä¿®æ”¹è¿‡ç¨‹ `this.$axios.put('/admin/user'` è¿˜åŒ…æ‹¬è§’è‰²çš„ä¿®æ”¹ï¼š

![](https://gitee.com/veal98/images/raw/master/img/20200829165422.png)

âœ ç”¨æˆ·è§’è‰²ä¿®æ”¹çš„æ ¸å¿ƒä»£ç æ˜¯ `saveRoleChanges`ï¼š

ä¿®æ”¹çš„æ€è·¯æ˜¯å…ˆåˆ é™¤åŸæœ‰ç”¨æˆ·(uid)å¯¹åº”çš„æ‰€æœ‰è¡Œï¼Œå†æ ¹æ®æ–°ä¼ é€’çš„æ•°æ®åšæ’å…¥æ“ä½œã€‚è¿™æ ·çš„ç¼ºç‚¹æ˜¯æ¯”è¾ƒè´¹è‡ªå¢ idï¼ˆå…¶å®æ— æ‰€è°“ï¼‰ï¼Œä½†çœå»äº†æ¯”å¯¹çš„éº»çƒ¦

### â‘¡ è§’è‰²-æƒé™åˆ†é…

è§’è‰²-æƒé™åˆ†é…å°±æ˜¯ä¸ºè§’è‰²æŒ‡å®šå¯¹åº”çš„æƒé™ã€‚

![](https://gitee.com/veal98/images/raw/master/img/20200901122305.png)

<img src="https://gitee.com/veal98/images/raw/master/img/20200901122332.png" style="zoom: 50%;" />

å’Œä¸Šè¿°è¿‡ç¨‹éƒ½å·®ä¸å¤šï¼Œå¤§å®¶å‚è€ƒæºç å°±è¡Œäº†ã€‚å€¼å¾—ä¸€æçš„æ˜¯èœå•é…ç½®ï¼Œå…¶å®åŸç†ä¸€æ ·ï¼Œåªä¸è¿‡ç”¨åˆ°äº† element-ui ä¸­çš„**æ ‘å½¢æ§ä»¶**

### â‘¢ è§’è‰²-èœå•åˆ†é…

é¦–å…ˆæˆ‘ä»¬å¾—ä½¿ç”¨ Element-Ui çš„ [ã€Œæ ‘å½¢æ§ä»¶ã€](https://element.eleme.cn/#/zh-CN/component/tree)ï¼ŒåŒæ—¶è¿˜è¦åŠ ä¸Šé€‰æ‹©åŠŸèƒ½ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å‰ç«¯çš„ä»£ç ï¼š

```html
<el-form-item label="èœå•é…ç½®" label-width="120px" prop="menus">
  <el-tree
    :data="menus"
    :props="props"
    show-checkbox
    :default-checked-keys="selectedMenusIds"
    node-key="id"
    ref="tree">
  </el-tree>
</el-form-item>
```

å„å±æ€§çš„ä½œç”¨å¦‚ä¸‹ï¼š

- `data` æŒ‡å®šäº†æ•°æ®æºä¸ºå‘åç«¯æŸ¥è¯¢åˆ°çš„èœå•ä¿¡æ¯

- `props` æŒ‡å®šæ ‘æ˜¾ç¤ºæ•°æ®æºçš„å“ªäº›å±æ€§

- `show-checkbox` å¼€å¯äº†é€‰æ‹©åŠŸèƒ½

- `:default-checked-keys` è®¾ç½®æ ‘ç¬¬ä¸€æ¬¡åŠ è½½æ—¶é»˜è®¤é€‰ä¸­çš„èŠ‚ç‚¹

- `node-key` æŒ‡å®šæ ‘èŠ‚ç‚¹å…³è”çš„å±æ€§ä¸º id

  > ğŸ“œ åˆ†åˆ«é€šè¿‡`default-expanded-keys`å’Œ`default-checked-keys`è®¾ç½®é»˜è®¤å±•å¼€å’Œé»˜è®¤é€‰ä¸­çš„èŠ‚ç‚¹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤æ—¶å¿…é¡»è®¾ç½®`node-key`ï¼Œå…¶å€¼ä¸ºèŠ‚ç‚¹æ•°æ®ä¸­çš„ä¸€ä¸ªå­—æ®µåï¼Œè¯¥å­—æ®µåœ¨æ•´æ£µæ ‘ä¸­æ˜¯å”¯ä¸€çš„ã€‚

- `ref` æŒ‡å®šæ ‘çš„å¼•ç”¨åï¼Œä»¥æ–¹ä¾¿è°ƒç”¨ç›¸å…³æ–¹æ³•

`menus` åœ¨ `mouted()` ä¸­è°ƒç”¨æŸ¥è¯¢æ–¹æ³•è·å–ï¼š

<img src="https://gitee.com/veal98/images/raw/master/img/20200901151248.png" style="zoom:50%;" />

```js
listMenus () {
 var _this = this
 this.$axios.get('/admin/role/menu').then(resp => {
   if (resp && resp.status === 200) {
     _this.menus = resp.data
 }
})
},
```

å¯¹åº”çš„åç«¯æ¥å£ï¼š

```java
// æŸ¥è¯¢æ‰€æœ‰çš„èœå•åˆ—è¡¨
@GetMapping("/api/admin/role/menu")
public List<AdminMenu> listAllMenus() {
    // è§’è‰²1 ç³»ç»Ÿç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰çš„èœå•é¡¹ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æ ¹æ®å®ƒæ¥æŸ¥è¯¢å³å¯
    return adminMenuService.getMenusByRoleId(1);
}
```

`getMenusByRoleId` æ–¹æ³•åœ¨ ã€åŠ¨æ€åŠ è½½åå°èœå•ã€‘éƒ¨åˆ†å·²ç»è¯¦ç»†è§£é‡Šè¿‡äº†

å‰ç«¯æ ‘æ§ä»¶çš„ `props` è®¾å®šå¦‚ä¸‹ï¼š

```js
props: {
  id: 'id',
  label: 'nameZh',
  children: 'children'
}
```

`:` å·¦è¾¹æ˜¯æ ‘ç»„ä»¶çš„å±æ€§ï¼Œå³è¾¹æ˜¯æˆ‘ä»¬æ•°æ®çš„å±æ€§ã€‚ä¸ºäº†æ­£ç¡®åœ°æ ¹æ® id åŠ è½½é€‰ä¸­é¡¹ï¼Œåœ¨ç‚¹å‡»ç¼–è¾‘æŒ‰é’®æ—¶æˆ‘ä»¬éœ€è¦æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š

```js
editRole (role) {

  ...
  
  let menuIds = []
  for (let i = 0; i < role.menus.length; i++) {
    menuIds.push(role.menus[i].id)
    for (let j = 0; j < role.menus[i].children.length; j++) {
      menuIds.push(role.menus[i].children[j].id)
    }
  }
  this.selectedMenusIds = menuIds
  // åˆ¤æ–­æ ‘æ˜¯å¦å·²ç»åŠ è½½
  // ç¬¬ä¸€æ¬¡æ‰“å¼€å¯¹è¯æ¡†å‰æ ‘ä¸å­˜åœ¨ï¼Œæ— æ³•è°ƒç”¨æ–¹æ³•ï¼Œéœ€è¦é€šè¿‡è®¾ç½® default-checked æ­£ç¡®é€‰ä¸­èœå•é¡¹
  if (this.$refs.tree) {
    this.$refs.tree.setCheckedKeys(menuIds)
  }
}

```

é€šè¿‡è§†å›¾é€‰æ‹©ç›¸åº”èœå•é¡¹åï¼Œæˆ‘ä»¬å¯ä»¥å‘åç«¯å‘é€æ›´æ–°è¯·æ±‚ï¼Œè·Ÿå‰ä¸¤ä¸ªä¸åŒçš„æ˜¯ï¼Œ**è¿™æ¬¡æˆ‘ä»¬åªå‘ id å°±å¥½ï¼Œå› ä¸ºæ ‘ç»“æ„æ¯”å¯¹èµ·æ¥æ¯”è¾ƒéº»çƒ¦**ã€‚è¯·æ±‚çš„ä»£ç å¦‚ä¸‹ï¼š

```js
this.$axios.put('/admin/role/menu?rid=' + role.id, {
  menusIds: this.$refs.tree.getCheckedKeys()
}).then(resp => {
  if (resp && resp.status === 200) {
    ......	
  }
})
```

`getCheckedKeys()` æ˜¯ tree ç»„ä»¶æä¾›çš„ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å‘é€é€‰ä¸­çš„æ•°æ®ï¼ˆæ ¹æ® node-key çš„è®¾ç½®è·å–æ•°æ®ï¼‰ã€‚åç«¯æ¥æ”¶åˆ°çš„æ˜¯ä¸€ä¸ª Mapï¼š

```java
// ä¿®æ”¹è§’è‰²å¯¹åº”çš„èœå•åˆ—è¡¨
@PutMapping("/api/admin/role/menu")
public void updateRoleMenu(@RequestParam int rid, @RequestBody Map<String, List<Integer>> menusIds) {
    adminRoleMenuService.updateRoleMenu(rid, menusIds);
}
```

```java
// æ›´æ–°è§’è‰² rid å¯¹åº”çš„èœå•åˆ—è¡¨ id ä¸º menusIds
@Modifying
@Transactional
public void updateRoleMenu(Integer rid, Map<String, List<Integer>> menusIds){
    adminRoleMenuDAO.deleteAllByRid(rid);
    List<AdminRoleMenu> adminRoleMenus = new ArrayList<>();
    for(Integer mid : menusIds.get("menusIds")){
        AdminRoleMenu adminRoleMenu = new AdminRoleMenu();
        adminRoleMenu.setMid(mid);
        adminRoleMenu.setRid(rid);
        adminRoleMenus.add(adminRoleMenu);
    }
    adminRoleMenuDAO.saveAll(adminRoleMenus);
}
```

ç”±äºæ‰§è¡Œäº†åˆ é™¤æ“ä½œï¼Œè¦ä¸º `updateRoleMenu` æ–¹æ³•å¼€å¯äº‹åŠ¡ã€‚

## ğŸ“š References

- [Vue + Spring Boot é¡¹ç›®å®æˆ˜ â€” ç™½å·](https://blog.csdn.net/Neuf_Soleil/article/details/88925013)
