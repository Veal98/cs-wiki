# ğŸ¦ å›¾ç‰‡ä¸Šä¼ 

---

## 1. å‰ç«¯éƒ¨åˆ†

å‚è€ƒ [Element - Upload ç»„ä»¶](https://element.eleme.cn/#/zh-CN/component/upload)

ä½¿ç”¨ Element `Upload `ç»„ä»¶å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°ä¸Šä¼ ï¼š

åœ¨ `Library `æ–‡ä»¶å¤¹ä¸‹æ–°å»ºç»„ä»¶ `ImgUpload.vue`ï¼š

```vue
<template>
    <!-- action æŒ‡å®šäº†ä¸Šä¼ æ“ä½œå¯¹åº”çš„åç«¯ api  -->
    <el-upload
        class="img-upload"    
        ref="upload"
        action="http://localhost:8082/api/covers" 
        :on-preview="handlePreview"
        :on-remove="handleRemove"
        :before-remove="beforeRemove"
        :on-success="handleSuccess"
        multiple
        :limit="1"
        :on-exceed="handleExceed"
        :file-list="fileList">
        <el-button size="small" type="primary">ç‚¹å‡»ä¸Šä¼ æœ¬åœ°å›¾ç‰‡</el-button>
        <!-- åœ¨åç«¯é…ç½®æ–‡ä»¶ä¸­è®¾ç½®æ–‡ä»¶å¤§å°é™åˆ¶ -->
        <div slot="tip" class="el-upload__tip">åªèƒ½ä¸Šä¼ jpg/pngæ–‡ä»¶ï¼Œä¸”ä¸è¶…è¿‡1MB</div>
    </el-upload>
</template>
<script>
  export default {
    name: 'ImgUpload',
    data() {
      return {
        fileList: [],
        url: ''
      };
    },
    methods: {
      handleRemove(file, fileList) {
      },
      handlePreview(file) {
      },
      handleExceed(files, fileList) {
        this.$message.warning(`å½“å‰é™åˆ¶é€‰æ‹© 1 ä¸ªæ–‡ä»¶ï¼Œæœ¬æ¬¡é€‰æ‹©äº† ${files.length} ä¸ªæ–‡ä»¶ï¼Œå…±é€‰æ‹©äº† ${files.length + fileList.length} ä¸ªæ–‡ä»¶`)
      },
      beforeRemove(file, fileList) {
        return this.$confirm(`ç¡®å®šç§»é™¤ ${ file.name }ï¼Ÿ`);
      },
      handleSuccess (response) {  // æ¥æ”¶åç«¯ api ä¼ è¿‡æ¥çš„è¿”å›å€¼ï¼ˆurlï¼‰
        this.url = response
        this.$emit('onUpload')
        this.$message.success('ä¸Šä¼ æˆåŠŸ')
      },
      
    }
  }
</script>
```

æ³¨æ„ï¼Œå¯¹äºä¸Šè¿°çš„æ–‡ä»¶å¤§å°é™åˆ¶ï¼Œå¯ä»¥åœ¨åç«¯å…¨å±€é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œä¿®æ”¹ï¼š

```yaml
spring:
  # è®¾ç½®æ–‡ä»¶å¤§å°é™åˆ¶
  servlet:
    multipart:
      max-file-size: 1MB
```

ä¸Šè¿° `ImgUpload` ç»„ä»¶ä¸­ `multiple:limit` ç”¨äºé™åˆ¶ä¸Šä¼ æ–‡ä»¶çš„æ•°é‡ã€‚

`on:success` è¡¨ç¤ºç»„ä»¶æ¥æ”¶åˆ°åç«¯çš„è¿”å›å€¼æ—¶ï¼Œå°†è¯¥è¿”å›å€¼ï¼ˆåç«¯é‡æ–°ç”Ÿæˆçš„å›¾ç‰‡ urlï¼‰èµ‹ç»™å›¾ä¹¦ä¿¡æ¯çš„ `cover `å­—æ®µï¼Œå¹¶ä¸”è§¦å‘çˆ¶ç»„ä»¶çš„ `onUpload` äº‹ä»¶ã€‚

OKï¼Œæ¥ä¸‹æ¥å°† `ImgUpload` ç»„ä»¶æ³¨å†Œè¿› `EditForm` ä¸­ï¼Œéœ€è¦ä¿®æ”¹çš„åœ°æ–¹æœ‰ä»¥ä¸‹ 3 ç‚¹ï¼š

```js
import ImgUpload from './ImgUpload'
  export default {
    name: 'EditForm',
    components: {ImgUpload},
```

```vue
 <el-form-item label="å°é¢" :label-width="formLabelWidth" prop="cover">
      <el-input v-model="form.cover" autocomplete="off" placeholder="è¯·è¾“å…¥å›¾ç‰‡ URL"></el-input>
      <ImgUpload @onUpload="uploadImg" ref = "imgUpload"></ImgUpload>
</el-form-item>
```

```js
 methods: {
  clear () {
    this.form = {
      id: '',
      title: '',
      author: '',
      date: '',
      press: '',
      cover: '',
      abs: '',
      category: {}
    },
    // å…³é—­çª—å£åæ¸…ç†å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
    this.$refs.imgUpload.$refs.upload.clearFiles()
  },
  uploadImg(){
    this.form.cover = this.$refs.imgUpload.url
  },
```

OKï¼Œå‰ç«¯éƒ¨åˆ†ç»“æŸ ğŸ‘‡

<img src="https://gitee.com/veal98/images/raw/master/img/20200803223526.png" style="zoom:80%;" />

## 2. åç«¯éƒ¨åˆ†

åç«¯ä¸»è¦è§£å†³å¦‚ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š

- å¦‚ä½•æ¥æ”¶å‰ç«¯ä¼ æ¥çš„å›¾ç‰‡æ•°æ®å¹¶ä¿å­˜
- å¦‚ä½•é¿å…é‡åï¼ˆå›¾ç‰‡èµ„æºçš„åå­—å¾ˆå¯èƒ½é‡å¤ï¼Œå¦‚ä¸ä¿®æ”¹å¯èƒ½å‡ºç°é—®é¢˜ï¼‰

é¦–å…ˆï¼Œåœ¨åç«¯æ–°å»º `utils` åŒ…ï¼Œåˆ›å»ºä¸€ä¸ªå·¥å…·ç±» `StringUtils` å¹¶ç¼–å†™ç”ŸæˆæŒ‡å®šé•¿åº¦éšæœºå­—ç¬¦ä¸²çš„æ–¹æ³•ï¼š

```java
/*
* ç”ŸæˆæŒ‡å®šé•¿åº¦çš„éšæœºå­—ç¬¦ä¸²ï¼Œç”¨äºä¸Šä¼ /ä¸‹è½½æ–‡ä»¶çš„å‘½å
* */
public class StringUtils {

    public static String getRandomString(int length){
        String base = "abcdefghijklmnopqrstuvwxyz0123456789";
        Random random = new Random();
        StringBuffer sb = new StringBuffer();
        for(int i = 0; i < length; i++){
            int number = random.nextInt(base.length()); // éšæœºç”Ÿæˆä¸‹æ ‡
            sb.append(base.charAt(number));
        }
        return sb.toString();
    }
}
```

ç„¶ååœ¨ `LibraryController` ä¸­æ·»åŠ  ä¸Šä¼ æ–‡ä»¶çš„æ–¹æ³•ï¼Œæ³¨æ„æ­¤å¤„çš„è·¯å¾„è¦å’Œå‰ç«¯ `ImgUpload` ä¸­çš„ `action` ä¸€è‡´ï¼š

```java
@RestController
public class LibraryController {

    ......

    // å°é¢å›¾ç‰‡çš„ä¸Šä¼ 
    @PostMapping("api/covers")
    public String coversUpload(MultipartFile file) throws IOException {
        String folder = "E:/workspace/img";
        File imageFolder = new File(folder);
        // å¯¹æ¥æ”¶çš„æ–‡ä»¶è¿›è¡Œé‡å‘½å
        File f = new File(imageFolder, StringUtils.getRandomString(6) + file.getOriginalFilename()
                .substring(file.getOriginalFilename().length() - 4));
        // å¦‚æœ E:/workspace/img æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºè¯¥æ–‡ä»¶å¤¹
        if(!f.getParentFile().exists())
            f.getParentFile().mkdirs();
        try {
            file.transferTo(f); // å‹ç¼©å›¾ç‰‡
            String imgUrl = "http://localhost:8082/api/file/" + f.getName();
            return imgUrl;
        } catch (IOException e) {
            e.printStackTrace();
            return "";
        }

    }
}

```

è¿™ä¸ª URL çš„å‰ç¼€æ˜¯æˆ‘ä»¬è‡ªå·±æ„å»ºçš„ï¼Œè¿˜éœ€è¦æŠŠè¿™ä¸ª URL è·Ÿæˆ‘ä»¬è®¾ç½®çš„å›¾ç‰‡èµ„æºæ–‡ä»¶å¤¹ `E:/workspace/img` å¯¹åº”èµ·æ¥ã€‚åœ¨ `config\MyWebConfigurer` ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

```java
@SpringBootConfiguration
public class MyWebConfigurer implements WebMvcConfigurer {
   
    ......

    // å°†è®¾å®šçš„å›¾ç‰‡urlä¸æˆ‘ä»¬è®¾ç½®çš„èµ„æºæ–‡ä»¶å¤¹E:/workspace/img/å¯¹åº”èµ·æ¥
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/api/file/**").addResourceLocations("file:E:/workspace/img/");
    }
}
```

OKï¼Œåç«¯éƒ¨åˆ†ç»“æŸï¼Œä¸‹é¢çœ‹çœ‹æ•´ä½“æ•ˆæœ ğŸ‘‡

<img src="https://gitee.com/veal98/images/raw/master/img/20200803223636.png" style="zoom:80%;" />

åŒæ—¶åœ¨ `E:/workspace/img/` ä¹Ÿä¼šä¿å­˜ä¸‹æˆ‘ä»¬ä¸Šä¼ çš„å›¾ç‰‡ã€‚

## ğŸ“š References

- [Vue + Spring Boot é¡¹ç›®å®æˆ˜ â€” ç™½å·](https://blog.csdn.net/Neuf_Soleil/article/details/88925013)
- [Element - Upload ç»„ä»¶](https://element.eleme.cn/#/zh-CN/component/upload)