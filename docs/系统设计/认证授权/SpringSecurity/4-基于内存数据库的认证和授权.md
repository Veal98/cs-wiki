# ğŸ¥› åŸºäºå†…å­˜æ•°æ®åº“çš„èº«ä»½è®¤è¯å’Œè§’è‰²æˆæƒ

---

åœ¨ä¸ŠèŠ‚æˆ‘ä»¬ä½¿ç”¨åŸºäºå†…å­˜çš„æ–¹å¼ä½“éªŒäº†ä¸‹ Spring Securityï¼Œåœ¨å®é™…é¡¹ç›®ä¸­ï¼Œéƒ½æ˜¯éœ€è¦æ•°æ®åº“è¿›è¡Œæ“ä½œçš„ï¼Œæœ¬èŠ‚ä½¿ç”¨ **hsqldb å†…å­˜æ•°æ®åº“**è¿›è¡Œè¯´æ˜ã€‚

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Spring Data JPA æ“ä½œæ•°æ®åº“ï¼Œéœ€è¦ä¸€ä¸ªç”¨æˆ·çš„å®ä½“ç±»ï¼Œå†è€…éœ€è¦å®šä¹‰ç›¸åº”çš„ Service è·å–ç”¨æˆ·çš„ä¿¡æ¯ï¼Œæœ€åé‡å†™ `UserDetailsService` çš„ `loadUserByUsername ` æ–¹æ³•ä»æ•°æ®åº“ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä¼ ç»™ Spring Security è¿›è¡Œå¤„ç†ã€‚

## 1. æ·»åŠ ä¾èµ–

æ·»åŠ  **SpringData JPA** å’Œ **hsqldb** çš„ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>

<dependency>
    <groupId>org.hsqldb</groupId>
    <artifactId>hsqldb</artifactId>
    <scope>runtime</scope>
</dependency>
```

## 2. é…ç½®ç±»

```java
@Configuration
@EnableWebSecurity // å¼€å¯Spring Securityçš„åŠŸèƒ½
@EnableGlobalMethodSecurity(prePostEnabled=true)
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

å’Œä¸ŠèŠ‚ä¸€æ ·ï¼Œåªä¸è¿‡æˆ‘ä»¬ä¸éœ€è¦å®ç°è®¤è¯å’Œæˆæƒæ–¹æ³•ã€‚

## 3. åˆ›å»ºå®ä½“ç±»

åˆ›å»º `UserInfo `å®ä½“ç±»ï¼š

```java
@Entity
public class UserInfo {

    public enum Role{
        admin, normal
    }
	
    @Id // ä¸»é”®
    @GeneratedValue // è‡ªå¢
    private long uid;

    private String username;
    private String password;

    @Enumerated(EnumType.STRING)
    private Role role;

    // Getter And Setter
}
```

> ğŸ”º è¿™é‡Œæˆ‘ä»¬å°† `Role `å†™æ­»äº†ï¼Œåé¢ä¼šå°† `Role ` ä½œä¸ºä¸€å¼ æ•°æ®åº“è¡¨è¿›è¡ŒåŠ¨æ€åŠ è½½

## 4. åˆ›å»º Repository(Dao)

åˆ›å»ºå’Œæ•°æ®åº“äº¤äº’çš„ `UserInfoRepository`ï¼š

```java
public interface UserInfoRepository extends JpaRepository<UserInfo,Long> {

    public UserInfo findByUsername(String username);

}
```

## 5. åˆ›å»º Service

åˆ›å»º `UserInfoService`ï¼š

```java
public interface UserInfoService {

    public UserInfo findByUsername(String username);

}
```

åˆ›å»º `UserInfoService` çš„å®ç°ç±»ï¼š

```java
@Service
public class UserInfoServiceImpl implements UserInfoService {

    @Autowired
    private UserInfoRepository userInfoRepository;

    @Override
    public UserInfo findByUsername(String username) {
        return userInfoRepository.findByUsername(username);
    }

}
```

## 6. è‡ªå®šä¹‰ UserDetailsService

ğŸš© <u>æˆ‘ä»¬éœ€è¦ç»§æ‰¿ä¸€ä¸ª `UserDetailSevice` æ¥å£å¹¶ä¸”åŠ å…¥åˆ°å®¹å™¨ä¸­ï¼Œå®ç° `loadUserByUsername` æ–¹æ³•ï¼Œé‡Œé¢çš„é€»è¾‘é€šå¸¸æ˜¯ä»æ•°æ®åº“æŸ¥æ‰¾å‡ºå¯¹åº”ç”¨æˆ·åçš„å¯†ç ç„¶åæ„é€ ä¸€ä¸ª `UserDetail` å¯¹è±¡ï¼ŒSpring Securityä¼šæ ¹æ®è¿”å›çš„è¿™ä¸ªå¸¦æœ‰æ­£ç¡®ç”¨æˆ·ä¿¡æ¯çš„å¯¹è±¡å’Œå‰å°ä¼ è¿‡æ¥çš„ç”¨æˆ·åå¯†ç è¿›è¡Œæ¯”å¯¹æ¥åˆ¤æ–­æ˜¯å¦è®¤è¯é€šè¿‡ã€‚</u>

å®ç°  `UserDetailsService` ç±»çš„ `loadUserByUsername `æ–¹æ³•ï¼š

```java
import org.springframework.security.core.userdetails.UserDetailsService;

......

@Service
public class CustomUserDetailService implements UserDetailsService {

    @Autowired
    private UserInfoService userInfoService;
    @Autowired
    private PasswordEncoder passwordEncoder;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        System.out.println("CustomUserDetailService.loadUserByUsername()");
        // é€šè¿‡ username è·å–ç”¨æˆ·ä¿¡æ¯
        UserInfo userInfo = userInfoService.findByUsername(username);
        if(userInfo == null)
            throw new UsernameNotFoundException("not found");


        // å®šä¹‰æƒé™åˆ—è¡¨
        List<GrantedAuthority> authorities = new ArrayList<>();
        // ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æƒé™ å¿…é¡»ä»¥ ROLE_ å¼€å¤´
        authorities.add(new SimpleGrantedAuthority("ROLE_" + userInfo.getRole().name()));

        // è¿™é‡Œçš„å¯†ç éœ€è¦ä½¿ç”¨PasswordEncoderè¿›è¡ŒåŠ å¯†ï¼Œå¦åˆ™ä¼šæŠ¥é”™
        User userDetails = new User(userInfo.getUsername(), passwordEncoder.encode(userInfo.getPassword()), authorities);
        return userDetails;
    }
}
```

## 7. Controller

å’Œä¸ŠèŠ‚ä¸€æ ·ï¼š

```java
@RestController
public class HelloController {

    @RequestMapping("/hello")
    public String hello() {
        return "Hello,Spring Security";
    }

    @RequestMapping("/helloAdmin")
    @PreAuthorize("hasAnyRole('admin')") // åªå…è®¸è§’è‰² admin è®¿é—®
    public String helloAdmin() {
        return "Hello,admin";
    }

    @RequestMapping("/helloUser")
    @PreAuthorize("hasAnyRole('admin','normal')") // å…è®¸è§’è‰² admin å’Œ normal è®¿é—®
    public String helloUser() {
        return "Hello,user";
    }
}
```

## 8. åˆå§‹åŒ–æµ‹è¯•è´¦å·

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª `DataInit` ç±»ï¼Œåˆå§‹åŒ–ä¸¤ä¸ªè´¦å·admin/123å’Œuser/123ï¼š

```java
@Service
public class DataInit {

    @Autowired
    UserInfoRepository userInfoRepository;

    @PostConstruct
    public void dataInit(){

        // ç”¨æˆ· admin
        UserInfo admin = new UserInfo();
        admin.setUsername("admin");
        admin.setPassword("123");
        admin.setRole(UserInfo.Role.admin);
        userInfoRepository.save(admin);

        // ç”¨æˆ· user
        UserInfo user = new UserInfo();
        user.setUsername("user");
        user.setPassword("123");
        user.setRole(UserInfo.Role.normal);
        userInfoRepository.save(user);
    }
}
```

## 9. æµ‹è¯•

æµ‹è¯•è´¦å·ï¼šadmin/123ï¼Œä¸Šé¢çš„ä¸¤ä¸ªåœ°å€åº”è¯¥éƒ½æ˜¯å¯ä»¥æ­£å¸¸è®¿é—®çš„ã€‚

æµ‹è¯•è´¦å·ï¼šuser/123ï¼Œåªèƒ½è®¿é—®  [http://127.0.0.1:8080/helloUser](http://127.0.0.1:8080/helloUser)

## ğŸ“š References

- [æ—ç¥¥çº¤ - Spring Boot+Spring Security ç³»åˆ—](https://www.iteye.com/blog/412887952-qq-com-2441544)