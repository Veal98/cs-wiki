# ğŸ’¦ åºåˆ—åŒ–åè®® Protostuff åŸºæœ¬ä½¿ç”¨

---

ä¸€å¼€å§‹å†™è¿™ä¸ªæ¡†æ¶çš„æ—¶å€™ï¼Œå‡†å¤‡ç”¨çš„æ˜¯ Kryo è¿›è¡Œåºåˆ—åŒ–çš„ï¼Œä½†æ˜¯å†™å®Œæ€»æ˜¯å‡ºç°åºåˆ—åŒ–å¤±è´¥çš„é—®é¢˜ï¼Œè‹¦è§£æ— æœåï¼Œé‚è½¬å‘ Protostuffã€‚å¤§ ğŸ”¥ å¯å‚è§é¡¹ç›®ä¸­çš„ `KryoSerializer` æ–‡ä»¶ï¼Œå¦‚æœèƒ½è§£å†³é—®é¢˜è¯·æ PRï¼Œæ„Ÿæ¿€ä¸å°½ ğŸ˜Šã€‚

## 1. Protostuff ä»‹ç»

**A java serialization libraryï¼ˆé’ˆå¯¹ Java çš„åºåˆ—åŒ–æ¡†æ¶ï¼‰** with built-in support for forward-backward compatibility (schema evolution) and validation.

- **efficient**, both in speed and memory
- **flexible**, supporting pluggable formats

## 2. å¯¼å…¥ä¾èµ–

For the core formats (protostuff, protobuf, graph)

```xml
<dependency>
  <groupId>io.protostuff</groupId>
  <artifactId>protostuff-core</artifactId>
  <version>1.7.2</version>
</dependency>
```

For schemas generated at runtimeï¼š`protostuff-runtime` æ¨¡å—å…è®¸å°†ç°æœ‰çš„ pojo åºåˆ—åŒ–ä¸ºä¸åŒçš„æ ¼å¼

```xml
<dependency>
  <groupId>io.protostuff</groupId>
  <artifactId>protostuff-runtime</artifactId>
  <version>1.7.2</version>
</dependency>
```

â­ **`protostuff-runtime` å®ç°äº†æ— éœ€é¢„ç¼–è¯‘å¯¹ pojo è¿›è¡Œ protobuf åºåˆ—åŒ–/ååºåˆ—åŒ–çš„èƒ½åŠ›ã€‚protostuff-runtime çš„å±€é™æ˜¯åºåˆ—åŒ–å‰éœ€é¢„å…ˆä¼ å…¥ Schemaï¼Œååºåˆ—åŒ–ä¸è´Ÿè´£å¯¹è±¡çš„åˆ›å»ºåªè´Ÿè´£å¤åˆ¶ï¼Œå› è€Œå¯¹è±¡å¿…é¡»æä¾›é»˜è®¤æ„é€ å‡½æ•°ã€‚**

## 3. Schema è¯¦è§£

Protostuff æ— è®ºæ˜¯åœ¨ç¼–è¯‘æ—¶è¿˜æ˜¯è¿è¡Œæ—¶éƒ½ä¼šç”Ÿæˆä¸€ä¸ª**æ¨¡å¼ Schema**ï¼Œé€šè¿‡æä¾›çš„ IO åº“**ä½¿ç”¨ Schema è¯»å–/å†™å…¥å„ç§æ ¼å¼**ã€‚

å…¶å®**æ¨¡å¼ Schema å°±æ˜¯ä¸€ä¸ªå°è£…çš„ç±»**ï¼Œå®ƒåŒ…å«äº†éœ€è¦è¢«åºåˆ—åŒ–/ååºåˆ—åŒ–å¯¹è±¡çš„å„ç§ä¿¡æ¯ï¼š

- the serialization logic of an objectï¼šå¯¹è±¡çš„åºåˆ—åŒ–é€»è¾‘
- the deserialization logic of an objectï¼šå¯¹è±¡çš„ååºåˆ—åŒ–é€»è¾‘
- the validation of an objectâ€™s required fieldsï¼šå¯¹è±¡çš„å¿…å¡«å­—æ®µçš„éªŒè¯
- the mapping of an objectâ€™s field names to field numbersï¼šä¸€ä¸ªå¯¹è±¡çš„å­—æ®µååˆ°å­—æ®µç¼–å·çš„æ˜ å°„
- the instantiation of the objectï¼šå¯¹è±¡çš„å®ä¾‹åŒ–

å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨ç¼–å†™ Schemaï¼Œåªéœ€è¦ç»§æ‰¿ `Schema<T>`ï¼Œ æ³›å‹è¡¨ç¤ºåºåˆ—åŒ–/ååºåˆ—åŒ–çš„å¯¹è±¡ã€‚æ­¤å¤„ä¸å†è¯¦ç»†è§£é‡Šã€‚

## 4. åŸºæœ¬ä½¿ç”¨

```java
public class ProtostuffUtils {
    
    // é¿å…æ¯æ¬¡åºåˆ—åŒ–éƒ½é‡æ–°ç”³è¯·Bufferç©ºé—´
    private static LinkedBuffer buffer = LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE);
    
    // ç¼“å­˜Schema
    private static Map<Class<?>, Schema<?>> schemaCache = new ConcurrentHashMap<>();

    /**
     * åºåˆ—åŒ–æ–¹æ³•ï¼ŒæŠŠæŒ‡å®šå¯¹è±¡åºåˆ—åŒ–æˆå­—èŠ‚æ•°ç»„
     *
     * @param obj
     * @param <T>
     * @return
     */
    @SuppressWarnings("unchecked")
    public static <T> byte[] serialize(T obj) {
        Class<T> clazz = (Class<T>) obj.getClass();
        Schema<T> schema = getSchema(clazz);
        byte[] data;
        try {
            data = ProtostuffIOUtil.toByteArray(obj, schema, buffer);
        } finally {
            buffer.clear();
        }

        return data;
    }

    /**
     * ååºåˆ—åŒ–æ–¹æ³•ï¼Œå°†å­—èŠ‚æ•°ç»„ååºåˆ—åŒ–æˆæŒ‡å®šClassç±»å‹
     *
     * @param data
     * @param clazz
     * @param <T>
     * @return
     */
    public static <T> T deserialize(byte[] data, Class<T> clazz) {
        Schema<T> schema = getSchema(clazz);
        T obj = schema.newMessage();
        ProtostuffIOUtil.mergeFrom(data, obj, schema);
        return obj;
    }

    @SuppressWarnings("unchecked")
    private static <T> Schema<T> getSchema(Class<T> clazz) {
        Schema<T> schema = (Schema<T>) schemaCache.get(clazz);
        if (Objects.isNull(schema)) {
            // è¿™ä¸ª schema é€šè¿‡RuntimeSchemaè¿›è¡Œæ‡’åˆ›å»ºå¹¶ç¼“å­˜
            // æ‰€ä»¥å¯ä»¥ä¸€ç›´è°ƒç”¨ RuntimeSchema.getSchema(),è¿™ä¸ªæ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„
            schema = RuntimeSchema.getSchema(clazz);
            if (Objects.nonNull(schema)) {
                schemaCache.put(clazz, schema);
            }
        }

        return schema;
    }
}
```

ğŸ”¸ åºåˆ—åŒ–ä½¿ç”¨çš„æ˜¯ï¼š

```java
public static <T> byte[] toByteArray(T message, com.dyuproject.protostuff.Schema<T> schema, LinkedBuffer buffer) {
    
}
```

ğŸ”¸ ååºåˆ—åŒ–ä½¿ç”¨çš„æ˜¯ï¼š

```java
public static <T> void mergeFrom(byte[] data, T message, com.dyuproject.protostuff.Schema<T> schema) {
    
}
```

## ğŸ“š References

- [Github - Protostuff](https://github.com/protostuff/protostuff)
- [LuoLiangDSGA - åˆæ¢Protostuffçš„ä½¿ç”¨ - CSDN](https://blog.csdn.net/oppo5630/article/details/80173520)