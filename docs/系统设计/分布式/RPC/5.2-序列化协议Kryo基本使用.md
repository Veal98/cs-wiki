# ğŸ’« Kryo ç®€ä»‹åŠåŸºæœ¬ä½¿ç”¨

---

## 1. æ¦‚è¿°

Kryo æ˜¯ä¸€ä¸ªå¿«é€Ÿé«˜æ•ˆçš„ Java å¯¹è±¡å›¾å½¢**åºåˆ—åŒ–æ¡†æ¶**ï¼Œä¸»è¦ç‰¹ç‚¹æ˜¯æ€§èƒ½ã€é«˜æ•ˆå’Œæ˜“ç”¨ã€‚**è¯¥é¡¹ç›®ç”¨æ¥åºåˆ—åŒ–å¯¹è±¡åˆ°æ–‡ä»¶ã€æ•°æ®åº“æˆ–è€…ç½‘ç»œ**ã€‚

To use the latest Kryo release in your application, use this dependency entry in your `pom.xml`:

```xml
<dependency>
   <groupId>com.esotericsoftware</groupId>
   <artifactId>kryo</artifactId>
   <version>5.0.3</version>
</dependency>
```

## 2. å¿«é€Ÿå…¥é—¨

ç¤ºä¾‹ä»£ç ï¼š

```java
import com.esotericsoftware.kryo.Kryo;
import com.esotericsoftware.kryo.io.Input;
import com.esotericsoftware.kryo.io.Output;
import java.io.*;

public class HelloKryo {
   static public void main (String[] args) throws Exception {
      Kryo kryo = new Kryo();
      kryo.register(SomeClass.class);

      SomeClass object = new SomeClass();
      object.value = "Hello Kryo!";
	 
      // åºåˆ—åŒ–
      Output output = new Output(new FileOutputStream("file.bin"));
      kryo.writeObject(output, object);
      output.close();
	 
      // ååºåˆ—åŒ–
      Input input = new Input(new FileInputStream("file.bin"));
      SomeClass object2 = kryo.readObject(input, SomeClass.class);
      input.close();   
   }
   static public class SomeClass {
      String value;
   }
}
```

## 3. ä¸‰ç§è¯»å†™æ–¹å¼

Kryo å…±æ”¯æŒä¸‰ç§è¯»å†™æ–¹å¼

**1. å¦‚æœçŸ¥é“ class å­—èŠ‚ç ï¼Œå¹¶ä¸”å¯¹è±¡ä¸ä¸ºç©º**

```java
  kryo.writeObject(output, someObject);
    // ...
    SomeClass someObject = kryo.readObject(input, SomeClass.class);
```

å¿«é€Ÿå…¥é—¨ä¸­çš„åºåˆ—åŒ–/ååºåˆ—åŒ–çš„æ–¹å¼ä¾¿æ˜¯è¿™ä¸€ç§ã€‚è€Œ Kryo è€ƒè™‘åˆ° someObject å¯èƒ½ä¸ºnullï¼Œä¹Ÿä¼šå¯¼è‡´è¿”å›çš„ç»“æœä¸ºnullï¼Œæ‰€ä»¥æä¾›äº†ç¬¬äºŒå¥—è¯»å†™æ–¹å¼ã€‚

**2. å¦‚æœçŸ¥é“ class å­—èŠ‚ç ï¼Œå¹¶ä¸”å¯¹è±¡å¯èƒ½ä¸ºç©º**

```java
  kryo.writeObjectOrNull(output, someObject);
    // ...
    SomeClass someObject = kryo.readObjectOrNull(input, SomeClass.class);
```

ä½†è¿™ä¸¤ç§æ–¹æ³•ä¼¼ä¹éƒ½ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œåœ¨ RPC è°ƒç”¨ä¸­ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–åˆ†å¸ƒåœ¨ä¸åŒçš„ç«¯ç‚¹ï¼Œå¯¹è±¡çš„ç±»å‹ç¡®å®šï¼Œæˆ‘ä»¬ä¸æƒ³ä¾èµ–äºæ‰‹åŠ¨æŒ‡å®šå‚æ•°ï¼Œ**æœ€å¥½æ˜¯å°†å­—èŠ‚ç çš„ä¿¡æ¯ç›´æ¥å­˜æ”¾åˆ°åºåˆ—åŒ–ç»“æœä¸­ï¼Œåœ¨ååºåˆ—åŒ–æ—¶è‡ªè¡Œè¯»å–å­—èŠ‚ç ä¿¡æ¯**ã€‚Kryo è€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ï¼Œäºæ˜¯æä¾›äº†ç¬¬ä¸‰ç§æ–¹å¼ã€‚

**3. å¦‚æœå®ç°ç±»çš„å­—èŠ‚ç æœªçŸ¥ï¼Œå¹¶ä¸”å¯¹è±¡å¯èƒ½ä¸º null**

```java
  kryo.writeClassAndObject(output, object);
    // ...
    Object object = kryo.readClassAndObject(input);
    if (object instanceof SomeClass) {
       // ...
    }
```

æˆ‘ä»¬ç‰ºç‰²äº†ä¸€äº›ç©ºé—´ä¸€äº›æ€§èƒ½å»å­˜æ”¾å­—èŠ‚ç ä¿¡æ¯ï¼Œä½†è¿™ç§æ–¹å¼æ˜¯æˆ‘ä»¬åœ¨ RPC ä¸­åº”å½“ä½¿ç”¨çš„æ–¹å¼ã€‚

## 4. æ”¯æŒçš„åºåˆ—åŒ–ç±»å‹

![](https://gitee.com/veal98/images/raw/master/img/20201215214220.png)

è¿™éƒ½æ˜¯å…¶é»˜è®¤æ”¯æŒçš„ã€‚

```java
Kryo kryo = new Kryo();
kryo.addDefaultSerializer(SomeClass.class, SomeSerializer.class);
```

è¿™æ ·çš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ä¸ºä¸€ä¸ª Kryo å®ä¾‹æ‰©å±•åºåˆ—åŒ–å™¨ã€‚

æ€»ä½“è€Œè¨€ï¼ŒKryoæ”¯æŒä»¥ä¸‹çš„ç±»å‹ï¼š

- æšä¸¾
- é›†åˆã€æ•°ç»„
- å­ç±»/å¤šæ€
- å¾ªç¯å¼•ç”¨
- å†…éƒ¨ç±»
- æ³›å‹

ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**Kryoä¸æ”¯æŒBeanä¸­å¢åˆ å­—æ®µ**ã€‚å¦‚æœä½¿ç”¨Kryoåºåˆ—åŒ–äº†ä¸€ä¸ªç±»ï¼Œå­˜å…¥äº†Redisï¼Œå¯¹ç±»è¿›è¡Œäº†ä¿®æ”¹ï¼Œä¼šå¯¼è‡´ååºåˆ—åŒ–çš„å¼‚å¸¸ã€‚

å¦å¤–éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ä½¿ç”¨åå°„åˆ›å»ºçš„ä¸€äº›ç±»åºåˆ—åŒ–çš„æ”¯æŒã€‚å¦‚ä½¿ç”¨`Arrays.asList();`åˆ›å»ºçš„ `List` å¯¹è±¡ï¼Œä¼šå¼•èµ·åºåˆ—åŒ–å¼‚å¸¸ã€‚

```text
Exception in thread "main" com.esotericsoftware.kryo.KryoException: Class cannot be created (missing no-arg constructor): java.util.Arrays$ArrayList
```

ä½†`new ArrayList()`åˆ›å»ºçš„`List`å¯¹è±¡åˆ™ä¸ä¼šï¼Œä½¿ç”¨æ—¶éœ€è¦æ³¨æ„ï¼Œå¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“å¯¹ Kryo è¿›è¡Œåºåˆ—åŒ–ç±»å‹çš„æ‰©å±•ã€‚å¦‚[https://github.com/magro/kryo-serializers](https://link.zhihu.com/?target=https%3A//github.com/magro/kryo-serializers)æ‰€æä¾›çš„ã€‚

**ä¸æ”¯æŒåŒ…å«æ— å‚æ„é€ å™¨ç±»çš„ååºåˆ—åŒ–**ï¼Œå°è¯•ååºåˆ—åŒ–ä¸€ä¸ªä¸åŒ…å«æ— å‚æ„é€ å™¨çš„ç±»å°†ä¼šå¾—åˆ°ä»¥ä¸‹çš„å¼‚å¸¸ï¼š

```text
Exception in thread "main" com.esotericsoftware.kryo.KryoException: Class cannot be created (missing no-arg constructor): moe.cnkirito.Xxx
```

**ä¿è¯æ¯ä¸ªç±»å…·æœ‰æ— å‚æ„é€ å™¨æ˜¯åº”å½“éµå®ˆçš„ç¼–ç¨‹è§„èŒƒ**ï¼Œä½†å®é™…å¼€å‘ä¸­ä¸€äº›ç¬¬ä¸‰åº“çš„ç›¸å…³ç±»ä¸åŒ…å«æ— å‚æ„é€ ï¼Œçš„ç¡®æ˜¯æœ‰ç‚¹éº»çƒ¦ã€‚

## 5. çº¿ç¨‹å®‰å…¨

Kryoæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œæ„å‘³ç€æ¯å½“éœ€è¦åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶éƒ½éœ€è¦å®ä¾‹åŒ–ä¸€æ¬¡ï¼Œæˆ–è€…å€ŸåŠ©`ThreadLocal`æ¥ç»´æŠ¤ä»¥ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ã€‚

```java
private static final ThreadLocal<Kryo> KryoThreadLocal = new ThreadLocal<Kryo>() {
    protected Kryo initialValue() {
        Kryo kryo = new Kryo();
        // configure kryo instance, customize settings
        return kryo;
    };
};

// Somewhere else, use Kryo
Kryo k = KryoThreadLocal.get();
...
```

## 6. Kryo ç›¸å…³é…ç½®å‚æ•°è¯¦è§£

æ¯ä¸ª Kryo å®ä¾‹éƒ½å¯ä»¥æ‹¥æœ‰ä¸¤ä¸ªé…ç½®å‚æ•°

```java
kryo.setRegistrationRequired(false); // å…³é—­æ³¨å†Œè¡Œä¸º(é»˜è®¤)
kryo.setReferences(true); // æ”¯æŒå¾ªç¯å¼•ç”¨
```

å½“ **kryo å†™ä¸€ä¸ªå¯¹è±¡çš„å®ä¾‹çš„æ—¶å€™ï¼Œé»˜è®¤éœ€è¦å°†ç±»çš„å®Œå…¨é™å®šåç§°å†™å…¥**ã€‚å°†ç±»åä¸€åŒå†™å…¥åºåˆ—åŒ–æ•°æ®ä¸­æ˜¯æ¯”è¾ƒä½æ•ˆçš„ï¼Œæ‰€ä»¥ kryo æ”¯æŒé€šè¿‡ç±»æ³¨å†Œè¿›è¡Œä¼˜åŒ–ã€‚å¦‚

```java
Kryo kryo = new Kryo();
kryo.register(SomeClass.class);
// ...
Output output = ...
SomeClass someObject = ...
kryo.writeObject(output, someObject);
```

è¿™ä¼šèµ‹äºˆè¯¥ Class ä¸€ä¸ªä» 0 å¼€å§‹çš„ç¼–å·ï¼Œä½† Kryo ä½¿ç”¨æ³¨å†Œè¡Œä¸ºæœ€å¤§çš„é—®é¢˜åœ¨äºï¼Œå…¶**ä¸ä¿è¯åŒä¸€ä¸ª Class æ¯ä¸€æ¬¡æ³¨å†Œçš„å·ç ç›¸åŒï¼Œè¿™ä¸æ³¨å†Œçš„é¡ºåºæœ‰å…³**ï¼Œä¹Ÿå°±æ„å‘³ç€åœ¨ä¸åŒçš„æœºå™¨ã€åŒä¸€ä¸ªæœºå™¨é‡å¯å‰åéƒ½æœ‰å¯èƒ½æ‹¥æœ‰ä¸åŒçš„ç¼–å·ï¼Œè¿™ä¼šå¯¼è‡´åºåˆ—åŒ–äº§ç”Ÿé—®é¢˜ï¼Œ**æ‰€ä»¥åœ¨åˆ†å¸ƒå¼é¡¹ç›®ä¸­ï¼Œä¸€èˆ¬å…³é—­æ³¨å†Œè¡Œä¸º**ã€‚

ç¬¬äºŒä¸ªæ³¨æ„ç‚¹åœ¨äºå¾ªç¯å¼•ç”¨ï¼ŒKryo ä¸ºäº†è¿½æ±‚é«˜æ€§èƒ½ï¼Œå¯ä»¥å…³é—­å¾ªç¯å¼•ç”¨çš„æ”¯æŒã€‚ä¸è¿‡æˆ‘å¹¶ä¸è®¤ä¸ºå…³é—­å®ƒæ˜¯ä¸€ä»¶å¥½çš„é€‰æ‹©ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¯·ä¿æŒ `kryo.setReferences(true)`ã€‚

## 7. å¸¸ç”¨ Kryo å·¥å…·ç±»

```java
public class KryoSerializer {
    public byte[] serialize(Object obj) {
        Kryo kryo = KryoThreadLocal.get();
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        Output output = new Output(byteArrayOutputStream);//<1>
        kryo.writeClassAndObject(output, obj);//<2>
        output.close();
        return byteArrayOutputStream.toByteArray();
    }

    public <T> T deserialize(byte[] bytes) {
        Kryo kryo = KryoThreadLocal.get();
        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(bytes);
        Input input = new Input(byteArrayInputStream);// <1>
        input.close();
        return (T) kryo.readClassAndObject(input);//<2>
    }

    private static final ThreadLocal<Kryo> KryoThreadLocal = new ThreadLocal<Kryo>() {//<3>
        @Override
        protected Kryo initialValue() {
            Kryo kryo = new Kryo();
            kryo.setReferences(true); // é»˜è®¤å€¼ä¸ºtrue
            kryo.setRegistrationRequired(false); //é»˜è®¤å€¼ä¸º false
            return kryo;
        }
    };

}
```

- <1> Kryoçš„`Input`å’Œ`Output`æ¥æ”¶ä¸€ä¸ª`InputStream`å’Œ`OutputStream`ï¼ŒKryoé€šå¸¸å®Œæˆå­—èŠ‚æ•°ç»„å’Œå¯¹è±¡çš„è½¬æ¢ï¼Œæ‰€ä»¥å¸¸ç”¨çš„è¾“å…¥è¾“å‡ºæµå®ç°ä¸º`ByteArrayInputStream`/`ByteArrayOutputStream`ã€‚

- <2> **è®°å½•ç±»å‹ä¿¡æ¯**çš„ `writeClassAndObject`å’Œ`readClassAndObject `é…å¯¹ä½¿ç”¨åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹æ˜¯æœ€å¸¸è§çš„ï¼Œè¿™ç®—æ˜¯ kryo çš„ä¸€ä¸ªç‰¹ç‚¹ï¼Œ**å¯ä»¥æŠŠå¯¹è±¡ä¿¡æ¯ç›´æ¥å†™åˆ°åºåˆ—åŒ–æ•°æ®é‡Œï¼Œååºåˆ—åŒ–çš„æ—¶å€™å¯ä»¥ç²¾ç¡®åœ°æ‰¾åˆ°åŸå§‹ç±»ä¿¡æ¯ï¼Œä¸ä¼šå‡ºé”™ï¼Œè¿™æ„å‘³ç€åœ¨å†™ `readxxx` æ–¹æ³•æ—¶ï¼Œæ— éœ€ä¼ å…¥ Class æˆ– Type ç±»ä¿¡æ¯**ã€‚

- <3> ä½¿ç”¨`ThreadLocal`ç»´æŠ¤Kryoå®ä¾‹ï¼Œè¿™æ ·å‡å°‘äº†æ¯æ¬¡ä½¿ç”¨éƒ½å®ä¾‹åŒ–ä¸€æ¬¡ Kryo çš„å¼€é”€åˆå¯ä»¥ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ã€‚
