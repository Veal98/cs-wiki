# ğŸ‘¿ Keras åŸºæœ¬å›¾åƒåˆ†ç±»

---

æœ¬æŒ‡å—å°†è®­ç»ƒä¸€ä¸ªç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œå¯¹è¿åŠ¨é‹å’Œè¡¬è¡«ç­‰æœè£…å›¾åƒè¿›è¡Œåˆ†ç±»ã€‚å³ä½¿æ‚¨ä¸ç†è§£æ‰€æœ‰ç»†èŠ‚ä¹Ÿæ²¡å…³ç³»ï¼›è¿™åªæ˜¯å¯¹å®Œæ•´ TensorFlow ç¨‹åºçš„å¿«é€Ÿæ¦‚è¿°ï¼Œè¯¦ç»†å†…å®¹ä¼šåœ¨æ‚¨å®é™…æ“ä½œçš„åŒæ—¶è¿›è¡Œä»‹ç»ã€‚

æœ¬æŒ‡å—ä½¿ç”¨äº† [tf.keras](https://tensorflow.google.cn/guide/keras?hl=zh_cn)ï¼Œå®ƒæ˜¯ TensorFlow ä¸­ç”¨æ¥æ„å»ºå’Œè®­ç»ƒæ¨¡å‹çš„é«˜çº§ APIã€‚

```python
# TensorFlow and tf.keras
import tensorflow as tf
from tensorflow import keras

# Helper libraries
import numpy as np
import matplotlib.pyplot as plt

print(tf.__version__)
2.3.1
```

## 1. å¯¼å…¥ Fashion MNIST æ•°æ®é›†

æœ¬æŒ‡å—ä½¿ç”¨ [Fashion MNIST](https://github.com/zalandoresearch/fashion-mnist) æ•°æ®é›†ï¼Œè¯¥æ•°æ®é›†åŒ…å« 10 ä¸ªç±»åˆ«çš„ 70,000 ä¸ªç°åº¦å›¾åƒã€‚è¿™äº›å›¾åƒä»¥ä½åˆ†è¾¨ç‡ï¼ˆ28x28 åƒç´ ï¼‰å±•ç¤ºäº†å•ä»¶è¡£ç‰©ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://gitee.com/veal98/images/raw/master/img/20201104114844.png)

> ğŸ’¡ Fashion MNIST æ—¨åœ¨ä¸´æ—¶æ›¿ä»£ç»å…¸ [MNIST](http://yann.lecun.com/exdb/mnist/) æ•°æ®é›†ï¼Œåè€…å¸¸è¢«ç”¨ä½œè®¡ç®—æœºè§†è§‰æœºå™¨å­¦ä¹ ç¨‹åºçš„â€œHello, Worldâ€ã€‚MNIST æ•°æ®é›†åŒ…å«æ‰‹å†™æ•°å­—ï¼ˆ0ã€1ã€2 ç­‰ï¼‰çš„å›¾åƒï¼Œå…¶æ ¼å¼ä¸æ‚¨å°†ä½¿ç”¨çš„è¡£ç‰©å›¾åƒçš„æ ¼å¼ç›¸åŒã€‚

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ 60,000 ä¸ªå›¾åƒæ¥è®­ç»ƒç½‘ç»œï¼Œä½¿ç”¨ 10,000 ä¸ªå›¾åƒæ¥è¯„ä¼°ç½‘ç»œå­¦ä¹ å¯¹å›¾åƒåˆ†ç±»çš„å‡†ç¡®ç‡ã€‚æ‚¨å¯ä»¥ç›´æ¥ä» TensorFlow è®¿é—® Fashion MNISTã€‚è¯·è¿è¡Œä»¥ä¸‹ä»£ç ï¼Œç›´æ¥ä» TensorFlow ä¸­å¯¼å…¥å’ŒåŠ è½½ Fashion MNIST æ•°æ®ï¼š

```python
fashion_mnist = keras.datasets.fashion_mnist

(train_images, train_labels), (test_images, test_labels) = fashion_mnist.load_data()
```

åŠ è½½æ•°æ®é›†ä¼šè¿”å›å››ä¸ª NumPy æ•°ç»„ï¼š

- `train_images` å’Œ `train_labels` æ•°ç»„æ˜¯*è®­ç»ƒé›†*ï¼Œå³æ¨¡å‹ç”¨äºå­¦ä¹ çš„æ•°æ®ã€‚
- *æµ‹è¯•é›†* `test_images` å’Œ `test_labels` æ•°ç»„ä¼šè¢«ç”¨æ¥å¯¹æ¨¡å‹è¿›è¡Œæµ‹è¯•ã€‚

å›¾åƒæ˜¯ 28x28 çš„ NumPy æ•°ç»„ï¼Œåƒç´ å€¼ä»‹äº 0 åˆ° 255 ä¹‹é—´ã€‚*æ ‡ç­¾*æ˜¯æ•´æ•°æ•°ç»„ï¼Œä»‹äº 0 åˆ° 9 ä¹‹é—´ã€‚è¿™äº›æ ‡ç­¾å¯¹åº”äºå›¾åƒæ‰€ä»£è¡¨çš„æœè£…*ç±»*ï¼š

| æ ‡ç­¾ | ç±»       |
| :--- | :------- |
| 0    | Tæ¤/ä¸Šè¡£ |
| 1    | è£¤å­     |
| 2    | å¥—å¤´è¡«   |
| 3    | è¿è¡£è£™   |
| 4    | å¤–å¥—     |
| 5    | å‡‰é‹     |
| 6    | è¡¬è¡«     |
| 7    | è¿åŠ¨é‹   |
| 8    | åŒ…       |
| 9    | çŸ­é´     |

æ¯ä¸ªå›¾åƒéƒ½ä¼šè¢«æ˜ å°„åˆ°ä¸€ä¸ªæ ‡ç­¾ã€‚ç”±äºæ•°æ®é›†ä¸åŒ…æ‹¬*ç±»åç§°*ï¼Œè¯·å°†å®ƒä»¬å­˜å‚¨åœ¨ä¸‹æ–¹ï¼Œä¾›ç¨åç»˜åˆ¶å›¾åƒæ—¶ä½¿ç”¨ï¼š

```python
class_names = ['T-shirt/top', 'Trouser', 'Pullover', 'Dress', 'Coat',
               'Sandal', 'Shirt', 'Sneaker', 'Bag', 'Ankle boot']
```

## 2. æµè§ˆæ•°æ®

åœ¨è®­ç»ƒæ¨¡å‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæµè§ˆä¸€ä¸‹æ•°æ®é›†çš„æ ¼å¼ã€‚ä»¥ä¸‹ä»£ç æ˜¾ç¤ºè®­ç»ƒé›†ä¸­æœ‰ 60,000 ä¸ªå›¾åƒï¼Œæ¯ä¸ªå›¾åƒç”± 28 x 28 çš„åƒç´ è¡¨ç¤ºï¼š

```python
train_images.shape
(60000, 28, 28)
```

åŒæ ·ï¼Œè®­ç»ƒé›†ä¸­æœ‰ 60,000 ä¸ªæ ‡ç­¾ï¼š

```python
len(train_labels)
60000
```

æ¯ä¸ªæ ‡ç­¾éƒ½æ˜¯ä¸€ä¸ª 0 åˆ° 9 ä¹‹é—´çš„æ•´æ•°ï¼š

```python
train_labels
array([9, 0, 0, ..., 3, 0, 5], dtype=uint8)
```

æµ‹è¯•é›†ä¸­æœ‰ 10,000 ä¸ªå›¾åƒã€‚åŒæ ·ï¼Œæ¯ä¸ªå›¾åƒéƒ½ç”± 28x28 ä¸ªåƒç´ è¡¨ç¤ºï¼š

```python
test_images.shape
(10000, 28, 28)
```

æµ‹è¯•é›†åŒ…å« 10,000 ä¸ªå›¾åƒæ ‡ç­¾ï¼š

```python
len(test_labels)
10000
```

## 3. é¢„å¤„ç†æ•°æ®

åœ¨è®­ç»ƒç½‘ç»œä¹‹å‰ï¼Œå¿…é¡»å¯¹æ•°æ®è¿›è¡Œé¢„å¤„ç†ã€‚å¦‚æœæ‚¨æ£€æŸ¥è®­ç»ƒé›†ä¸­çš„ç¬¬ä¸€ä¸ªå›¾åƒï¼Œæ‚¨ä¼šçœ‹åˆ°åƒç´ å€¼å¤„äº 0 åˆ° 255 ä¹‹é—´ï¼š

```python
plt.figure()
plt.imshow(train_images[0])
plt.colorbar()
plt.grid(False)
plt.show()
```

<img src="https://gitee.com/veal98/images/raw/master/img/20201104203424.png" style="zoom:50%;" />

å°†è¿™äº›å€¼ç¼©å°è‡³ 0 åˆ° 1 ä¹‹é—´ï¼ˆå½’ä¸€åŒ–ï¼‰ï¼Œç„¶åå°†å…¶é¦ˆé€åˆ°ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚ä¸ºæ­¤ï¼Œè¯·å°†è¿™äº›å€¼é™¤ä»¥ 255ã€‚è¯·åŠ¡å¿…ä»¥ç›¸åŒçš„æ–¹å¼å¯¹*è®­ç»ƒé›†*å’Œ*æµ‹è¯•é›†*è¿›è¡Œé¢„å¤„ç†ï¼š

```python
train_images = train_images / 255.0

test_images = test_images / 255.0
```

ä¸ºäº†éªŒè¯æ•°æ®çš„æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠæ‚¨æ˜¯å¦å·²å‡†å¤‡å¥½æ„å»ºå’Œè®­ç»ƒç½‘ç»œï¼Œè®©æˆ‘ä»¬æ˜¾ç¤º*è®­ç»ƒé›†*ä¸­çš„å‰ 25 ä¸ªå›¾åƒï¼Œå¹¶åœ¨æ¯ä¸ªå›¾åƒä¸‹æ–¹æ˜¾ç¤ºç±»åç§°ã€‚

```python
plt.figure(figsize=(10,10))
for i in range(25):
    plt.subplot(5,5,i+1)
    plt.xticks([])
    plt.yticks([])
    plt.grid(False)
    plt.imshow(train_images[i])
    plt.xlabel(class_names[train_labels[i]])
plt.show()
```

<img src="https://gitee.com/veal98/images/raw/master/img/20201104203820.png" style="zoom: 50%;" />

## 4. æ„å»ºæ¨¡å‹

æ„å»ºç¥ç»ç½‘ç»œéœ€è¦å…ˆé…ç½®æ¨¡å‹çš„å±‚ï¼Œç„¶åå†ç¼–è¯‘æ¨¡å‹ã€‚

### â‘  è®¾ç½®å±‚

ç¥ç»ç½‘ç»œçš„åŸºæœ¬ç»„æˆéƒ¨åˆ†æ˜¯*å±‚*ã€‚å±‚ä¼šä»å‘å…¶é¦ˆé€çš„æ•°æ®ä¸­æå–è¡¨ç¤ºå½¢å¼ã€‚å¸Œæœ›è¿™äº›è¡¨ç¤ºå½¢å¼æœ‰åŠ©äºè§£å†³æ‰‹å¤´ä¸Šçš„é—®é¢˜ã€‚

å¤§å¤šæ•°æ·±åº¦å­¦ä¹ éƒ½åŒ…æ‹¬å°†ç®€å•çš„å±‚é“¾æ¥åœ¨ä¸€èµ·ã€‚å¤§å¤šæ•°å±‚ï¼ˆå¦‚ [`tf.keras.layers.Dense`](https://tensorflow.google.cn/api_docs/python/tf/keras/layers/Dense?hl=zh_cn)ï¼‰éƒ½å…·æœ‰åœ¨è®­ç»ƒæœŸé—´æ‰ä¼šå­¦ä¹ çš„å‚æ•°ã€‚

> ğŸ’¡ ä½¿ç”¨ `Keras` æ¥å£æœ‰ä»¥ä¸‹ 3 ç§æ–¹å¼æ„å»ºæ¨¡å‹ï¼šä½¿ç”¨ `Sequential` æŒ‰å±‚é¡ºåºæ„å»ºæ¨¡å‹ï¼Œä½¿ç”¨å‡½æ•°å¼ API æ„å»ºä»»æ„ç»“æ„æ¨¡å‹ï¼Œç»§æ‰¿ `Model` åŸºç±»æ„å»ºè‡ªå®šä¹‰æ¨¡å‹ã€‚
>
> æ­¤å¤„é€‰æ‹©ä½¿ç”¨æœ€ç®€å•çš„ `Sequential`ï¼ŒæŒ‰å±‚é¡ºåºæ¨¡å‹ã€‚

```python
model = keras.Sequential([
    keras.layers.Flatten(input_shape=(28, 28)),
    keras.layers.Dense(128, activation='relu'),
    keras.layers.Dense(10)
])
```

è¯¥ç½‘ç»œçš„ç¬¬ä¸€å±‚ [`tf.keras.layers.Flatten`](https://tensorflow.google.cn/api_docs/python/tf/keras/layers/Flatten?hl=zh_cn) å°†å›¾åƒæ ¼å¼ä»äºŒç»´æ•°ç»„ï¼ˆ28 x 28 åƒç´ ï¼‰è½¬æ¢æˆä¸€ç»´æ•°ç»„ï¼ˆ28 x 28 = 784 åƒç´ ï¼‰ã€‚å°†è¯¥å±‚è§†ä¸ºå›¾åƒä¸­æœªå †å çš„åƒç´ è¡Œå¹¶å°†å…¶æ’åˆ—èµ·æ¥ã€‚è¯¥å±‚æ²¡æœ‰è¦å­¦ä¹ çš„å‚æ•°ï¼Œå®ƒåªä¼šé‡æ–°æ ¼å¼åŒ–æ•°æ®ã€‚

å±•å¹³åƒç´ åï¼Œç½‘ç»œä¼šåŒ…æ‹¬ä¸¤ä¸ª [`tf.keras.layers.Dense`](https://tensorflow.google.cn/api_docs/python/tf/keras/layers/Dense?hl=zh_cn) å±‚çš„åºåˆ—ã€‚å®ƒä»¬æ˜¯å¯†é›†è¿æ¥æˆ–å…¨è¿æ¥ç¥ç»å±‚ã€‚ç¬¬ä¸€ä¸ª `Dense` å±‚æœ‰ 128 ä¸ªèŠ‚ç‚¹ï¼ˆæˆ–ç¥ç»å…ƒï¼‰ã€‚ç¬¬äºŒä¸ªï¼ˆä¹Ÿæ˜¯æœ€åä¸€ä¸ªï¼‰å±‚ä¼šè¿”å›ä¸€ä¸ªé•¿åº¦ä¸º 10 çš„å¯¹æ•°æ•°ç»„ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«ä¸€ä¸ªå¾—åˆ†ï¼Œç”¨æ¥è¡¨ç¤ºå½“å‰å›¾åƒå±äº 10 ä¸ªç±»ä¸­çš„å“ªä¸€ç±»ã€‚

### â‘¡ ç¼–è¯‘æ¨¡å‹ compile

åœ¨å‡†å¤‡å¯¹æ¨¡å‹è¿›è¡Œè®­ç»ƒä¹‹å‰ï¼Œè¿˜éœ€è¦å†å¯¹å…¶è¿›è¡Œä¸€äº›è®¾ç½®ã€‚ä»¥ä¸‹å†…å®¹æ˜¯åœ¨æ¨¡å‹çš„*ç¼–è¯‘*æ­¥éª¤ä¸­æ·»åŠ çš„ï¼š

- *æŸå¤±å‡½æ•°* `loss` - ç”¨äºæµ‹é‡æ¨¡å‹åœ¨è®­ç»ƒæœŸé—´çš„å‡†ç¡®ç‡ã€‚æ‚¨ä¼šå¸Œæœ›æœ€å°åŒ–æ­¤å‡½æ•°ï¼Œä»¥ä¾¿å°†æ¨¡å‹â€œå¼•å¯¼â€åˆ°æ­£ç¡®çš„æ–¹å‘ä¸Šã€‚

  > ğŸ’¡ æŸå¤±å‡½æ•°åŒ…å«å¦‚ä¸‹ï¼š
  >
  > [`class BinaryCrossentropy`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/BinaryCrossentropy): Computes the cross-entropy loss between true labels and predicted labels.
  >
  > [`class CategoricalCrossentropy`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/CategoricalCrossentropy): Computes the crossentropy loss between the labels and predictions.
  >
  > [`class CategoricalHinge`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/CategoricalHinge): Computes the categorical hinge loss between `y_true` and `y_pred`.
  >
  > [`class CosineSimilarity`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/CosineSimilarity): Computes the cosine similarity between labels and predictions.
  >
  > [`class Hinge`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/Hinge): Computes the hinge loss between `y_true` and `y_pred`.
  >
  > [`class Huber`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/Huber): Computes the Huber loss between `y_true` and `y_pred`.
  >
  > [`class KLDivergence`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/KLDivergence): Computes Kullback-Leibler divergence loss between `y_true` and `y_pred`.
  >
  > [`class LogCosh`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/LogCosh): Computes the logarithm of the hyperbolic cosine of the prediction error.
  >
  > [`class Loss`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/Loss): Loss base class.
  >
  > [`class MeanAbsoluteError`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/MeanAbsoluteError): Computes the mean of absolute difference between labels and predictions.
  >
  > [`class MeanAbsolutePercentageError`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/MeanAbsolutePercentageError): Computes the mean absolute percentage error between `y_true` and `y_pred`.
  >
  > [`class MeanSquaredError`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/MeanSquaredError): Computes the mean of squares of errors between labels and predictions.
  >
  > [`class MeanSquaredLogarithmicError`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/MeanSquaredLogarithmicError): Computes the mean squared logarithmic error between `y_true` and `y_pred`.
  >
  > [`class Poisson`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/Poisson): Computes the Poisson loss between `y_true` and `y_pred`.
  >
  > [`class Reduction`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/Reduction): Types of loss reduction.
  >
  > [`class SparseCategoricalCrossentropy`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/SparseCategoricalCrossentropy): Computes the <u>crossentropyï¼ˆäº¤å‰ç†µï¼‰</u> loss between the labels and predictions.
  >
  > [`class SquaredHinge`](https://tensorflow.google.cn/api_docs/python/tf/keras/losses/SquaredHinge): Computes the squared hinge loss between `y_true` and `y_pred`.

- *ä¼˜åŒ–å™¨* `optimizer`- å†³å®šæ¨¡å‹å¦‚ä½•æ ¹æ®å…¶çœ‹åˆ°çš„æ•°æ®å’Œè‡ªèº«çš„æŸå¤±å‡½æ•°è¿›è¡Œæ›´æ–°ã€‚

- *æŒ‡æ ‡*  `metrics` - ç”¨äºç›‘æ§è®­ç»ƒå’Œæµ‹è¯•æ­¥éª¤ã€‚ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨äº†*å‡†ç¡®ç‡*ï¼Œå³è¢«æ­£ç¡®åˆ†ç±»çš„å›¾åƒçš„æ¯”ç‡ã€‚

```python
model.compile(optimizer='adam',
              loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True),
              metrics=['accuracy'])
```

## 5. è®­ç»ƒæ¨¡å‹

è®­ç»ƒç¥ç»ç½‘ç»œæ¨¡å‹éœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. å°†è®­ç»ƒæ•°æ®é¦ˆé€ç»™æ¨¡å‹ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œè®­ç»ƒæ•°æ®ä½äº `train_images` å’Œ `train_labels` æ•°ç»„ä¸­ã€‚
2. æ¨¡å‹å­¦ä¹ å°†å›¾åƒå’Œæ ‡ç­¾å…³è”èµ·æ¥ã€‚
3. è¦æ±‚æ¨¡å‹å¯¹æµ‹è¯•é›†ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º `test_images` æ•°ç»„ï¼‰è¿›è¡Œé¢„æµ‹ã€‚
4. éªŒè¯é¢„æµ‹æ˜¯å¦ä¸ `test_labels` æ•°ç»„ä¸­çš„æ ‡ç­¾ç›¸åŒ¹é…ã€‚

### â‘  å‘æ¨¡å‹é¦ˆé€æ•°æ® fit

è¦å¼€å§‹è®­ç»ƒï¼Œè¯·è°ƒç”¨ `model.fit` æ–¹æ³•ï¼Œè¿™æ ·å‘½åæ˜¯å› ä¸ºè¯¥æ–¹æ³•ä¼šå°†æ¨¡å‹ä¸è®­ç»ƒæ•°æ®è¿›è¡Œâ€œæ‹Ÿåˆâ€ï¼š

> ğŸ’¡ `model.fit()`
>
> ```python
> fit( x, y, batch_size=32, epochs=10, verbose=1, callbacks=None,
> validation_split=0.0, validation_data=None, shuffle=True, 
> class_weight=None, sample_weight=None, initial_epoch=0)123
> ```
>
> - `x`ï¼šè¾“å…¥æ•°æ®ã€‚å¦‚æœæ¨¡å‹åªæœ‰ä¸€ä¸ªè¾“å…¥ï¼Œé‚£ä¹ˆxçš„ç±»å‹æ˜¯numpy arrayï¼Œå¦‚æœæ¨¡å‹æœ‰å¤šä¸ªè¾“å…¥ï¼Œé‚£ä¹ˆxçš„ç±»å‹åº”å½“ä¸º listï¼Œlistçš„å…ƒç´ æ˜¯å¯¹åº”äºå„ä¸ªè¾“å…¥çš„numpy array
> - `y`ï¼šæ ‡ç­¾ï¼Œnumpy array
> - `batch_size`ï¼šæ•´æ•°ï¼ŒæŒ‡å®šè¿›è¡Œæ¢¯åº¦ä¸‹é™æ—¶æ¯ä¸ªbatchåŒ…å«çš„æ ·æœ¬æ•°ã€‚è®­ç»ƒæ—¶ä¸€ä¸ªbatchçš„æ ·æœ¬ä¼šè¢«è®¡ç®—ä¸€æ¬¡æ¢¯åº¦ä¸‹é™ï¼Œä½¿ç›®æ ‡å‡½æ•°ä¼˜åŒ–ä¸€æ­¥ã€‚
> - `epochs`ï¼šæ•´æ•°ï¼Œè®­ç»ƒç»ˆæ­¢æ—¶çš„epochå€¼ï¼Œè®­ç»ƒå°†åœ¨è¾¾åˆ°è¯¥epochå€¼æ—¶åœæ­¢ï¼Œå½“æ²¡æœ‰è®¾ç½®initial_epochæ—¶ï¼Œå®ƒå°±æ˜¯è®­ç»ƒçš„æ€»è½®æ•°ï¼Œå¦åˆ™è®­ç»ƒçš„æ€»è½®æ•°ä¸ºepochs - inital_epoch
> - `verbose`ï¼šæ—¥å¿—æ˜¾ç¤ºï¼Œ0ä¸ºä¸åœ¨æ ‡å‡†è¾“å‡ºæµè¾“å‡ºæ—¥å¿—ä¿¡æ¯ï¼Œ1ä¸ºè¾“å‡ºè¿›åº¦æ¡è®°å½•ï¼Œ2ä¸ºæ¯ä¸ªepochè¾“å‡ºä¸€è¡Œè®°å½•
> - `callbacks`ï¼šlistï¼Œå…¶ä¸­çš„å…ƒç´ æ˜¯keras.callbacks.Callbackçš„å¯¹è±¡ã€‚è¿™ä¸ªlistä¸­çš„å›è°ƒå‡½æ•°å°†ä¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­çš„é€‚å½“æ—¶æœºè¢«è°ƒç”¨ï¼Œå‚è€ƒå›è°ƒå‡½æ•°
> - `validation_split`ï¼š0~1ä¹‹é—´çš„æµ®ç‚¹æ•°ï¼Œç”¨æ¥æŒ‡å®šè®­ç»ƒé›†çš„ä¸€å®šæ¯”ä¾‹æ•°æ®ä½œä¸ºéªŒè¯é›†ã€‚éªŒè¯é›†å°†ä¸å‚ä¸è®­ç»ƒï¼Œå¹¶åœ¨æ¯ä¸ªepochç»“æŸåæµ‹è¯•çš„æ¨¡å‹çš„æŒ‡æ ‡ï¼Œå¦‚æŸå¤±å‡½æ•°ã€ç²¾ç¡®åº¦ç­‰ã€‚æ³¨æ„ï¼Œvalidation_splitçš„åˆ’åˆ†åœ¨shuffleä¹‹å‰ï¼Œå› æ­¤å¦‚æœä½ çš„æ•°æ®æœ¬èº«æ˜¯æœ‰åºçš„ï¼Œéœ€è¦å…ˆæ‰‹å·¥æ‰“ä¹±å†æŒ‡å®švalidation_splitï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°éªŒè¯é›†æ ·æœ¬ä¸å‡åŒ€ã€‚
> - `validation_data`ï¼šå½¢å¼ä¸ºï¼ˆXï¼Œyï¼‰çš„tupleï¼Œæ˜¯æŒ‡å®šçš„éªŒè¯é›†ã€‚æ­¤å‚æ•°å°†è¦†ç›–validation_spiltã€‚
> - `shuffle`ï¼šå¸ƒå°”å€¼æˆ–å­—ç¬¦ä¸²ï¼Œä¸€èˆ¬ä¸ºå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­éšæœºæ‰“ä¹±è¾“å…¥æ ·æœ¬çš„é¡ºåºã€‚è‹¥ä¸ºå­—ç¬¦ä¸²â€œbatchâ€ï¼Œåˆ™æ˜¯ç”¨æ¥å¤„ç†HDF5æ•°æ®çš„ç‰¹æ®Šæƒ…å†µï¼Œå®ƒå°†åœ¨batchå†…éƒ¨å°†æ•°æ®æ‰“ä¹±ã€‚
> - `class_weight`ï¼šå­—å…¸ï¼Œå°†ä¸åŒçš„ç±»åˆ«æ˜ å°„ä¸ºä¸åŒçš„æƒå€¼ï¼Œè¯¥å‚æ•°ç”¨æ¥åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è°ƒæ•´æŸå¤±å‡½æ•°ï¼ˆåªèƒ½ç”¨äºè®­ç»ƒï¼‰
> - `sample_weight`ï¼šæƒå€¼çš„numpy arrayï¼Œç”¨äºåœ¨è®­ç»ƒæ—¶è°ƒæ•´æŸå¤±å‡½æ•°ï¼ˆä»…ç”¨äºè®­ç»ƒï¼‰ã€‚å¯ä»¥ä¼ é€’ä¸€ä¸ª1Dçš„ä¸æ ·æœ¬ç­‰é•¿çš„å‘é‡ç”¨äºå¯¹æ ·æœ¬è¿›è¡Œ1å¯¹1çš„åŠ æƒï¼Œæˆ–è€…åœ¨é¢å¯¹æ—¶åºæ•°æ®æ—¶ï¼Œä¼ é€’ä¸€ä¸ªçš„å½¢å¼ä¸ºï¼ˆsamplesï¼Œsequence_lengthï¼‰çš„çŸ©é˜µæ¥ä¸ºæ¯ä¸ªæ—¶é—´æ­¥ä¸Šçš„æ ·æœ¬èµ‹ä¸åŒçš„æƒã€‚è¿™ç§æƒ…å†µä¸‹è¯·ç¡®å®šåœ¨ç¼–è¯‘æ¨¡å‹æ—¶æ·»åŠ äº†sample_weight_mode=â€™temporalâ€™ã€‚
> - `initial_epoch`: ä»è¯¥å‚æ•°æŒ‡å®šçš„epochå¼€å§‹è®­ç»ƒï¼Œåœ¨ç»§ç»­ä¹‹å‰çš„è®­ç»ƒæ—¶æœ‰ç”¨ã€‚
>
> `fit` å‡½æ•°è¿”å›ä¸€ä¸ª`History`çš„å¯¹è±¡ï¼Œå…¶`History.history`å±æ€§è®°å½•äº†æŸå¤±å‡½æ•°å’Œå…¶ä»–æŒ‡æ ‡çš„æ•°å€¼éšepochå˜åŒ–çš„æƒ…å†µï¼Œå¦‚æœæœ‰éªŒè¯é›†çš„è¯ï¼Œä¹ŸåŒ…å«äº†éªŒè¯é›†çš„è¿™äº›æŒ‡æ ‡å˜åŒ–æƒ…å†µ

```python
model.fit(train_images, train_labels, epochs=10)
Epoch 1/10
1875/1875 [==============================] - 1s 591us/step - loss: 0.4973 - accuracy: 0.8251
Epoch 2/10
1875/1875 [==============================] - 1s 593us/step - loss: 0.3727 - accuracy: 0.8659
Epoch 3/10
1875/1875 [==============================] - 1s 604us/step - loss: 0.3323 - accuracy: 0.8769
Epoch 4/10
1875/1875 [==============================] - 1s 684us/step - loss: 0.3102 - accuracy: 0.8859
Epoch 5/10
1875/1875 [==============================] - 1s 632us/step - loss: 0.2904 - accuracy: 0.8923
Epoch 6/10
1875/1875 [==============================] - 1s 651us/step - loss: 0.2784 - accuracy: 0.8973
Epoch 7/10
1875/1875 [==============================] - 1s 618us/step - loss: 0.2665 - accuracy: 0.9003
Epoch 8/10
1875/1875 [==============================] - 1s 609us/step - loss: 0.2550 - accuracy: 0.9042
Epoch 9/10
1875/1875 [==============================] - 1s 608us/step - loss: 0.2463 - accuracy: 0.9085
Epoch 10/10
1875/1875 [==============================] - 1s 599us/step - loss: 0.2388 - accuracy: 0.9100
<tensorflow.python.keras.callbacks.History at 0x2593820d8c8>
```

åœ¨æ¨¡å‹è®­ç»ƒæœŸé—´ï¼Œä¼šæ˜¾ç¤ºæŸå¤±å’Œå‡†ç¡®ç‡æŒ‡æ ‡ã€‚æ­¤æ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šçš„å‡†ç¡®ç‡è¾¾åˆ°äº† 0.91ï¼ˆæˆ– 91%ï¼‰å·¦å³ã€‚

### â‘¡ åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°å‡†ç¡®ç‡ evaluate

æ¥ä¸‹æ¥ï¼Œæ¯”è¾ƒæ¨¡å‹åœ¨**æµ‹è¯•æ•°æ®é›†**ä¸Šçš„è¡¨ç°ï¼š

```python
test_loss, test_acc = model.evaluate(test_images,  test_labels, verbose=2)

313/313 - 0s - loss: 0.3433 - accuracy: 0.8776
```

ç»“æœè¡¨æ˜ï¼Œæ¨¡å‹åœ¨æµ‹è¯•æ•°æ®é›†ä¸Šçš„å‡†ç¡®ç‡ç•¥ä½äºè®­ç»ƒæ•°æ®é›†ã€‚è¡¨ç¤ºæ¨¡å‹å‡ºç°äº†**è¿‡æ‹Ÿåˆ**ã€‚è¿‡æ‹Ÿåˆæ˜¯æŒ‡æœºå™¨å­¦ä¹ æ¨¡å‹åœ¨æ–°çš„ã€ä»¥å‰æœªæ›¾è§è¿‡çš„è¾“å…¥ä¸Šçš„è¡¨ç°ä¸å¦‚åœ¨è®­ç»ƒæ•°æ®ä¸Šçš„è¡¨ç°ã€‚è¿‡æ‹Ÿåˆçš„æ¨¡å‹ä¼šâ€œè®°ä½â€è®­ç»ƒæ•°æ®é›†ä¸­çš„å™ªå£°å’Œç»†èŠ‚ï¼Œä»è€Œå¯¹æ¨¡å‹åœ¨æ–°æ•°æ®ä¸Šçš„è¡¨ç°äº§ç”Ÿè´Ÿé¢å½±å“ã€‚å…³äºã€å¦‚ä½•é¿å…è¿‡æ‹Ÿåˆã€‘è¯·å‚è§åç»­æ–‡ç« 

## 6. ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹è¿›è¡Œé¢„æµ‹ predict

### â‘  å¯¹äºæ•°æ®é›†çš„é¢„æµ‹

åœ¨æ¨¡å‹ç»è¿‡è®­ç»ƒåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒå¯¹ä¸€äº›å›¾åƒè¿›è¡Œé¢„æµ‹ `predict`ã€‚æ¨¡å‹å…·æœ‰çº¿æ€§è¾“å‡ºï¼Œå³å¯¹æ•° logitsã€‚

```python
# é¢„æµ‹æ•´ä¸ªæµ‹è¯•é›†
predictions = model.predict(test_images)
```

> ğŸ’¡ **æ‚¨å¯ä»¥é™„åŠ ä¸€ä¸ª softmax å±‚ï¼Œå°†å¯¹æ•°è½¬æ¢æˆæ›´å®¹æ˜“ç†è§£çš„æ¦‚ç‡**ã€‚
>
> ```python
> probability_model = tf.keras.Sequential([model, 
>                                          tf.keras.layers.Softmax()])
> predictions = probability_model.predict(test_images)
> ```

åœ¨ä¸Šä¾‹ä¸­ï¼Œæ¨¡å‹é¢„æµ‹äº†æµ‹è¯•é›†ä¸­æ¯ä¸ªå›¾åƒçš„æ ‡ç­¾ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å¯¹äºæµ‹è¯•é›†ä¸­ç¬¬ä¸€ä¸ªæ•°æ®çš„é¢„æµ‹ç»“æœï¼š

```python
predictions[0]
array([-12.287166 , -12.227676 , -11.628488 , -23.456598 , -13.601996 ,
        -0.3401114, -11.226322 ,  -0.9587118, -10.683305 ,   3.9778895],
      dtype=float32)
```

å¦‚æœæ˜¯åŠ å…¥äº† softmax çš„å±‚è¯ä¼šæ›´åŠ ç›´è§‚ï¼š

```python
probability_model = tf.keras.Sequential([model, 
                                         tf.keras.layers.Softmax()])
predictions = probability_model.predict(test_images)

predictions[0]
array([8.4598121e-08, 8.9783427e-08, 1.6346355e-07, 1.1927167e-12,
       2.2716266e-08, 1.3058711e-02, 2.4438737e-07, 7.0346999e-03,
       4.2063812e-07, 9.7990555e-01], dtype=float32)
```

é¢„æµ‹ç»“æœæ˜¯ä¸€ä¸ªåŒ…å« 10 ä¸ªæ•°å­—çš„æ•°ç»„ã€‚å®ƒä»¬ä»£è¡¨æ¨¡å‹å¯¹ 10 ç§ä¸åŒæœè£…ä¸­æ¯ç§æœè£…çš„â€œç½®ä¿¡åº¦â€ã€‚æ‚¨å¯ä»¥çœ‹åˆ°å“ªä¸ªæ ‡ç­¾çš„ç½®ä¿¡åº¦å€¼æœ€å¤§ï¼š

```python
np.argmax(predictions[0])
9
```

å› æ­¤ï¼Œè¯¥æ¨¡å‹éå¸¸ç¡®ä¿¡è¿™ä¸ªå›¾åƒæ˜¯çŸ­é´ï¼Œæˆ– `class_names[9]`ã€‚é€šè¿‡æ£€æŸ¥æµ‹è¯•æ ‡ç­¾å‘ç°è¿™ä¸ªåˆ†ç±»æ˜¯æ­£ç¡®çš„ï¼š

```python
test_labels[0]
9
```

æ‚¨å¯ä»¥å°†å…¶ç»˜åˆ¶æˆå›¾è¡¨ï¼š

```python
# ç»˜åˆ¶æ•°æ®é›† img ä¸Šçš„ç¬¬ i å¼ å›¾ç‰‡çš„åˆ†ç±»æ¦‚ç‡
# predictions_array è¡¨ç¤ºè¯¥å¼ å›¾ç‰‡å¯¹åº”æ¯ä¸ªåˆ†ç±»çš„æ¦‚ç‡
# true_label è¡¨ç¤ºè¯¥å›¾ç‰‡çš„çœŸå®æ ‡ç­¾
def plot_image(i, predictions_array, true_label, img):
  predictions_array, true_label, img = predictions_array, true_label, img[i]
  plt.grid(False)
  plt.xticks([])
  plt.yticks([])

  plt.imshow(img)

  predicted_label = np.argmax(predictions_array)
  if predicted_label == true_label:
    color = 'blue' # æ­£ç¡®çš„é¢„æµ‹æ ‡ç­¾ä¸ºè“è‰²
  else:
    color = 'red' # é”™è¯¯çš„é¢„æµ‹æ ‡ç­¾ä¸ºçº¢è‰²

  plt.xlabel("{} {:2.0f}% ({})".format(class_names[predicted_label], # æ ‡ç­¾
                                100*np.max(predictions_array), # æ¦‚ç‡
                                class_names[true_label]), # çœŸå®æ ‡ç­¾
                                color=color)
```

<img src="https://gitee.com/veal98/images/raw/master/img/20201104213705.png" style="zoom:50%;" />

```python
# ç»˜åˆ¶ç¬¬ i å¼ å›¾ç‰‡å¯¹åº”æ¯ä¸ªåˆ†ç±»çš„æ¦‚ç‡
def plot_value_array(i, predictions_array, true_label):
  predictions_array, true_label = predictions_array, true_label
  plt.grid(False)
  plt.xticks(range(10))
  plt.yticks([])
  thisplot = plt.bar(range(10), predictions_array, color="#777777")
  plt.ylim([0, 1])
  predicted_label = np.argmax(predictions_array)

  thisplot[predicted_label].set_color('red')
  thisplot[true_label].set_color('blue')
```

<img src="https://gitee.com/veal98/images/raw/master/img/20201104214753.png" style="zoom:67%;" />

### â‘¡ å¯¹äºå•ä¸ªæ•°æ®çš„é¢„æµ‹

ğŸš¨ **[`tf.keras`](https://tensorflow.google.cn/api_docs/python/tf/keras?hl=zh_cn) æ¨¡å‹ç»è¿‡äº†ä¼˜åŒ–ï¼Œå¯åŒæ—¶å¯¹ä¸€ä¸ª*æ‰¹*æˆ–ä¸€ç»„æ ·æœ¬è¿›è¡Œé¢„æµ‹ã€‚å› æ­¤ï¼Œå³ä¾¿æ‚¨åªä½¿ç”¨ä¸€ä¸ªå›¾åƒï¼Œæ‚¨ä¹Ÿéœ€è¦å°†å…¶æ·»åŠ åˆ°åˆ—è¡¨ä¸­**ï¼š

```python
img = test_images[1]

img = (np.expand_dims(img,0))
```

æ¥ä¸‹æ¥çš„é¢„æµ‹è¿‡ç¨‹åŒä¸Šï¼š

<img src="https://gitee.com/veal98/images/raw/master/img/20201104220136.png" style="zoom:67%;" />

## 7. ä¿å­˜æ•´ä¸ªæ¨¡å‹ save

è°ƒç”¨ [`model.save`](https://tensorflow.google.cn/api_docs/python/tf/keras/Model?hl=zh_cn#save) å°†ä¿å­˜æ¨¡å‹çš„ç»“æ„ï¼Œæƒé‡å’Œè®­ç»ƒé…ç½®ä¿å­˜åœ¨å•ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹ä¸­ã€‚è¿™å¯ä»¥è®©æ‚¨å¯¼å‡ºæ¨¡å‹ï¼Œä»¥ä¾¿åœ¨ä¸è®¿é—®åŸå§‹ Python ä»£ç çš„æƒ…å†µä¸‹ä½¿ç”¨å®ƒã€‚å› ä¸ºä¼˜åŒ–å™¨çŠ¶æ€ï¼ˆoptimizer-stateï¼‰å·²ç»æ¢å¤ï¼Œæ‚¨å¯ä»¥ä»ä¸­æ–­çš„ä½ç½®æ¢å¤è®­ç»ƒã€‚

æ•´ä¸ªæ¨¡å‹å¯ä»¥ä»¥ä¸¤ç§ä¸åŒçš„æ–‡ä»¶æ ¼å¼ï¼ˆ`SavedModel` å’Œ `HDF5`ï¼‰è¿›è¡Œä¿å­˜ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ TensorFlow çš„ `SavedModel` æ ¼å¼æ˜¯ TF2.x. ä¸­çš„é»˜è®¤æ–‡ä»¶æ ¼å¼ã€‚ä½†æ˜¯ï¼Œæ¨¡å‹ä»å¯ä»¥ä»¥ `HDF5` æ ¼å¼ä¿å­˜ã€‚ä¸‹é¢ä»‹ç»äº†ä»¥ä¸¤ç§æ–‡ä»¶æ ¼å¼ä¿å­˜æ•´ä¸ªæ¨¡å‹çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

### â‘  SavedModel æ ¼å¼

SavedModel æ ¼å¼æ˜¯åºåˆ—åŒ–æ¨¡å‹çš„å¦ä¸€ç§æ–¹æ³•ã€‚ä»¥è¿™ç§æ ¼å¼ä¿å­˜çš„æ¨¡å‹ï¼Œå¯ä»¥ä½¿ç”¨ [`tf.keras.models.load_model`](https://tensorflow.google.cn/api_docs/python/tf/keras/models/load_model?hl=zh_cn) è¿˜åŸï¼Œå¹¶ä¸”æ¨¡å‹ä¸ TensorFlow Serving å…¼å®¹ã€‚[SavedModel æŒ‡å—](https://tensorflow.google.cn/guide/saved_model?hl=zh_cn)è¯¦ç»†ä»‹ç»äº†å¦‚ä½•æä¾›/æ£€æŸ¥ SavedModelã€‚ä»¥ä¸‹éƒ¨åˆ†è¯´æ˜äº†ä¿å­˜å’Œè¿˜åŸæ¨¡å‹çš„æ­¥éª¤ã€‚

```python
# å°†æ•´ä¸ªæ¨¡å‹å¦å­˜ä¸º my_model
model.save('my_model') 
```

ä»ä¿å­˜çš„æ¨¡å‹é‡æ–°åŠ è½½æ–°çš„ Keras æ¨¡å‹ï¼š

```python
new_model = tf.keras.models.load_model('my_model')
```

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `new_model` è¿›è¡Œå’Œ `model` ä¸€æ ·çš„æ“ä½œã€‚

### â‘¡ HDF5 æ ¼å¼

Kerasä½¿ç”¨ [HDF5](https://en.wikipedia.org/wiki/Hierarchical_Data_Format) æ ‡å‡†æä¾›äº†ä¸€ç§åŸºæœ¬çš„ä¿å­˜æ ¼å¼ã€‚

```python
# å°†æ•´ä¸ªæ¨¡å‹ä¿å­˜ä¸º HDF5 æ–‡ä»¶ã€‚
# '.h5' æ‰©å±•åæŒ‡ç¤ºåº”å°†æ¨¡å‹ä¿å­˜åˆ° HDF5ã€‚
model.save('my_model.h5') 
```

ç°åœ¨ï¼Œä»è¯¥æ–‡ä»¶é‡æ–°åˆ›å»ºæ¨¡å‹ï¼š

```python
# é‡æ–°åˆ›å»ºå®Œå…¨ç›¸åŒçš„æ¨¡å‹ï¼ŒåŒ…æ‹¬å…¶æƒé‡å’Œä¼˜åŒ–ç¨‹åº
new_model = tf.keras.models.load_model('my_model.h5')
```

## ğŸ“š References

- [TensorFlow 2 å®˜æ–¹æ–‡æ¡£](https://tensorflow.google.cn/tutorials/keras/classification?hl=zh_cn)