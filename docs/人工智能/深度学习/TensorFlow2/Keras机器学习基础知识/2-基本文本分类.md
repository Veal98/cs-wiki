# ğŸš¡ Keras åŸºæœ¬æ–‡æœ¬åˆ†ç±»

---

æˆ‘ä»¬å°†ä½¿ç”¨æ¥æºäº[ç½‘ç»œç”µå½±æ•°æ®åº“ï¼ˆInternet Movie Databaseï¼‰](https://www.imdb.com/)çš„ [IMDB æ•°æ®é›†ï¼ˆIMDB datasetï¼‰](https://tensorflow.google.cn/api_docs/python/tf/keras/datasets/imdb?hl=zh_cn)ï¼Œå…¶åŒ…å« 50,000 æ¡å½±è¯„æ–‡æœ¬ã€‚ä»è¯¥æ•°æ®é›†åˆ‡å‰²å‡ºçš„25,000æ¡è¯„è®ºç”¨ä½œè®­ç»ƒï¼Œå¦å¤– 25,000 æ¡ç”¨ä½œæµ‹è¯•ã€‚è®­ç»ƒé›†ä¸æµ‹è¯•é›†æ˜¯*å¹³è¡¡çš„ï¼ˆbalancedï¼‰*ï¼Œæ„å‘³ç€å®ƒä»¬åŒ…å«ç›¸ç­‰æ•°é‡çš„ç§¯æå’Œæ¶ˆæè¯„è®ºã€‚<u>æˆ‘ä»¬çš„ç›®çš„å°±æ˜¯å¯¹è¯¥æ¡è¯„è®ºè¿›è¡Œåˆ†ç±»ï¼ˆç§¯æ/æ¶ˆæè¯„è®ºï¼‰</u>

æœ¬æŒ‡å—ä½¿ç”¨äº† [tf.keras](https://tensorflow.google.cn/guide/keras?hl=zh_cn)ï¼Œå®ƒæ˜¯ TensorFlow ä¸­ç”¨æ¥æ„å»ºå’Œè®­ç»ƒæ¨¡å‹çš„é«˜çº§ APIã€‚

```python
# TensorFlow and tf.keras
import tensorflow as tf
from tensorflow import keras

# Helper libraries
import numpy as np
import matplotlib.pyplot as plt

print(tf.__version__)
2.3.1
```

## 1. ä¸‹è½½ IMDB æ•°æ®é›†

IMDB æ•°æ®é›†å·²ç»æ‰“åŒ…åœ¨ Tensorflow ä¸­ã€‚è¯¥æ•°æ®é›†å·²ç»ç»è¿‡é¢„å¤„ç†ï¼Œè¯„è®ºï¼ˆå•è¯åºåˆ—ï¼‰å·²ç»è¢«è½¬æ¢ä¸ºæ•´æ•°åºåˆ—ï¼Œå…¶ä¸­æ¯ä¸ªæ•´æ•°è¡¨ç¤ºå­—å…¸ä¸­çš„ç‰¹å®šå•è¯ã€‚

ä»¥ä¸‹ä»£ç å°†ä¸‹è½½ IMDB æ•°æ®é›†åˆ°æ‚¨çš„æœºå™¨ä¸Šï¼ˆå¦‚æœæ‚¨å·²ç»ä¸‹è½½è¿‡å°†ä»ç¼“å­˜ä¸­å¤åˆ¶ï¼‰ï¼š

```python
imdb = keras.datasets.imdb

(train_data, train_labels), (test_data, test_labels) = imdb.load_data(num_words=10000)
```

å‚æ•° `num_words=10000` ä¿ç•™äº†è®­ç»ƒæ•°æ®ä¸­æœ€å¸¸å‡ºç°çš„ 10,000 ä¸ªå•è¯ã€‚ä¸ºäº†ä¿æŒæ•°æ®è§„æ¨¡çš„å¯ç®¡ç†æ€§ï¼Œä½é¢‘è¯å°†è¢«ä¸¢å¼ƒã€‚

## 2. æµè§ˆæ•°æ®

è®©æˆ‘ä»¬èŠ±ä¸€ç‚¹æ—¶é—´æ¥äº†è§£æ•°æ®æ ¼å¼ã€‚è¯¥æ•°æ®é›†æ˜¯ç»è¿‡é¢„å¤„ç†çš„ï¼šæ¯ä¸ªæ ·æœ¬éƒ½æ˜¯ä¸€ä¸ªè¡¨ç¤ºå½±è¯„ä¸­è¯æ±‡çš„æ•´æ•°æ•°ç»„ã€‚æ¯ä¸ªæ ‡ç­¾éƒ½æ˜¯ä¸€ä¸ªå€¼ä¸º 0 æˆ– 1 çš„æ•´æ•°å€¼ï¼Œå…¶ä¸­ 0 ä»£è¡¨æ¶ˆæè¯„è®ºï¼Œ1 ä»£è¡¨ç§¯æè¯„è®ºã€‚

```python
print("Training entries: {}, labels: {}".format(len(train_data), len(train_labels)))
Training entries: 25000, labels: 25000
```

è¯„è®ºæ–‡æœ¬è¢«è½¬æ¢ä¸ºæ•´æ•°å€¼ï¼Œå…¶ä¸­**æ¯ä¸ªæ•´æ•°ä»£è¡¨è¯å…¸ä¸­çš„ä¸€ä¸ªå•è¯**ã€‚é¦–æ¡è¯„è®ºæ˜¯è¿™æ ·çš„ï¼š

```python
train_data[0] # è®­ç»ƒé›†çš„ç¬¬ä¸€æ¡è¯„è®º

[1, 14, 22, 16, 43, 530, 973, 1622, 1385, 65, 458, 4468, 66, 3941, 4, 173, 36, 256, 5, 25, 100, 43, 838, 112, 50, 670, 2, 9, 35, 480, 284, 5, 150, 4, 172, 112, 167, 2, 336, 385, 39, 4, 172, 4536, 1111, 17, 546, 38, 13, 447, 4, 192, 50, 16, 6, 147, 2025, 19, 14, 22, 4, 1920, 4613, 469, 4, 22, 71, 87, 12, 16, 43, 530, 38, 76, 15, 13, 1247, 4, 22, 17, 515, 17, 12, 16, 626, 18, 2, 5, 62, 386, 12, 8, 316, 8, 106, 5, 4, 2223, 5244, 16, 480, 66, 3785, 33, 4, 130, 12, 16, 38, 619, 5, 25, 124, 51, 36, 135, 48, 25, 1415, 33, 6, 22, 12, 215, 28, 77, 52, 5, 14, 407, 16, 82, 2, 8, 4, 107, 117, 5952, 15, 256, 4, 2, 7, 3766, 5, 723, 36, 71, 43, 530, 476, 26, 400, 317, 46, 7, 4, 2, 1029, 13, 104, 88, 4, 381, 15, 297, 98, 32, 2071, 56, 26, 141, 6, 194, 7486, 18, 4, 226, 22, 21, 134, 476, 26, 480, 5, 144, 30, 5535, 18, 51, 36, 28, 224, 92, 25, 104, 4, 226, 65, 16, 38, 1334, 88, 12, 16, 283, 5, 16, 4472, 113, 103, 32, 15, 16, 5345, 19, 178, 32]
```

**ç”µå½±è¯„è®ºå¯èƒ½å…·æœ‰ä¸åŒçš„é•¿åº¦ã€‚ç”±äºç¥ç»ç½‘ç»œçš„è¾“å…¥å¿…é¡»æ˜¯ç»Ÿä¸€çš„é•¿åº¦ï¼Œæˆ‘ä»¬ç¨åéœ€è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚**ä»¥ä¸‹ä»£ç æ˜¾ç¤ºäº†ç¬¬ä¸€æ¡å’Œç¬¬äºŒæ¡è¯„è®ºçš„ä¸­å•è¯æ•°é‡ã€‚

```python
len(train_data[0]), len(train_data[1])
(218, 189)
```

### å°†æ•´æ•°è½¬æ¢å›å•è¯

äº†è§£å¦‚ä½•å°†æ•´æ•°è½¬æ¢å›æ–‡æœ¬å¯¹æ‚¨å¯èƒ½æ˜¯æœ‰å¸®åŠ©çš„ã€‚è¿™é‡Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè¾…åŠ©å‡½æ•°æ¥æŸ¥è¯¢ä¸€ä¸ªåŒ…å«äº†æ•´æ•°åˆ°å­—ç¬¦ä¸²æ˜ å°„çš„å­—å…¸å¯¹è±¡ï¼š

```python
# ä¸€ä¸ªæ˜ å°„å•è¯åˆ°æ•´æ•°ç´¢å¼•çš„è¯å…¸
word_index = imdb.get_word_index()

# ä¿ç•™ç¬¬ä¸€ä¸ªç´¢å¼•
word_index = {k:(v+3) for k,v in word_index.items()}
word_index["<PAD>"] = 0
word_index["<START>"] = 1
word_index["<UNK>"] = 2  # unknown
word_index["<UNUSED>"] = 3

reverse_word_index = dict([(value, key) for (key, value) in word_index.items()])

def decode_review(text):
    return ' '.join([reverse_word_index.get(i, '?') for i in text])
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `decode_review` å‡½æ•°æ¥æ˜¾ç¤ºé¦–æ¡è¯„è®ºçš„æ–‡æœ¬ï¼š

```python
decode_review(train_data[0])

"<START> this film was just brilliant casting location scenery story direction everyone's really suited the part they played and you could just imagine being there robert <UNK> is an amazing actor and now the same being director <UNK> father came from the same scottish island as myself so i loved the fact there was a real connection with this film the witty remarks throughout the film were great it was just brilliant so much that i bought the film as soon as it was released for <UNK> and would recommend it to everyone to watch and the fly fishing was amazing really cried at the end it was so sad and you know what they say if you cry at a film it must have been good and this definitely was also <UNK> to the two little boy's that played the <UNK> of norman and paul they were just brilliant children are often left out of the <UNK> list i think because the stars that play them all grown up are such a big profile for the whole film but these children are amazing and should be praised for what they have done don't you think the whole story was so lovely because it was true and was someone's life after all that was shared with us all"
```

## 3. é¢„å¤„ç†æ•°æ®

**å½±è¯„â€”â€”å³æ•´æ•°æ•°ç»„å¿…é¡»åœ¨è¾“å…¥ç¥ç»ç½‘ç»œä¹‹å‰è½¬æ¢ä¸ºå¼ é‡**ã€‚è¿™ç§è½¬æ¢å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼æ¥å®Œæˆï¼š

- å°†æ•°ç»„è½¬æ¢ä¸ºè¡¨ç¤ºå•è¯å‡ºç°ä¸å¦çš„ç”± 0 å’Œ 1 ç»„æˆçš„å‘é‡ï¼Œç±»ä¼¼äº one-hot ç¼–ç ã€‚ä¾‹å¦‚ï¼Œåºåˆ— [3, 5] å°†è½¬æ¢ä¸ºä¸€ä¸ª 10,000 ç»´çš„å‘é‡ï¼Œè¯¥å‘é‡é™¤äº†ç´¢å¼•ä¸º 3 å’Œ 5 çš„ä½ç½®æ˜¯ 1 ä»¥å¤–ï¼Œå…¶ä»–éƒ½ä¸º 0ã€‚ç„¶åï¼Œå°†å…¶ä½œä¸ºç½‘ç»œçš„é¦–å±‚â€”â€”ä¸€ä¸ªå¯ä»¥å¤„ç†æµ®ç‚¹å‹å‘é‡æ•°æ®çš„ç¨ å¯†å±‚ã€‚ä¸è¿‡ï¼Œè¿™ç§æ–¹æ³•éœ€è¦å¤§é‡çš„å†…å­˜ï¼Œéœ€è¦ä¸€ä¸ªå¤§å°ä¸º `num_words * num_reviews` çš„çŸ©é˜µã€‚
- æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥å¡«å……æ•°ç»„æ¥ä¿è¯è¾“å…¥æ•°æ®å…·æœ‰ç›¸åŒçš„é•¿åº¦ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªå¤§å°ä¸º `max_length * num_reviews` çš„æ•´å‹å¼ é‡ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨èƒ½å¤Ÿå¤„ç†æ­¤å½¢çŠ¶æ•°æ®çš„åµŒå…¥å±‚ä½œä¸ºç½‘ç»œä¸­çš„ç¬¬ä¸€å±‚ã€‚

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ã€‚

**ç”±äºç”µå½±è¯„è®ºé•¿åº¦å¿…é¡»ç›¸åŒï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [pad_sequences](https://tensorflow.google.cn/api_docs/python/tf/keras/preprocessing/sequence/pad_sequences?hl=zh_cn) å‡½æ•°æ¥ä½¿é•¿åº¦æ ‡å‡†åŒ–**ï¼š

> ğŸ’¡ `tf.keras.preprocessing.sequence.pad_sequences`ï¼š
>
> ```python
> tf.keras.preprocessing.sequence.pad_sequences(
>  sequences, maxlen=None, dtype='int32', padding='pre', truncating='pre',
>  value=0.0
> )
> ```
>
> **This function transforms a list of sequences  into a 2D Numpy array of shape**
>
> | Arguments    |                                                              |
> | :----------- | ------------------------------------------------------------ |
> | `sequences`  | List of sequences (each sequence is a list of integers).     |
> | `maxlen`     | Optional Int, maximum length of all sequences. If not provided, sequences will be padded to the length of the longest individual sequence. |
> | `dtype`      | (Optional, defaults to int32). Type of the output sequences. To pad sequences with variable length strings, you can use `object`. |
> | `padding`    | String, '`pre`' or '`post`' (optional, <u>defaults to '`pre`'</u>): pad either before or after each sequence. |
> | `truncating` | String, 'pre' or 'post' (optional, defaults to 'pre'): remove values from sequences larger than `maxlen`, either at the beginning or at the end of the sequences. |
> | `value`      | Float or String, padding value. (Optional, defaults to 0.)   |
>
> ```python
> sequence = [[1], [2, 3], [4, 5, 6]]
> tf.keras.preprocessing.sequence.pad_sequences(sequence)
> ```
> <img src="https://gitee.com/veal98/images/raw/master/img/20201106195800.png" style="zoom:55%;" />

```python
# ç”¨ 0 åœ¨ train_data çš„æ¯ç»„æ•´æ•°åºåˆ—åé¢è¡¥é½è‡³ 256 ä½
train_data = keras.preprocessing.sequence.pad_sequences(train_data,
                                                        value=0,
                                                        padding='post',
                                                        maxlen=256)

test_data = keras.preprocessing.sequence.pad_sequences(test_data,
                                                       value=0,
                                                       padding='post',
                                                       maxlen=256)
```

ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸‹æ ·æœ¬çš„é•¿åº¦ï¼š

```python
len(train_data[0]), len(train_data[1])
(256, 256)
```

å¹¶æ£€æŸ¥ä¸€ä¸‹é¦–æ¡è¯„è®ºï¼ˆå½“å‰å·²ç»å¡«å……ï¼‰ï¼š

```python
print(train_data[0])

[   1   14   22   16   43  530  973 1622 1385   65  458 4468   66 3941
    4  173   36  256    5   25  100   43  838  112   50  670    2    9
   35  480  284    5  150    4  172  112  167    2  336  385   39    4
  172 4536 1111   17  546   38   13  447    4  192   50   16    6  147
 2025   19   14   22    4 1920 4613  469    4   22   71   87   12   16
   43  530   38   76   15   13 1247    4   22   17  515   17   12   16
  626   18    2    5   62  386   12    8  316    8  106    5    4 2223
 5244   16  480   66 3785   33    4  130   12   16   38  619    5   25
  124   51   36  135   48   25 1415   33    6   22   12  215   28   77
   52    5   14  407   16   82    2    8    4  107  117 5952   15  256
    4    2    7 3766    5  723   36   71   43  530  476   26  400  317
   46    7    4    2 1029   13  104   88    4  381   15  297   98   32
 2071   56   26  141    6  194 7486   18    4  226   22   21  134  476
   26  480    5  144   30 5535   18   51   36   28  224   92   25  104
    4  226   65   16   38 1334   88   12   16  283    5   16 4472  113
  103   32   15   16 5345   19  178   32    0    0    0    0    0    0
    0    0    0    0    0    0    0    0    0    0    0    0    0    0
    0    0    0    0    0    0    0    0    0    0    0    0    0    0
    0    0    0    0]
```

## 4. æ„å»ºæ¨¡å‹

### â‘  è®¾ç½®å±‚

ç¥ç»ç½‘ç»œç”±å †å çš„å±‚æ¥æ„å»ºï¼Œè¿™éœ€è¦ä»ä¸¤ä¸ªä¸»è¦æ–¹é¢æ¥è¿›è¡Œä½“ç³»ç»“æ„å†³ç­–ï¼š

- æ¨¡å‹é‡Œæœ‰å¤šå°‘å±‚ï¼Ÿ
- æ¯ä¸ªå±‚é‡Œæœ‰å¤šå°‘*éšå±‚å•å…ƒï¼ˆhidden unitsï¼‰*ï¼Ÿ

åœ¨æ­¤æ ·æœ¬ä¸­ï¼Œè¾“å…¥æ•°æ®åŒ…å«ä¸€ä¸ªå•è¯ç´¢å¼•çš„æ•°ç»„ã€‚è¦é¢„æµ‹çš„æ ‡ç­¾ä¸º 0 æˆ– 1ã€‚è®©æˆ‘ä»¬æ¥ä¸ºè¯¥é—®é¢˜æ„å»ºä¸€ä¸ªæ¨¡å‹ï¼š

```python
# è¾“å…¥å½¢çŠ¶æ˜¯ç”¨äºç”µå½±è¯„è®ºçš„è¯æ±‡æ•°ç›®ï¼ˆ10,000 è¯ï¼‰
vocab_size = 10000

# è®¾ç½®å±‚
model = keras.Sequential([
    keras.layers.Embedding(vocab_size, 16),
    keras.layers.GlobalAveragePooling1D(),
    keras.layers.Dense(16, activation='relu'),
    keras.layers.Dense(1, activation='sigmoid')
])
```

> ğŸ’¡ è®¾ç½®å±‚ä¹Ÿå¯ä»¥ä½¿ç”¨ `add`
>
> ```python
> model = keras.Sequential()
> model.add(keras.layers.Embedding(vocab_size, 16))
> model.add(keras.layers.GlobalAveragePooling1D())
> model.add(keras.layers.Dense(16, activation='relu'))
> model.add(keras.layers.Dense(1, activation='sigmoid'))
> ```

```python
model.summary()

Model: "sequential"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
embedding (Embedding)        (None, None, 16)          160000    
_________________________________________________________________
global_average_pooling1d (Gl (None, 16)                0         
_________________________________________________________________
dense (Dense)                (None, 16)                272       
_________________________________________________________________
dense_1 (Dense)              (None, 1)                 17        
=================================================================
Total params: 160,289
Trainable params: 160,289
Non-trainable params: 0
_________________________________________________________________
```

å±‚æŒ‰é¡ºåºå †å ä»¥æ„å»ºåˆ†ç±»å™¨ï¼š

1. ç¬¬ä¸€å±‚æ˜¯`åµŒå…¥ï¼ˆEmbeddingï¼‰`å±‚ã€‚è¯¥å±‚é‡‡ç”¨æ•´æ•°ç¼–ç çš„è¯æ±‡è¡¨ï¼Œå¹¶æŸ¥æ‰¾æ¯ä¸ªè¯ç´¢å¼•çš„åµŒå…¥å‘é‡ï¼ˆembedding vectorï¼‰ã€‚è¿™äº›å‘é‡æ˜¯é€šè¿‡æ¨¡å‹è®­ç»ƒå­¦ä¹ åˆ°çš„ã€‚å‘é‡å‘è¾“å‡ºæ•°ç»„å¢åŠ äº†ä¸€ä¸ªç»´åº¦ã€‚å¾—åˆ°çš„ç»´åº¦ä¸ºï¼š`(batch, sequence, embedding)`ã€‚
2. æ¥ä¸‹æ¥ï¼Œ`GlobalAveragePooling1D` å°†é€šè¿‡å¯¹åºåˆ—ç»´åº¦æ±‚å¹³å‡å€¼æ¥ä¸ºæ¯ä¸ªæ ·æœ¬è¿”å›ä¸€ä¸ªå®šé•¿è¾“å‡ºå‘é‡ã€‚è¿™å…è®¸æ¨¡å‹ä»¥å°½å¯èƒ½æœ€ç®€å•çš„æ–¹å¼å¤„ç†å˜é•¿è¾“å…¥ã€‚
3. è¯¥å®šé•¿è¾“å‡ºå‘é‡é€šè¿‡ä¸€ä¸ªæœ‰ 16 ä¸ªéšè—å•å…ƒçš„å…¨è¿æ¥ï¼ˆ`Dense`ï¼‰å±‚ä¼ è¾“ã€‚
4. **æœ€åä¸€å±‚ä¸å•ä¸ªè¾“å‡ºç»“ç‚¹å¯†é›†è¿æ¥ã€‚ä½¿ç”¨ `Sigmoid` æ¿€æ´»å‡½æ•°ï¼Œå…¶å‡½æ•°å€¼ä¸ºä»‹äº 0 ä¸ 1 ä¹‹é—´çš„æµ®ç‚¹æ•°ï¼Œè¡¨ç¤ºæ¦‚ç‡æˆ–ç½®ä¿¡åº¦**ã€‚

ä¸Šè¿°æ¨¡å‹åœ¨è¾“å…¥è¾“å‡ºä¹‹é—´æœ‰ä¸¤ä¸ªä¸­é—´å±‚æˆ–â€œéšè—å±‚â€ã€‚è¾“å‡ºï¼ˆå•å…ƒï¼Œç»“ç‚¹æˆ–ç¥ç»å…ƒï¼‰çš„æ•°é‡å³ä¸ºå±‚è¡¨ç¤ºç©ºé—´çš„ç»´åº¦ã€‚æ¢å¥è¯è¯´ï¼Œæ˜¯å­¦ä¹ å†…éƒ¨è¡¨ç¤ºæ—¶ç½‘ç»œæ‰€å…è®¸çš„è‡ªç”±åº¦ã€‚

<u>å¦‚æœæ¨¡å‹å…·æœ‰æ›´å¤šçš„éšå±‚å•å…ƒï¼ˆæ›´é«˜ç»´åº¦çš„è¡¨ç¤ºç©ºé—´ï¼‰å’Œ/æˆ–æ›´å¤šå±‚ï¼Œåˆ™å¯ä»¥å­¦ä¹ åˆ°æ›´å¤æ‚çš„è¡¨ç¤ºã€‚ä½†æ˜¯ï¼Œè¿™ä¼šä½¿ç½‘ç»œçš„è®¡ç®—æˆæœ¬æ›´é«˜ï¼Œå¹¶ä¸”å¯èƒ½å¯¼è‡´è¿‡æ‹Ÿåˆï¼ˆoverfittingï¼‰</u>

### â‘¡ ç¼–è¯‘æ¨¡å‹ compile

ä¸€ä¸ªæ¨¡å‹éœ€è¦æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨æ¥è¿›è¡Œè®­ç»ƒã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªäºŒåˆ†ç±»é—®é¢˜ä¸”æ¨¡å‹è¾“å‡ºæ¦‚ç‡å€¼ï¼ˆä¸€ä¸ªä½¿ç”¨ sigmoid æ¿€æ´»å‡½æ•°çš„å•ä¸€å•å…ƒå±‚ï¼‰ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `binary_crossentropy` æŸå¤±å‡½æ•°ã€‚

è¿™ä¸æ˜¯æŸå¤±å‡½æ•°çš„å”¯ä¸€é€‰æ‹©ï¼Œä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥é€‰æ‹© `mean_squared_error` ã€‚ä½†æ˜¯ï¼Œä¸€èˆ¬æ¥è¯´ `binary_crossentropy` æ›´é€‚åˆå¤„ç†æ¦‚ç‡â€”â€”å®ƒèƒ½å¤Ÿåº¦é‡æ¦‚ç‡åˆ†å¸ƒä¹‹é—´çš„â€œè·ç¦»â€ï¼Œæˆ–è€…åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼ŒæŒ‡çš„æ˜¯åº¦é‡ ground-truth åˆ†å¸ƒä¸é¢„æµ‹å€¼ä¹‹é—´çš„â€œè·ç¦»â€ã€‚

ç°åœ¨ï¼Œé…ç½®æ¨¡å‹æ¥ä½¿ç”¨ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°ï¼š

```python
# ç¼–è¯‘æ¨¡å‹
model.compile(optimizer='adam',
              loss='binary_crossentropy',
              metrics=['accuracy'])
```

## 5. åˆ›å»ºä¸€ä¸ªéªŒè¯é›†

åœ¨è®­ç»ƒæ—¶ï¼Œæˆ‘ä»¬æƒ³è¦æ£€æŸ¥æ¨¡å‹åœ¨æœªè§è¿‡çš„æ•°æ®ä¸Šçš„å‡†ç¡®ç‡ï¼ˆaccuracyï¼‰ã€‚é€šè¿‡ä»åŸå§‹è®­ç»ƒæ•°æ®ä¸­åˆ†ç¦» 10,000 ä¸ªæ ·æœ¬æ¥åˆ›å»ºä¸€ä¸ª*éªŒè¯é›†*ã€‚ï¼ˆä¸ºä»€ä¹ˆç°åœ¨ä¸ä½¿ç”¨æµ‹è¯•é›†ï¼Ÿæˆ‘ä»¬çš„ç›®æ ‡æ˜¯åªä½¿ç”¨è®­ç»ƒæ•°æ®æ¥å¼€å‘å’Œè°ƒæ•´æ¨¡å‹ï¼Œè®­ç»ƒå®Œæ¯•åå†ä½¿ç”¨æµ‹è¯•æ•°æ®æ¥è¯„ä¼°å‡†ç¡®ç‡ï¼ˆaccuracyï¼‰ï¼‰ã€‚

```python
# éªŒè¯é›†
x_val = train_data[:10000]
y_val = train_labels[:10000]

# è®­ç»ƒé›†
partial_x_train = train_data[10000:]
partial_y_train = train_labels[10000:]
```

## 6. è®­ç»ƒæ¨¡å‹

### â‘  å‘æ¨¡å‹é¦ˆé€æ•°æ® fit

ä»¥ 512 ä¸ªæ ·æœ¬çš„ mini-batch å¤§å°è¿­ä»£ 40 ä¸ª epoch æ¥è®­ç»ƒæ¨¡å‹ã€‚è¿™æ˜¯æŒ‡å¯¹ `x_train` å’Œ `y_train` å¼ é‡ä¸­æ‰€æœ‰æ ·æœ¬çš„çš„ 40 æ¬¡è¿­ä»£ã€‚åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œç›‘æµ‹æ¥è‡ªéªŒè¯é›†çš„ 10,000 ä¸ªæ ·æœ¬ä¸Šçš„æŸå¤±å€¼ï¼ˆlossï¼‰å’Œå‡†ç¡®ç‡ï¼ˆaccuracyï¼‰ï¼š

```python
history = model.fit(partial_x_train,
                    partial_y_train,
                    epochs=40,
                    batch_size=512,
                    validation_data=(x_val, y_val),
                    verbose=1)
```

<img src="https://gitee.com/veal98/images/raw/master/img/20201106201959.png" style="zoom:50%;" />

### â‘¡ åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°å‡†ç¡®ç‡ evaluate

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ¨¡å‹åœ¨æµ‹è¯•é›†ä¸Šçš„æ€§èƒ½å¦‚ä½•ã€‚å°†è¿”å›ä¸¤ä¸ªå€¼ï¼ŒæŸå¤±å€¼ï¼ˆlossï¼‰ï¼ˆä¸€ä¸ªè¡¨ç¤ºè¯¯å·®çš„æ•°å­—ï¼Œå€¼è¶Šä½è¶Šå¥½ï¼‰ä¸å‡†ç¡®ç‡ï¼ˆaccuracyï¼‰ã€‚

```python
test_loss, test_acc = model.evaluate(test_data, test_labels, verbose=2)
```

<img src="https://gitee.com/veal98/images/raw/master/img/20201106202848.png" style="zoom:72%;" />

è¿™ç§ååˆ†æœ´ç´ çš„æ–¹æ³•å¾—åˆ°äº†çº¦ 87% çš„å‡†ç¡®ç‡ï¼ˆaccuracyï¼‰ã€‚è‹¥é‡‡ç”¨æ›´å¥½çš„æ–¹æ³•ï¼Œæ¨¡å‹çš„å‡†ç¡®ç‡åº”å½“æ¥è¿‘ 95%ã€‚

## 7. åˆ›å»ºä¸€ä¸ªå‡†ç¡®ç‡ï¼ˆaccuracyï¼‰å’ŒæŸå¤±å€¼ï¼ˆlossï¼‰éšæ—¶é—´å˜åŒ–çš„å›¾è¡¨

`model.fit()` è¿”å›ä¸€ä¸ª `History` å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«ä¸€ä¸ªå­—å…¸ï¼Œå…¶ä¸­åŒ…å«è®­ç»ƒé˜¶æ®µæ‰€å‘ç”Ÿçš„ä¸€åˆ‡äº‹ä»¶ï¼š

```python
history_dict = history.history
history_dict.keys()

dict_keys(['loss', 'accuracy', 'val_loss', 'val_accuracy'])
```

æœ‰å››ä¸ªæ¡ç›®ï¼šåœ¨è®­ç»ƒå’ŒéªŒè¯æœŸé—´ï¼Œæ¯ä¸ªæ¡ç›®å¯¹åº”ä¸€ä¸ªç›‘æ§æŒ‡æ ‡ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™äº›æ¡ç›®æ¥ç»˜åˆ¶è®­ç»ƒä¸éªŒè¯è¿‡ç¨‹çš„æŸå¤±å€¼ï¼ˆlossï¼‰å’Œå‡†ç¡®ç‡ï¼ˆaccuracyï¼‰ï¼Œä»¥ä¾¿è¿›è¡Œæ¯”è¾ƒã€‚

```python
acc = history_dict['accuracy'] # è®­ç»ƒé›†å‡†ç¡®ç‡
val_acc = history_dict['val_accuracy'] # éªŒè¯é›†å‡†ç¡®ç‡
loss = history_dict['loss'] # è®­ç»ƒé›†æŸå¤±
val_loss = history_dict['val_loss'] # éªŒè¯é›†æŸå¤±

epochs = range(1, len(acc) + 1)

# â€œboâ€ä»£è¡¨ "è“ç‚¹"
plt.plot(epochs, loss, 'bo', label='Training loss')
# bä»£è¡¨â€œè“è‰²å®çº¿â€
plt.plot(epochs, val_loss, 'b', label='Validation loss')
plt.title('Training and validation loss')
plt.xlabel('Epochs')
plt.ylabel('Loss')
plt.legend()

plt.show()
```

<img src="https://gitee.com/veal98/images/raw/master/img/20201106203228.png" style="zoom:67%;" />

```python
plt.plot(epochs, acc, 'bo', label='Training acc')
plt.plot(epochs, val_acc, 'b', label='Validation acc')
plt.title('Training and validation accuracy')
plt.xlabel('Epochs')
plt.ylabel('Accuracy')
plt.legend()

plt.show()
```

<img src="https://gitee.com/veal98/images/raw/master/img/20201106203332.png" style="zoom:67%;" />

åœ¨è¯¥å›¾ä¸­ï¼Œç‚¹ä»£è¡¨è®­ç»ƒæŸå¤±å€¼ï¼ˆlossï¼‰ä¸å‡†ç¡®ç‡ï¼ˆaccuracyï¼‰ï¼Œå®çº¿ä»£è¡¨éªŒè¯æŸå¤±å€¼ï¼ˆlossï¼‰ä¸å‡†ç¡®ç‡ï¼ˆaccuracyï¼‰ã€‚

æ³¨æ„è®­ç»ƒæŸå¤±å€¼éšæ¯ä¸€ä¸ª epoch *ä¸‹é™*è€Œè®­ç»ƒå‡†ç¡®ç‡ï¼ˆaccuracyï¼‰éšæ¯ä¸€ä¸ª epoch *ä¸Šå‡*ã€‚è¿™åœ¨ä½¿ç”¨æ¢¯åº¦ä¸‹é™ä¼˜åŒ–æ—¶æ˜¯å¯é¢„æœŸçš„â€”â€”ç†åº”åœ¨æ¯æ¬¡è¿­ä»£ä¸­æœ€å°åŒ–æœŸæœ›å€¼ã€‚

éªŒè¯è¿‡ç¨‹çš„æŸå¤±å€¼ï¼ˆlossï¼‰ä¸å‡†ç¡®ç‡ï¼ˆaccuracyï¼‰çš„æƒ…å†µå´å¹¶éå¦‚æ­¤â€”â€”**å®ƒä»¬ä¼¼ä¹åœ¨ 20 ä¸ª epoch åè¾¾åˆ°å³°å€¼**ã€‚è¿™æ˜¯è¿‡æ‹Ÿåˆçš„ä¸€ä¸ªå®ä¾‹ï¼š<u>æ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šçš„è¡¨ç°æ¯”åœ¨ä»¥å‰ä»æœªè§è¿‡çš„æ•°æ®ä¸Šçš„è¡¨ç°è¦æ›´å¥½ã€‚åœ¨æ­¤ä¹‹åï¼Œæ¨¡å‹è¿‡åº¦ä¼˜åŒ–å¹¶å­¦ä¹ *ç‰¹å®š*äºè®­ç»ƒæ•°æ®çš„è¡¨ç¤ºï¼Œè€Œä¸èƒ½å¤Ÿ*æ³›åŒ–*åˆ°æµ‹è¯•æ•°æ®ã€‚</u>

**å¯¹äºè¿™ç§ç‰¹æ®Šæƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ 20 ä¸ªå·¦å³çš„ epoch ååœæ­¢è®­ç»ƒæ¥é¿å…è¿‡æ‹Ÿåˆ**ã€‚

## ğŸ“š References

- [TensorFlow 2 å®˜æ–¹æ–‡æ¡£](https://tensorflow.google.cn/tutorials/keras/classification?hl=zh_cn)